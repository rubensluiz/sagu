<?php
/**
 * <--- Copyright 2005-2011 de Solis - Cooperativa de Soluções Livres Ltda.
 *
 * Este arquivo é parte do programa Sagu.
 *
 * O Sagu é um software livre; você pode redistribuí-lo e/ou modificá-lo
 * dentro dos termos da Licença Pública Geral GNU como publicada pela Fundação
 * do Software Livre (FSF); na versão 2 da Licença.
 *
 * Este programa é distribuído na esperança que possa ser útil, mas SEM
 * NENHUMA GARANTIA; sem uma garantia implícita de ADEQUAÇÃO a qualquer MERCADO
 * ou APLICAÇÃO EM PARTICULAR. Veja a Licença Pública Geral GNU/GPL em
 * português para maiores detalhes.
 *
 * Você deve ter recebido uma cópia da Licença Pública Geral GNU, sob o título
 * "LICENCA.txt", junto com este programa, se não, acesse o Portal do Software
 * Público Brasileiro no endereço www.softwarepublico.gov.br ou escreva para a
 * Fundação do Software Livre (FSF) Inc., 51 Franklin St, Fifth Floor, Boston,
 * MA 02110-1301, USA --->
 *
 * Formulário de cadastro/edição/exclusão de unidade temática (FrmPai)
 *
 * @author Arthur Lehdermann [arthur@solis.coop.br]
 *
 * \b Maintainers \n
 * Arthur Lehdermann [arthur@solis.coop.br]
 *
 * @since
 * Class created on 16/07/2011
 */
class FrmUnidadeTematicaMed
{
    /**
     * Monta o formulário do passo 1
     */
    public static function CreateFieldsPasso1($data = null)
    {
        $MIOLO = MIOLO::getInstance();
        $module = SAGU::getFileModule(__FILE__);
        $function = MIOLO::_REQUEST('function');

        if ( $function == SForm::FUNCTION_UPDATE )
        {
            // Código da unidade temática
            $unidadeTematicaId = MIOLO::_REQUEST('unidadeTematicaId');
            $fields[] = new MTextLabel('unidadeTematicaIdLabel', $unidadeTematicaId, _M('Código do Rodízio', $module));
            $fields[] = new SHiddenField('unidadeTematicaId', $unidadeTematicaId);
        }

        // Campo descrição
        $data->descricao = MIOLO::_REQUEST('descricao') ? MIOLO::_REQUEST('descricao') : $data->descricao;
        $campoDescricao = new MTextField('descricao', $data->descricao, _M('Descrição', $module), SAGU::getParameter('basic', 'FIELD_DESCRIPTION_SIZE'));
        $campoDescricao->setJsHint(_M('Informe a descrição', $module));
        $fields[] = $campoDescricao;
        $validators[] = new MRequiredValidator('descricao', _M('Descrição', $module));

        // Campo período
        $periodos = MedUnidadeTematica::listPeriodos();
        $campoPeriodo = new MSelection('periodo', $data->periodo, _M('Período', $module), $periodos);
        $campoPeriodo->setJsHint(_M('Informe o período', $module));
        $fields[] = $campoPeriodo;
        $validators[] = new MRequiredValidator('periodo', _M('Período', $module));

        // Campo tipo
        $tipos = MedUnidadeTematica::listTipos();
        $campoTipo = new MSelection('tipo', $data->tipo, _M('Tipo', $module), $tipos);
        $campoTipo->setJsHint(_M('Informe o tipo', $module));
        $fields[] = $campoTipo;
        $validators[] = new MRequiredValidator('tipo', _M('Tipo', $module));

        // Campo súmula
        $campoSumula= new MMultilineField('sumula', $data->sumula, _M('Súmula', $module), SAGU::getParameter('basic', 'FIELD_DESCRIPTION_SIZE'), SAGU::getParameter('basic', 'FIELD_MULTILINE_NUM_ROWS'), SAGU::getParameter('basic', 'FIELD_MULTILINE_NUM_COLS'));
        $campoSumula->setJsHint(_M('Informe a súmula', $module));
        $fields[] = $campoSumula;
        //$validators[] = new MRequiredValidator('sumula', _M('Súmula', $module));

        /*
         * FIXME: Pra ficar bom, adicionar uma máscara que impeça letras neste campo ;-)
         */
        // Campo carga horária
        $campoCargaHoraria = new MTextField('cargaHoraria', $data->cargaHoraria, _M('Carga horária', $module), SAGU::getParameter('basic', 'FIELD_ID_SIZE'), _M('horas', $module));
        $campoCargaHoraria->setJsHint(_M('Informe a carga horária(em horas). Ex.: 140', $module));
        $fields[] = $campoCargaHoraria;
        $validators[] = new mFloatValidator('cargaHoraria', _M('Carga horária', $module), '.', null, 'required');

        /*
         * FIXME: Pra ficar bom, adicionar uma máscara que impeça letras neste campo ;-)
         */
        // Campo frequência mínima
        $campoFrequenciaMinima = new MTextField('frequenciaMinima', $data->frequenciaMinima, _M('Frequência mínima', $module), SAGU::getParameter('basic', 'FIELD_ID_SIZE'), _M('%', $module));
        $campoFrequenciaMinima->setJsHint(_M('Informe a frequência mínima(em %). Ex: 75', $module));
        $fields[] = $campoFrequenciaMinima;
        $validators[] = new mFloatValidator('frequenciaMinima', _M('Frequência mínima', $module), ',', null, 'required');

        // Campo nota máxima
        $notaMaxima = new MTextField('notaMaxima', $data->notaMaxima, _M('Nota máxima'), SAGU::getParameter('basic', 'FIELD_ID_SIZE'));
        $notaMaxima->setJsHint(_M('Informe a nota máxima.', $module));
        $fields[] = $notaMaxima;
        $validators[] = new MFloatValidator('notaMaxima');
        
        // Campo nota mínima
        $notaMinima = new MTextField('notaMinimaParaAprovacao', $data->notaMinimaParaAprovacao, _M('Nota mínima para aprovação'), SAGU::getParameter('basic', 'FIELD_ID_SIZE'));
        $notaMinima->setJsHint(_M('Informe a nota mínima para aprovação.', $module));
        $fields[] = $notaMinima;
        $validators[] = new MFloatValidator('notaMinimaParaAprovacao');

        $justificativaNota= new MMultilineField('justificativaNota', $data->justificativaNota, _M('Justificativa nota', $module), SAGU::getParameter('basic', 'FIELD_DESCRIPTION_SIZE'), SAGU::getParameter('basic', 'FIELD_MULTILINE_NUM_ROWS'), SAGU::getParameter('basic', 'FIELD_MULTILINE_NUM_COLS'));
        $justificativaNota->setJsHint(_M('Informe a Justificativa da nota', $module));
        $justificativaNota->setAttribute('placeholder', 'Digite aqui a composição da nota do rodízio');
        $fields[] = $justificativaNota;
        
        // Separador
        $fields[] = new MSeparator();
        
        // Objeto de retorno com os campos/validadores
        $return = new stdClass();
        $return->camposDoFormulario = $fields;
        $return->validadoresDoFormulario = $validators;

        return $return;
    }

    /**
     * Monta o formulário do passo 2
     */
    public static function CreateFieldsPasso2($data = null)
    {
        $MIOLO = MIOLO::getInstance();
        $module = SAGU::getFileModule(__FILE__);
        $function = MIOLO::_REQUEST('function');

        // Dados da etapa anterior
        $periodos = MedUnidadeTematica::listPeriodos();
        $tipos = MedUnidadeTematica::listTipos();
        $options = array(
            'title' => _M('Dados do Rodízio', $module),
            'columns' => 1,
            'value' => array(
                _M('Descrição') => $data->descricao,
                _M('Carga horária') => $data->cargaHoraria .'h',
                _M('Tipo') => $tipos[$data->tipo],
                _M('Período') => $periodos[$data->periodo]
            )
        );
        $fields[] = new SInformationField($options);

        // Separador
        $fields[] = new MSeparator();

        // Grid núcleos profissionais
        $filters = new stdClass();
        $grdNPUT = $MIOLO->getUI()->getGrid($module, 'GrdNucleosProfissionaisDaUnidadeTematica', $filters);
        $gridData = MedUnidadeTematica::obterNucleos($data->unidadeTematicaId);
        $grdNPUT->setData($gridData);
        // Marca os selecionados
        $selecteds = array();
        if ( $function == SForm::FUNCTION_UPDATE )
        {
            foreach ( $gridData as $k => $row )
            {
                if ( strlen($row[2]) > 0 )
                {
                    $selecteds[] = $k;
                }
            }
        }
        else
        {
            $selecteds = array_keys((array)$data->nucleosProfissionais);
        }
        $grdNPUT->selecteds = $selecteds;
        $grdNPUT->setClose(null);
        $grdNPUT->setTitle(_M('Núcleos profissionais'));
        $divNPUT = new MDiv('divNPUT', $grdNPUT);
        $divNPUT->addBoxStyle('width', '100%');
        $fields[] = new MBaseGroup('baseGroupNPUT', null, array($divNPUT));

        // Objeto de retorno com os campos/validadores
        $return = new stdClass();
        $return->camposDoFormulario = $fields;
        $return->validadoresDoFormulario = $validators;

        return $return;
    }

    /**
     * Monta o formulário do passo 3
     */
    public static function CreateFieldsPasso3($data = null)
    {
        $MIOLO = MIOLO::getInstance();
        $module = SAGU::getFileModule(__FILE__);
        $function = MIOLO::_REQUEST('function');

        // Dados da etapa anterior
        $periodos = MedUnidadeTematica::listPeriodos();
        $tipos = MedUnidadeTematica::listTipos();
        $options = array(
            'title' => _M('Dados do Rodízio', $module),
            'columns' => 1,
            'value' => array(
                _M('Descrição') => $data->descricao,
                _M('Carga horária') => $data->cargaHoraria .'h',
                _M('Tipo') => $tipos[$data->tipo],
                _M('Período') => $periodos[$data->periodo]
            )
        );
        $fields[] = new SInformationField($options);

        // Separador
        $fields[] = new MSeparator();

        // Grid ênfases
        $grdEUT = $MIOLO->getUI()->getGrid($module, 'GrdEnfasesDaUnidadeTematica', $filters);
        $gridData = MedUnidadeTematica::obterEnfases($data->unidadeTematicaId);
        $grdEUT->setData($gridData);
        // Marca os selecionados
        $selecteds = array();
        if ( $function == SForm::FUNCTION_UPDATE )
        {
            foreach ( $gridData as $k => $row )
            {
                if ( strlen($row[2]) > 0 )
                {
                    $selecteds[] = $k;
                }
            }
        }
        else
        {
            $selecteds = array_keys((array)$data->enfases);
        }
        $grdEUT->selecteds = $selecteds;
        $grdEUT->setClose(null);
        $grdEUT->setTitle(_M('Ênfases'));
        $divEUT = new MDiv('divEUT', $grdEUT);
        $divEUT->addBoxStyle('width', '100%');
        $fields[] = new MBaseGroup('baseGroupEUT', null, array($divEUT));

        // Objeto de retorno com os campos/validadores
        $return = new stdClass();
        $return->camposDoFormulario = $fields;
        $return->validadoresDoFormulario = $validators;

        return $return;
    }
    

    /**
     * Função que salva os dados
     *
     * @param type $args
     */
    public function saveButton_click($data)
    {
        $MIOLO = MIOLO::getInstance();
        $module = SAGU::getFileModule(__FILE__);
        $function = MIOLO::_REQUEST('function');

        // Obtém os dados
        $data->nucleosProfissionais = (array)$MIOLO->session->get('nucleosProfissionais');
        $data->enfases = (array)$MIOLO->session->get('enfases');
        
        try
        {      
            // Organiza os dados
            $resUnidadeTematica = new MedUnidadeTematica();
            $resUnidadeTematica->unidadeTematicaId = $data->unidadeTematicaId;
            $resUnidadeTematica->periodo = $data->periodo;
            $resUnidadeTematica->descricao = $data->descricao;
            $resUnidadeTematica->sumula = $data->sumula;
            $resUnidadeTematica->cargaHoraria = $data->cargaHoraria;
            $resUnidadeTematica->frequenciaMinima = $data->frequenciaMinima;
            $resUnidadeTematica->tipo = $data->tipo;
            $resUnidadeTematica->notaMaxima = $data->notaMaxima;
            $resUnidadeTematica->notaMinimaParaAprovacao = $data->notaMinimaParaAprovacao;
            $resUnidadeTematica->justificativaNota = $data->justificativaNota;

            // Núcleos profissionais
            $nucleosProfissionais = array();
            foreach ( (array)$data->nucleosProfissionais as $row )
            {
                $nucleoProfissional = new MedNucleoDaUnidadeTematica();
                $nucleoProfissional->nucleoProfissionalId = $row;
                $nucleosProfissionais[] = $nucleoProfissional;
            }
            $resUnidadeTematica->nucleosProfissionais = $nucleosProfissionais;

            // Ênfases
            $enfases = array();
            foreach ( (array)$data->enfases as $row )
            {
                $enfase = new MedEnfaseDaUnidadeTematica();
                $enfase->enfaseId = $row;
                $enfases[] = $enfase;
            }
            $resUnidadeTematica->enfases = $enfases;

            // Se for edição, instancia e apaga os núcleos e ênfases
            if ( strlen($data->unidadeTematicaId) > 0 )
            {
                $unidadeTematica = new MedUnidadeTematica($data->unidadeTematicaId);

                // Deleta os núcleos profissionais da unidade temática
                foreach ( (array)$unidadeTematica->nucleosProfissionais as $nucleoProfissional )
                {
                    $ok = $nucleoProfissional->delete();
                    if ( !$ok )
                    {
                        $msg = _M('Erro ao excluir os núcleos profissionais do rodízio');
                        throw new Exception($msg);
                    }
                }

                // Deleta as ênfases da unidade temática
                foreach ( (array)$unidadeTematica->enfases as $enfase )
                {
                    $ok = $enfase->delete();
                    if ( !$ok )
                    {
                        $msg = _M('Erro ao excluir as ênfases do rodízio');
                        throw new Exception($msg);
                    }
                }
            }

            // Salva os dados
            SDatabase::beginTransaction();
            $resUnidadeTematica->save();
            SDatabase::commit();

            // Mensagem de sucesso
            $msg = ($function == SForm::FUNCTION_UPDATE) ? SAGU::getParameter('BASIC', 'MSG_RECORD_UPDATED') : SAGU::getParameter('BASIC', 'MSG_RECORD_INSERTED_INFO');
            SAGU::information($msg, $MIOLO->getActionURL($module, $action, null, array('function'=>'search')));
        }
        catch ( Exception $e )
        {
            SDatabase::rollback();
            $msg = _M('Houve um problema ao inserir os dados', $module) . '<br /><br />' . $e->getMessage();
            SAGU::error($msg);
        }
    }
    
    public static function verificaNotaMaximaEMinima($data)
    {
        // Caso uma das notas seja digitada obrigatoriamente a outra deve ser digitada também
        if ( ( (strlen($data->notaMaxima) > 0) && !(strlen($data->notaMinimaParaAprovacao) > 0) ) || ( !(strlen($data->notaMaxima) > 0) && (strlen($data->notaMinimaParaAprovacao) > 0) ) )
        {
            return _M('Se uma das notas for informada (nota máxima e nota mínima para aprovação) a outra obrigatoriamente deve ser informada.');
        }
        
        // Impede a inserção de uma nota mínima maior que a nota máxima
        if ( (strlen($data->notaMaxima) > 0 && strlen($data->notaMinimaParaAprovacao) > 0) && ($data->notaMinimaParaAprovacao > $data->notaMaxima) )
        {
            return _M('A nota mínima para aprovação não pode ser maior que a nota máxima informada.');
        }
        
        return null;
    }
}
?>