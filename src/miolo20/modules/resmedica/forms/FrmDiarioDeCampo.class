<?php

/**
 * <--- Copyright 2005-2011 de Solis - Cooperativa de Soluções Livres Ltda.
 *
 * Este arquivo é parte do programa Sagu.
 *
 * O Sagu é um software livre; você pode redistribuí-lo e/ou modificá-lo
 * dentro dos termos da Licença Pública Geral GNU como publicada pela Fundação
 * do Software Livre (FSF); na versão 2 da Licença.
 *
 * Este programa é distribuído na esperança que possa ser útil, mas SEM
 * NENHUMA GARANTIA; sem uma garantia implícita de ADEQUAÇÃO a qualquer MERCADO
 * ou APLICAÇÃO EM PARTICULAR. Veja a Licença Pública Geral GNU/GPL em
 * português para maiores detalhes.
 *
 * Você deve ter recebido uma cópia da Licença Pública Geral GNU, sob o título
 * "LICENCA.txt", junto com este programa, se não, acesse o Portal do Software
 * Público Brasileiro no endereço www.softwarepublico.gov.br ou escreva para a
 * Fundação do Software Livre (FSF) Inc., 51 Franklin St, Fifth Floor, Boston,
 * MA 02110-1301, USA --->
 *
 * @author Moises Heberle [moises@solis.com.br]
 *
 * \b Maintainers: \n
 * Fabiano Tomasini [fabiano@solis.coop.br]
 * Moises Heberle [moises@solis.com.br]
 *
 * @since
 * Class created on 22/01/2015
 *
 * */
class FrmDiarioDeCampo extends SForm
{

    public function __construct()
    {
        $module = MIOLO::getCurrentModule();

        parent::__construct(_M('Diário de campo', $module));

        $this->disableToolbar();
    }

    public function defineFields()
    {
        $MIOLO = MIOLO::getInstance();
        $module = MIOLO::getCurrentModule();

        $personData = SAGU::getUsuarioLogado();
        $unidadesTematicas = MedOfertaDeUnidadeTematica::obterOfertasDaPessoa($personData->personId);
        $ofertaDeUnidadeTematicaId = $this->getRequestValue('ofertadeunidadetematicaid');

        if ( strlen($ofertaDeUnidadeTematicaId) == 0 )
        {
            $ofertaDeUnidadeTematicaId = current(array_keys($unidadesTematicas));
        }

        $fields[] = $sel = new MSelection('ofertadeunidadetematicaid', $ofertaDeUnidadeTematicaId, _M('Rodizio'), $unidadesTematicas);
        $sel->options = $unidadesTematicas;
        $sel->addAttribute('onchange', SForm::getAjaxAction('mudarUT', 'divUT', false));

        $fields[] = new MSeparator();

        if ( $ofertaDeUnidadeTematicaId )
        {
            $args = new stdClass();
            $args->ofertadeunidadetematicaid = $ofertaDeUnidadeTematicaId;

            $fields[] = new MDiv('divUT', $this->mudarUT($args));
        }
        else
        {
            $fields[] = new MLabel(_M('Ops! Você não está matriculado em nenhuma oferta!'));
        }

        // Volta para a portal
        $goto = $MIOLO->getActionURL($module, 'main:resmedica', null);
        $fields[] = new MButton('button_back', _M('Voltar a tela inicial', $module), $goto);

        parent::defineFields(array( 'fields' => $fields, 'validators' => $validators ));
    }

    public function mudarUT($args)
    {
        $MIOLO = MIOLO::getInstance();
        $module = SAGU::getFileModule(__FILE__);

        $ofertadeunidadetematicaid = $args->ofertadeunidadetematicaid;

        $fields[] = new MedOfertaDeUnidadeTematicaInformation(array(
            'ofertaDeUnidadeTematicaId' => $ofertadeunidadetematicaid,
            'columns' => 1,
            'textWidth' => '500px'
        ));

        $oferta = new MedOfertaDeUnidadeTematica($ofertadeunidadetematicaid);

        // busca oferta
        $filters = new stdClass();
        $filters->personId = SAGU::getUsuarioLogado()->personId;
        $filters->ofertaDeUnidadeTematicaId = $ofertadeunidadetematicaid;
        $ofertas = MedOfertaDoResidente::search($filters);
        $residenteid = $ofertas[0]->residenteId;

        // botoes
        $hct = array();

        $opts = array( 'event' => 'btnPrint', 'ofertadeunidadetematicaid' => $ofertadeunidadetematicaid, 'residenteid' => $residenteid );
        $url = $MIOLO->getActionURL(MIOLO::getCurrentModule(), MIOLO::getCurrentAction(), null, $opts);
        $hct[] = new MButton('btnPrint', _M('Imprimir diário de campo'), $url);
        
        if ( strlen($oferta->encerramento) == 0 )
        {
            $opts = array( 'event' => 'btnManage', 'ofertadeunidadetematicaid' => $ofertadeunidadetematicaid );
            $url = $MIOLO->getActionURL('services', MIOLO::getCurrentAction(), null, $opts);
            $hct[] = new MButton('btnManage', _M('Novo encontro'), $url);
        }

        $fields[] = new MHContainer('hctBtns', $hct, MControl::FORM_MODE_SHOW_SIDE);

        // outros
        $fields[] = new MSeparator('<br/>');

        $diario = new MedDiarioDeCampo();

        if ( strlen($residenteid) > 0 )
        {
            // dados da grid
            $sql = $diario->msql();
            $sql->addEqualCondition('MedDiarioDeCampo.ofertadeunidadetematicaid', $ofertadeunidadetematicaid);
            $sql->addEqualCondition('MedDiarioDeCampo.residenteid', $residenteid);
            $dados = $diario->findManyAsArray($sql);

            // grid
            $grid = $MIOLO->getUI()->getGrid($module, 'GrdDiarioDeCampo');
            $grid->setData($dados);

            $divGrid = new MDiv('divGrd', $grid);
            $divGrid->addBoxStyle('width', '100%');
            $fields[] = $divGrid;

            $chTotal = MedDiarioDeCampo::obterCHTotal($residenteid, $ofertadeunidadetematicaid);

            $fields[] = new MSeparator('<br/>');
            $fields[] = new MTextLabel('lblCH', _M('Total de carga horária: ' . $chTotal . 'h'));
            $fields[] = new MSeparator('<br/>');
        }
        else
        {
            $fields[] = new MTextLabel('lblCH', _M('Residente não possui ofertas'));
        }

        return $fields;
    }

    public function btnManage($args)
    {
        $MIOLO = MIOLO::getInstance();
        $module = SAGU::getFileModule(__FILE__);

        $ofertadeunidadetematicaid = $this->getFormValue('ofertadeunidadetematicaid');

        if ( strlen($ofertadeunidadetematicaid) == 0 )
        {
            $this->AddError(_M('Oferta de unidade temática não informada', $module) . '.');
        }

        $oferta = new MedOfertaDeUnidadeTematica($ofertadeunidadetematicaid);
        $tipos = MedUnidadeTematica::listTipos();
        $periodos = MedUnidadeTematica::listPeriodos();

        //Hidden fields
        $fields[] = new SHiddenField('ofertadeunidadetematicaid', $ofertadeunidadetematicaid);
        $fields[] = new SHiddenField('diariodecampoid', $this->getFormValue('diariodecampoid'));

        //Informações da unidade temática
        $options = array(
            'title' => _M('Dados da oferta do rodízio', $module),
            'columns' => 1,
            'textWidth' => '500px',
            'value' => array(
                _M('Descrição') => $oferta->ofertadeunidadetematicaid . ' - ' . $oferta->unidadeTematica->descricao,
                _M('CH lançada/prevista') => $oferta->cargahorariaCursada,
                _M('Frequência mínima') => $oferta->unidadeTematica->frequenciaMinima . '%',
                _M('Tipo') => $tipos[$oferta->unidadeTematica->tipo],
                _M('Período') => $periodos[$oferta->unidadeTematica->periodo],
                _M('Início') => $oferta->inicio,
                _M('Fim') => $oferta->fim )
        );
        $fields[] = new SInformationField($options);
        $fields[] = new MSeparator();

        // carrega objeto diario de campo se for edicao de registro
        if ( MIOLO::_REQUEST('function') == SForm::FUNCTION_UPDATE )
        {
            $diario = new MedDiarioDeCampo(MIOLO::_REQUEST('diariodecampoid'));
        }

        // campos
        //Data e hora do encontro caso tenha quebra timestamp em data e hora
        list($diario->inicioData, $diario->inicioHora) = explode(' ', $diario->inicio);
        list($diario->fimData, $diario->fimHora) = explode(' ', $diario->fim);

        //Valores para data e hora(caso edição peaga data e hora registrada, caso inserção data e hora atual)
        $dateValue = new stdClass();
        $dateValue->inicioData = strlen($this->getFormValue('inicioData', $diario->inicioData)) > 0 ? $this->getFormValue('inicioData', $diario->inicioData) : SAGU::getDateNow();
        $dateValue->fimData = strlen($this->getFormValue('fimData', $diario->fimData)) > 0 ? $this->getFormValue('fimData', $diario->fimData) : SAGU::getDateNow();
        $dateValue->inicioHora = strlen($this->getFormValue('inicioHora', $diario->inicioHora)) > 0 ? $this->getFormValue('inicioHora', $diario->inicioHora) : SAGU::getDateNow(SAGU::getParameter('BASIC', 'MASK_TIME_PHP_DEFAULT'));
        $dateValue->fimHora = strlen($this->getFormValue('fimHora', $diario->fimHora)) > 0 ? $this->getFormValue('fimHora', $diario->fimHora) : SAGU::getDateNow(SAGU::getParameter('BASIC', 'MASK_TIME_PHP_DEFAULT'));
        $fields[] = $obj = new SBeginEndPeriod(array(
            'data' => $dateValue,
            'required' => true,
            'baseGroup' => false,
            'type' => 'timestamp',
            'begin' => array(
                'dateId' => 'inicioData',
                'timeId' => 'inicioHora',
                'label' => _M('Início', $module),
                'dateHint' => _M('Informe a data de início', $module),
                'timeHint' => _M('Informe a hora de início. Formato: hh:mm', $module)
            ),
            'end' => array(
                'dateId' => 'fimData',
                'timeId' => 'fimHora',
                'label' => _M('Fim', $module),
                'dateHint' => _M('Informe a data de fim', $module),
                'timeHint' => _M('Informe a hora de fim. Formato: hh:mm', $module)
            )
        ));

        //Evento quando tiver alguma alteração no período(calcula a carga horária)
        $obj->getField('inicioData')->addAttribute('onchange', $this->getAjaxAction('timestampDiff', 'divNull', false));
        $obj->getField('inicioHora')->addAttribute('onchange', $this->getAjaxAction('timestampDiff', 'divNull', false));
        $obj->getField('fimData')->addAttribute('onchange', $this->getAjaxAction('timestampDiff', 'divNull', false));
        $obj->getField('fimHora')->addAttribute('onchange', $this->getAjaxAction('timestampDiff', 'divNull', false));

        $fields[] = new MDiv('divNull', null);
        // Campo carga horária
        if ( strlen($this->getFormValue('cargahoraria', $diario->cargahoraria)) == 0 )
        {
            $this->page->onLoad($this->getAjaxAction('timestampDiff', 'divNull', false));
        }

        $campoCargaHoraria = new MTextField('cargahoraria', $this->getFormValue('cargahoraria', $diario->cargahoraria), _M('Carga horária', $module), SAGU::getParameter('basic', 'FIELD_ID_SIZE'), _M('horas', $module));
        $campoCargaHoraria->setJsHint(_M('Informe a carga horária(em horas). Ex.: 140', $module));
        $fields[] = $campoCargaHoraria;
        // Campo conteúdo abordado
        $fields[] = $conteudoabordado = new MMultilineField('conteudoabordado', $this->getFormValue('conteudoabordado', $diario->conteudoabordado), _M('Conteúdo abordado', $module), SAGU::getParameter('basic', 'FIELD_DESCRIPTION_SIZE'), SAGU::getParameter('basic', 'FIELD_MULTILINE_NUM_ROWS'), SAGU::getParameter('basic', 'FIELD_MULTILINE_NUM_COLS'));
        $conteudoabordado->setJsHint(_M('Informe o conteúdo abordado', $module));
        // Ministrante
        $ministranteValue = strlen($this->getFormValue('ministrante', $diario->ministrante)) > 0 ? $this->getFormValue('ministrante', $diario->ministrante) : $oferta->preceptor->name;
        $fields[] = $ministrante = new MTextField('ministrante', $ministranteValue, _M('Ministrante', $module), SAGU::getParameter('basic', 'FIELD_DESCRIPTION_SIZE'));
        $ministrante->addAttribute('maxlength', '255');
        $ministrante->setJsHint(_M('Informe o ministrante', $module));

        // botoes
        $fields[] = new MSeparator();

        $hct = array();

        $url = $MIOLO->GetActionURL('services', 'main:resmedica:diarioDeCampo', null, array( 'ofertadeunidadetematicaid' => $ofertadeunidadetematicaid ));
        $hct[] = new MButton('tbBtnBack', _M('Voltar'), $url);

        $hct[] = new MButton('tbBtnSave', _M('Salvar'));

        $fields[] = $hct = new MHContainer('hctBtns', $hct, MControl::FORM_MODE_WHOLE_ROW);
        $fields[] = new MSeparator();

        //Validadores
        $validators[] = new MDATEDMYValidator('inicioData', _M('Início', $module), 'required');
        $validators[] = new MTIMEValidator('inicioHora', _M('Hora fim', $module), 'required');
        $validators[] = new MDATEDMYValidator('fimData', _M('Fim', $module), 'required');
        $validators[] = new MTIMEValidator('fimHora', _M('Hora fim', $module), 'required');
        $validators[] = new MFloatValidator('cargahoraria', _M('Carga horária', $module), '.', null, 'required');
        $validators[] = new MRequiredValidator('ministrante');

        $this->setFields($fields);
        $this->SetValidators($validators);
    }

    /**
     * Obtém a diferença em horas de um timestemp e outro
     */
    public function timestampDiff($args)
    {
        $inicioData = $this->getFormValue('inicioData', $args->inicioData);
        $inicioHora = $this->getFormValue('inicioHora', $args->inicioHora);
        $fimData = $this->getFormValue('fimData', $args->fimData);
        $fimHora = $this->getFormValue('fimHora', $args->fimHora);

        if ( strlen($inicioData) > 0 && strlen($inicioHora) > 0 && strlen($fimData) > 0 && strlen($fimHora) > 0 )
        {
            $hours = MedEncontro::timestampDiff($inicioData . ' ' . $inicioHora, $fimData . ' ' . $fimHora);
            $this->page->addAJAXJsCode("xGetElementById('cargahoraria').value = {$hours};");
        }

        return null;
    }

    public function tbBtnDelete_click($args)
    {
        $MIOLO = MIOLO::getInstance();
        $module = SAGU::getFileModule(__FILE__);
        $action = MIOLO::getCurrentAction();

        $diariodecampoid = MIOLO::_REQUEST('diariodecampoid');
        $ofertadeunidadetematicaid = MIOLO::_REQUEST('ofertadeunidadetematicaid');

        $gotoYes = $MIOLO->getActionURL('services', 'main:resmedica:diarioDeCampo', null, array( 'event' => 'btnDelete_confirm', 'diariodecampoid' => $diariodecampoid, 'ofertadeunidadetematicaid' => $ofertadeunidadetematicaid ));
        $gotoNo = $MIOLO->getActionURL('services', 'main:resmedica:diarioDeCampo', null, array( 'ofertadeunidadetematicaid' => $ofertadeunidadetematicaid ));
        $MIOLO->question(SAGU::getParameter('BASIC', 'MSG_CONFIRM_RECORD_DELETE'), $gotoYes, $gotoNo);
    }

    public function btnDelete_confirm($args)
    {
        $MIOLO = MIOLO::getInstance();

        $diariodecampoid = MIOLO::_REQUEST('diariodecampoid');
        $ofertadeunidadetematicaid = MIOLO::_REQUEST('ofertadeunidadetematicaid');

        try
        {
            SDatabase::beginTransaction();

            $diario = new MedDiarioDeCampo($diariodecampoid);
            $diario->delete();

            SDatabase::commit();

            $goto = $MIOLO->getActionURL('services', 'main:resmedica:diarioDeCampo', null, array( 'ofertadeunidadetematicaid' => $ofertadeunidadetematicaid ));
            $MIOLO->information(SAGU::getParameter('BASIC', 'MSG_RECORD_DELETED'), $goto);
        }
        catch ( Exception $e )
        {
            SDatabase::rollback();
            $this->AddError($e->getMessage());
        }
    }

    public function tbBtnSave_click($sender = NULL)
    {
        $MIOLO = MIOLO::getInstance();
        $module = SAGU::getFileModule(__FILE__);

        $data = $this->getTypesData();

        try
        {
            SDatabase::beginTransaction();

            //Verifica carga horaria
             if(MIOLO::_REQUEST('cargahoraria') < 0)
             {
                 throw new Exception(_M("Carga horaria inválida, informe uma carga horária maior ou igual a zero"));
             }
            // Verificar se o encontro nao está sendo cadastro fora da oferta da unidade
            $oferta = new MedOfertaDeUnidadeTematica($data->ofertadeunidadetematicaid);

            if ( SAGU::dateDiff($oferta->getInicio(), $data->inicioData) > 0 )
            {
                throw new Exception(_M("Você está tentando cadastrar um encontro fora do período da oferta de unidade temática."));
            }

            if ( SAGU::dateDiff($oferta->getFim(), $data->fimData) < 0 )
            {
                throw new Exception(_M("Você está tentando cadastrar um encontro fora do período da oferta de unidade temática."));
            }

            if ( SAGU::dateDiff($data->inicioData, $data->fimData) > 0 )
            {
                throw new Exception(_M("A data de início não pode ser maior que a de fim"));
            }

            // busca oferta
            $filters = new stdClass();
            $filters->personId = SAGU::getUsuarioLogado()->personId;
            $filters->ofertaDeUnidadeTematicaId = $data->ofertadeunidadetematicaid;
            $ofertas = MedOfertaDoResidente::search($filters);

            // insere o diario
            if ( strlen($data->diariodecampoid) > 0 )
            {
                $diario = new MedDiarioDeCampo($data->diariodecampoid);
            }
            else
            {
                $diario = new MedDiarioDeCampo();
            }

            $diario->diariodecampoid = $data->diariodecampoid;
            $diario->inicio = $data->inicioData . " " . $data->inicioHora;
            $diario->fim = $data->fimData . " " . $data->fimHora;
            $diario->cargahoraria = $data->cargahoraria;
            $diario->conteudoabordado = $data->conteudoabordado;
            $diario->ministrante = $data->ministrante;
            $diario->ofertadeunidadetematicaid = $data->ofertadeunidadetematicaid;
            $diario->residenteid = $ofertas[0]->residenteId;

            $ok = $diario->save();

            SDatabase::commit();

            if ( $ok )
            {
                $goto = $MIOLO->getActionURL('services', 'main:resmedica:diarioDeCampo', null, array( 'ofertadeunidadetematicaid' => $data->ofertadeunidadetematicaid ));

                if ( strlen($data->diariodecampoid) > 0 )
                {
                    SAGU::information(_M('Encontro atualizado com sucesso'), $goto);
                }
                else
                {
                    SAGU::information(_M('Encontro inserido com sucesso'), $goto);
                }
            }
        }
        catch ( Exception $e )
        {
            SDatabase::rollback();
            $this->AddError($e->getMessage());
        }
    }

    public function getTypesData()
    {
        $data = new stdClass();
        $data->ofertadeunidadetematicaid = $this->getFormValue('ofertadeunidadetematicaid', MIOLO::_request('ofertadeunidadetematicaid'));
        $data->diariodecampoid = $this->getFormValue('diariodecampoid', MIOLO::_request('diariodecampoid'));
        $data->inicioData = $this->getFormValue('inicioData', MIOLO::_request('inicioData'));
        $data->inicioHora = $this->getFormValue('inicioHora', MIOLO::_request('inicioHora'));
        $data->fimData = $this->getFormValue('fimData', MIOLO::_request('fimData'));
        $data->fimHora = $this->getFormValue('fimHora', MIOLO::_request('fimHora'));
        $data->cargahoraria = $this->getFormValue('cargahoraria', MIOLO::_request('cargahoraria'));
        $data->conteudoabordado = $this->getFormValue('conteudoabordado', MIOLO::_request('conteudoabordado'));
        $data->ministrante = $this->getFormValue('ministrante', MIOLO::_request('ministrante'));

        return $data;
    }

    public function btnPrint($args)
    {
        $MIOLO = MIOLO::getInstance();
        $module = SAGU::getFileModule(__FILE__);

        $residenteid = MIOLO::_REQUEST('residenteid');
        $ofertadeunidadetematicaid = MIOLO::_REQUEST('ofertadeunidadetematicaid');

        $parameters = array();
        $parameters['residenteid'] = $residenteid;
        $parameters['ofertadeunidadetematicaid'] = $ofertadeunidadetematicaid;

        $report = new SReport(array(
            'module' => 'resmedica',
            'reportName' => 'diarioDeCampo',
            'parameters' => $parameters
        ));

        if ( !$report->generate() )
        {
            $this->addError(_M('Não foi possível gerar o documento.', $module));
        }
    }

}

?>