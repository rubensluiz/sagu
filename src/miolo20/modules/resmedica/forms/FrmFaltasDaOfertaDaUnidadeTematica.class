<?php

/**
 * <--- Copyright 2005-2011 de Solis - Cooperativa de Soluções Livres Ltda.
 *
 * Este arquivo é parte do programa Sagu.
 *
 * O Sagu é um software livre; você pode redistribuí-lo e/ou modificá-lo
 * dentro dos termos da Licença Pública Geral GNU como publicada pela Fundação
 * do Software Livre (FSF); na versão 2 da Licença.
 *
 * Este programa é distribuído na esperança que possa ser útil, mas SEM
 * NENHUMA GARANTIA; sem uma garantia implícita de ADEQUAÇÃO a qualquer MERCADO
 * ou APLICAÇÃO EM PARTICULAR. Veja a Licença Pública Geral GNU/GPL em
 * português para maiores detalhes.
 *
 * Você deve ter recebido uma cópia da Licença Pública Geral GNU, sob o título
 * "LICENCA.txt", junto com este programa, se não, acesse o Portal do Software
 * Público Brasileiro no endereço www.softwarepublico.gov.br ou escreva para a
 * Fundação do Software Livre (FSF) Inc., 51 Franklin St, Fifth Floor, Boston,
 * MA 02110-1301, USA --->
 *
 * @author Nataniel I. da Silva [nataniel@solis.coop.br]
 *
 * @since
 * Class created on 06/01/2015
 */

class FrmFaltasDaOfertaDaUnidadeTematica extends SForm
{
    public function __construct()
    {
        parent::__construct(_M('Registro de faltas'));
        
        $this->toolbar->disableButton(MToolBar::BUTTON_DELETE);
        $this->toolbar->disableButton(MToolBar::BUTTON_NEW);
        $this->toolbar->disableButton(MToolBar::BUTTON_SEARCH);
        $this->toolbar->disableButton(MToolBar::BUTTON_PRINT);
        $this->toolbar->disableButton(MToolBar::BUTTON_SAVE);
    }
    
    public function defineFields($options = array())
    {
        $MIOLO = MIOLO::getInstance();
        $module = MIOLO::getCurrentModule();
        $ofertaDeUnidadeTematicaId = MIOLO::_REQUEST('ofertaDeUnidadeTematicaId');
        
        $fields[] = MMessage::getStaticMessage($name, 'Importante! Lembre-se de salvar após concluir a digitação de faltas.', MMessage::TYPE_WARNING);
        
        $busFile = new BusinessBasicBusFile();
        
        //Oferta de unidade tematica
        $ofertaDeUnidadeTematica = new MedOfertaDeUnidadeTematica($ofertaDeUnidadeTematicaId);
        //Lista de períodos de unidade temática
        $listPeriodoDaUnidadeTematica = MedUnidadeTematica::listPeriodos();
        
        //Informações da unidade temática
        $options = array(
            'title' => _M('Informações do rodízio ofertado'),
            'columns' => 1,
            'value' => array(
                _M('Descrição') => $ofertaDeUnidadeTematica->ofertaDeUnidadeTematicaId . ' - ' . $ofertaDeUnidadeTematica->unidadeTematica->descricao,
                _M('Frequência mínima') => $ofertaDeUnidadeTematica->unidadeTematica->frequenciaMinima . '%',
                _M('Carga horaria') => $ofertaDeUnidadeTematica->unidadeTematica->cargaHoraria,
                _M('Período') => $listPeriodoDaUnidadeTematica[$ofertaDeUnidadeTematica->unidadeTematica->periodo],
                _M('Início') => $ofertaDeUnidadeTematica->inicio,
                _M('Fim') => $ofertaDeUnidadeTematica->fim )
        );
        $fields[] = new SInformationField($options, 350);
        
        $residentes = MedOfertaDeUnidadeTematica::obtemAlunosDaOfertaDeUnidadeTematica($ofertaDeUnidadeTematicaId);
        
        $columns[] = _M('Foto', $module);
        $columns[] = _M('Residente', $module);
        $columns[] = _M('Status na oferta do rodizio', $module);
        $columns[] = _M('Faltas (Horas)', $module);
        $columns[] = _M('Observação', $module);
                
        foreach ( $residentes as $key => $residente )
        {            
            //Contador colunas da tabela
            $coluna = 0;

            unset($personFile);

            if ( strlen($residente->photoId) > 0 )
            {
                $path = $busFile->getUrl($residente->photoId, array( 'permission' => true ));
                $personFile = new MImage('personFile_' . $residente->photoId, NULL, $path, 'width="' . (int) SAGU::getParameter('BASIC', 'PHOTO_WIDTH') . '" height="' . (int) SAGU::getParameter('BASIC', 'PHOTO_HEIGHT') . '"');
                $personFile->addBoxStyle('text-align', 'center');
            }
            //Status do residente na oferta
            $listStatus = MedOcorrenciaDeOferta::listStatus();
            $statusResidenteOferta = new MTextLabel('labelStatus_' . $key, $listStatus[$residente->ocorrenciaStatus]);
            $divStatusResidente = new MDiv('divStatusResidente', $statusResidenteOferta);
            $divStatusResidente->addBoxStyle('text-align', 'center');

            //Imagem da pessoa
            $dataTable[$key][$coluna] = $personFile;
            $coluna++;
            
            // Nome da pessoa
            $dataTable[$key][$coluna] = $residente->name;
            $coluna++;

            //Status na oferta de unidade temática
            $dataTable[$key][$coluna] = $divStatusResidente;
            $coluna++;


            $falta = MedOfertaDoResidente::obtemFaltaDoResidenteNaOfertaDeUnidadeTematica($residente->residenteId, $ofertaDeUnidadeTematica->ofertaDeUnidadeTematicaId);

            $faltaResidente = new MTextField('falta_' . $residente->residenteId, $falta['falta'], '', SAGU::getParameter('BASIC', 'FIELD_ID_SIZE'));
            $faltaResidente->_addStyle('text-align', 'center');
            $faltaResidente->setAttribute('onchange', "javascript:verificaFalta('falta_$residente->residenteId')");
            $divFaltaResidente = new MDiv('divFaltaResidente', $faltaResidente);
            $divFaltaResidente->addBoxStyle('text-align', 'center');
            $dataTable[$key][$coluna] = $divFaltaResidente->generate();
            $coluna++;

            $observacao = new MMultilineField('observacao_' . $residente->residenteId, $falta['observacao'], _M('Observação', $module), SAGU::getParameter('basic', 'FIELD_DESCRIPTION_SIZE'), SAGU::getParameter('basic', 'FIELD_MULTILINE_NUM_ROWS'), SAGU::getParameter('basic', 'FIELD_MULTILINE_NUM_COLS'));
            $dataTable[$key][$coluna] = $observacao;

        }
                
        $table = new MTableRaw(null, $dataTable, $columns);
        $fields[] = $tableEncontrosDiv = new MDiv('tableNotasDiv', $table, null, 'width=100%');
        
        $href = $this->getPreviousURL();
        
        $btns[] = new MButton('button_back', _M('<< Voltar', $module), $href);
        
        if ( count($residentes) > 0 )
        {
            $btns[] = new MButton('button_save', _M('Salvar', $module));
        }
        
        $fields[] = new MSeparator();
        
        $fields[] = new MDiv('divButtons', $btns, '', 'style="margin-left:41%"');
        
        $jsCode = " function verificaFalta(faltaResidente) 
                    {
                        var falta = document.getElementById(faltaResidente); 
                                
                        // Verifica se é um número 
                        if ( isNaN(falta.value*1) )
                        {
                            document.getElementById(faltaResidente).value = '';
                            return;
                        }
                        
                        // Verifica se a nota informada é maior que a nota máxima configurada na unidade temática
                        if ( falta.value > {$ofertaDeUnidadeTematica->unidadeTematica->cargaHoraria} )
                        {
                            alert('A falta informada não pode ser superior a carga horaria configurada para o rodízio');
                            falta.value = '';
                            falta.focus();
                        }

                    } ";
        
        $this->AddJsCode($jsCode);
        
        parent::defineFields(array('fields' => $fields));
    }
    
    /**
     * Registra a nota para cada residente
     * 
     * @throws Exception
     */
    public function button_save_click()
    {
        $MIOLO = MIOLO::getInstance();
        
        $ofertaDeUnidadeTematicaId = MIOLO::_REQUEST('ofertaDeUnidadeTematicaId');
        
        try
        {
            SDatabase::beginTransaction();
            
            $residentes = MedOfertaDeUnidadeTematica::obtemAlunosDaOfertaDeUnidadeTematica($ofertaDeUnidadeTematicaId);
            
            foreach ( $residentes as $key => $residente )
            {
                $ok = false;
                $falta= null;
                $campoFalta = 'falta_' . $residente->residenteId;
                $falta = $_REQUEST[$campoFalta];

                $campoObservacao = 'observacao_' . $residente->residenteId;
                $observacao = $_REQUEST[$campoObservacao];

                $data = new stdClass();
                $data->residenteId = $residente->residenteId;
                $data->ofertaDeUnidadeTematicaId = $ofertaDeUnidadeTematicaId;
                $data->falta = $falta;
                $data->observacao = $observacao;

                $ok = MedOfertaDoResidente::salvaFaltaDoResidente($data);
                    
                if ( !$ok )
                {
                    throw new Exception(_M("Não foi possível salvar a falta do residente {$residente->residenteId} - $residente->name."));
                }
            }
        
            SDatabase::commit();
            
            $this->AddInfo(_M('Faltas salvas com sucesso.'));
            
            // Chamado o define fields para carregar e exibir as notas salvas
            $this->defineFields();
        }
        catch ( Exception $e )
        {
            SDatabase::rollback();
            
            $this->Error($e->getMessage());
        }
    }


}