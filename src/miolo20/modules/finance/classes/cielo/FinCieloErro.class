<?php

class FinCieloErro
{
    
    // Verifica em Resposta XML a ocorrência de erros 
    // Parâmetros: XML de envio, XML de Resposta
    public static function verificaErro($vmPost, $vmResposta)
    {
        $error_msg = NULL;
        
        $errors = array(
            '001' => 'XML enviado ao serviço Cielo é inválido',
            '002' => 'Credenciais inválidas',
            '003' => 'Transação inexistente',
            '010' => 'Inconsistência no envio do cartão',
            '011' => 'Modalidade não habilitada',
            '012' => 'Número de parcelas inválido',
            '013' => 'Flag de autorização automática inválida',
            '014' => 'Autorização Direta inválida',
            '015' => 'Autorização Direta sem Cartão',
            '016' => 'Identificador, TID, inválido',
            '017' => 'Código de segurança ausente',
            '018' => 'Indicador de código de segurança inconsistente',
            '020' => 'Status não permite autorização',
            '021' => 'Prazo de autorização vencido',
            '025' => 'Encaminhamento a autorização não permitido',
            '030' => 'Status inválido para captura',
            '031' => 'Prazo de captura vencido',
            '032' => 'Valor de captura inválido',
            '033' => 'Falha ao capturar',
            '040' => 'Prazo de cancelamento vencido',
            '041' => 'Status não permite cancelamento',
            '042' => 'Falha ao cancelar',
            '099' => 'Erro inesperado'
        );

        try 
        {
            if ( stripos($vmResposta, "SSL certificate problem") !== false )
            {
                throw new Exception("CERTIFICADO INVÁLIDO - O certificado da transação não foi aprovado", "099");
            }

            $objResposta = simplexml_load_string($vmResposta, null, LIBXML_NOERROR);
            if ( $objResposta == null )
            {
                throw new Exception("HTTP READ TIMEOUT - o Limite de Tempo da transação foi estourado", "099");
            }
        }
        catch (Exception $ex)
        {
            $error_msg .= $ex->getMessage();

            return $error_msg;
        }

        if ( $objResposta->getName() == "erro" )
        {
            $error_msg = $errors[(string)$objResposta->codigo];            
        }
        
        if ( $error_msg == NULL )
        {
            $error_msg = 'Transação não autorizada';
        }
        
        return $error_msg;
    }
    
}

?>
