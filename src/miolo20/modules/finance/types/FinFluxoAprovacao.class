<?php

/*
 * To change this template, choose Tools | Templates
 * and open the template in the editor.
 */

/**
 * Description of AdmFluxoAprovacao
 *
 * @author augusto
 */
class FinFluxoAprovacao extends SType
{
    protected $gravarMaiusculo = false;

    /**
     *
     * @var int 
     */
    public $fluxoAprovacaoId;
    
    /**
     *
     * @var int 
     */
    public $fluxoSolicitacaoId;
    
    /**
     *
     * @var int
     */
    public $fluxoAprovacaoNivelId;
    
    /**
     *
     * @var int
     */
    public $fluxoAprovacaoStatusId;
    
    /**
     *
     * @var int 
     */
    public $idUser;
    
    /**
     *
     * @var String
     */
    public $observacao;
    
    /**
     *
     * @var FinFluxoSolicitacao
     */
    public $fluxoSolicitacao;
    
    /**
     *
     * @var FinFluxoAprovacaoConfiguracao
     */
    public $fluxoAprovacaoNivel;
    
    /**
     *
     * @var FinFluxoAprovacaoStatus
     */
    public $fluxoAprovacaoStatus;
    
    /**
     *
     * @var AdmUser
     */
    public $miolo_user;
    
    /**
     * Associações
     * 
     * @var array
     */
    protected $_associations = array(
        'fluxoSolicitacao' => array(
            'mode' => 'one',
            'typeClass' => 'FinFluxoSolicitacao',
            'joinColumn' => 'fluxoSolicitacaoId',
        ),
        'fluxoAprovacaoNivel' => array(
            'mode' => 'one',
            'typeClass' => 'FinFluxoAprovacaoNivel',
            'joinColumn' => 'fluxoAprovacaoNivelId',
        ),
        'fluxoAprovacaoStatus' => array(
            'mode' => 'one',
            'typeClass' => 'FinFluxoAprovacaoStatus',
            'joinColumn' => 'fluxoAprovacaoStatusId',
        ),
        'miolo_user' => array(
            'mode' => 'one',
            'typeClass' => 'AdmUser',
            'joinColumn' => 'idUser',
        )
    );
    
    /**
     * Obtém os fluxos de aprovação referente ao código do nivel.
     * 
     * @param int $fluxoAprovacaoNivelId
     * @return array
     */
    public function obterFluxoDeAprovacaoPeloCodigoDoNivelESolicitacao($fluxoAprovacaoNivelId, $fluxoSolicitacaoId, $returnAsObject = false)
    {
        $select = $this->msql()
                       ->setColumns('fluxoaprovacaoid, fluxosolicitacaoid, fluxoaprovacaonivelid, fluxoaprovacaostatusid, iduser, observacao')
                       ->setTables('finfluxoaprovacao')
                       ->setWhereAnd('fluxoaprovacaonivelid = ?')
                       ->setWhereAnd('fluxosolicitacaoid = ?')
                       ->select();
        
        $cols = array(
            'fluxoaprovacaoid',
            'fluxosolicitacaoid',
            'fluxoaprovacaonivelid',
            'fluxoaprovacaostatusid',
            'iduser',
            'observacao'
        );
        
        $result = SDatabase::query($select, array($fluxoAprovacaoNivelId, $fluxoSolicitacaoId));
        
        return $returnAsObject ? SAGU::resultToObject($result, $cols) : $result;
    }
    
    /**
     * Efetua registro da avaliação.
     * 
     * @param stdClass $args
     */
    public static function registrarAvaliacao($args)
    {
        $finFluxoAprovacao = new FinFluxoAprovacao();
        $finFluxoAprovacao->fluxoSolicitacaoId     = $args->fluxoSolicitacaoId;
        $finFluxoAprovacao->fluxoAprovacaoNivelId  = $args->fluxoAprovacaoNivelId;
        $finFluxoAprovacao->fluxoAprovacaoStatusId = $args->fluxoAprovacaoStatusId;
        $finFluxoAprovacao->idUser                 = $args->idUser;
        $finFluxoAprovacao->observacao             = $args->obs;

        if ( $finFluxoAprovacao->save() )
        {
            $finFluxoSolicitacao = new FinFluxoSolicitacao($finFluxoAprovacao->fluxoSolicitacaoId);
            $finFluxoSolicitacao->verificarSeASolicitacaoFoiAprovadaOuReprovada();

            $finFluxoSolicitacao->criarLembretesParaOsAvaliadores();
        }
    }
}

?>
