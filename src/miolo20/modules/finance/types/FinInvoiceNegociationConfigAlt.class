<?php

class FinInvoiceNegociationConfigAlt extends SType
{
    
    protected $_tableName = 'finperfilnegociacao';
    
    public $perfilnegociacaoid;
    public $descricao;
    public $permiterenegociacao;
    
    public static function searchGrid($filters)
    {
        $sql = "SELECT P.perfilnegociacaoid,
                       P.descricao,
                       P.permiterenegociacao
                  FROM finperfilnegociacao P ";

        $params = array();
        $where = '1=1';

        if ( strlen($filters->perfilnegociacaoid) > 0 )
        {
            $where .= " AND P.perfilnegociacaoid = ? ";
            $params[] = $filters->perfilnegociacaoid;
        }
        
        if ( strlen($filters->descricao) > 0 )
        {
            $where .= " AND P.descricao ILIKE '%{$filters->descricao}%' ";
        }

        $sql .= ' WHERE ' . $where;

        $result = SDatabase::query($sql, $params);
        
        return (array) $result;
    }
    
    public function obterGrupos()
    {
        $grupos = array();
        
        $sql = " SELECT idgroup FROM finperfilnegociacaogrupo WHERE perfilnegociacaoid = ? ";
        
        $result = SDatabase::query($sql, array($this->perfilnegociacaoid));        
        foreach ( $result as $line )
        {
            $grupos[] = $line[0];
        }
        
        return $grupos;
    }
    
    public function obterCondicoes()
    {
        $grupos = array();
        
        $sql = " SELECT P.operationid,
                        O.description,
                        P.bankaccountid,
                        P.costcenterid,
                        C.description,
                        P.policyid,
                        POL.description,
                        P.tipo,
                        P.taxanegociacao,
                        P.percentualentrada,
                        P.numeroparcelas,
                        P.juros,
                        P.ordemcondicao,
                        P.diavencimento,
                        P.liberarjuros,
                        P.liberarmulta,
                        B.description,
                        P.percentualdedesconto,
                        P.descricao AS descricaoCondicao
                   FROM fincondicoesdepagamentoperfil P
              LEFT JOIN finoperation O ON (P.operationid = O.operationid)
              LEFT JOIN finbankaccount B ON (P.bankaccountid = B.bankaccountid)
              LEFT JOIN acccostcenter C ON (P.costcenterid = C.costcenterid)
              LEFT JOIN finpolicy POL ON (P.policyid = POL.policyid)
                  WHERE perfilnegociacaoid = ? 
               ORDER BY P.ordemCondicao";
        
        $result = SDatabase::query($sql, array($this->perfilnegociacaoid));
        
        return SAGU::resultToObject($result, array(
            'operationId',
            'operationDescription',
            'bankaccountid',
            'costCenterId',
            'costCenterDescription',
            'policyId',
            'policyDescription',
            'tipo',
            'taxanegociacao',
            'percentualentrada',
            'numeroparcelas',
            'juros',
            'ordemcondicao',
            'diavencimento',
            'liberarjuros',
            'liberarmulta',
            'bankAccountDescription',
            'percentualdedesconto',
            'descricaoCondicao'
        ));
    }
    
}
?>