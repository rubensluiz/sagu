<?php

/**
 * <--- Copyright 2005-2010 de Solis - Cooperativa de Soluções Livres Ltda.
 * 
 * Este arquivo é parte do programa Sagu.
 * 
 * O Sagu é um software livre; você pode redistribuí-lo e/ou modificá-lo
 * dentro dos termos da Licença Pública Geral GNU como publicada pela Fundação
 * do Software Livre (FSF); na versão 2 da Licença.
 * 
 * Este programa é distribuído na esperança que possa ser útil, mas SEM
 * NENHUMA GARANTIA; sem uma garantia implícita de ADEQUAÇÃO a qualquer MERCADO
 * ou APLICAÇÃO EM PARTICULAR. Veja a Licença Pública Geral GNU/GPL em
 * português para maiores detalhes.
 * 
 * Você deve ter recebido uma cópia da Licença Pública Geral GNU, sob o título
 * "LICENCA.txt", junto com este programa, se não, acesse o Portal do Software
 * Público Brasileiro no endereço www.softwarepublico.gov.br ou escreva para a
 * Fundação do Software Livre (FSF) Inc., 51 Franklin St, Fifth Floor, Boston,
 * MA 02110-1301, USA --->
 * 
 * Receivable invoice generation form
 *
 * @author Alexandre Heitor Schmidt [alexsmith@solis.coop.br]
 * @maintainer: William Prigol Lopes [william@solis.coop.br]
 *
 * @version $Id$
 *
 * \b Maintainers: \n
 * Alexandre Heitor Schmidt [alexsmith@solis.coop.br]
 * Daniel Afonso Heisler [daniel@solis.coop.br]
 * Eduardo Beal Miglioransa [eduardo@solis.coop.br]
 * Jamiel Spezia [jamiel@solis.coop.br]
 * Samuel Koch [samuel@solis.coop.br]
 * William Prigol Lopes [william@solis.coop.br]
 *
 * @since
 * Class created on 13/12/2005
 *
 **/

/**
 * Form to control receivable invoice generation
 **/
class FrmReceivableInvoiceGenerationCompany extends MForm
{
    private $home;
    
    /**
     * Class constructor
     **/
    public function __construct($data)
    {
        $MIOLO  = MIOLO::getInstance();
        $module = MIOLO::getCurrentModule();
        
        $this->home = $data->home;
        
        parent::__construct(_M('Geração de títulos a receber para incentivos', $module));
        
        $this->setShowPostButton(false);
        $this->setHelp(get_class($this), MIOLO::getCurrentModule(), MIOLO::getCurrentAction());

        if (($f = $this->page->request('cpaint_function')) != "")
        {
            $this->manager->getTheme()->clearContent();
            $this->$f($this->page->request('cpaint_argument'));
            $this->page->generateMethod = 'generateAJAX';
        }
        else
        {
            $this->defineFields();
            $this->eventHandler();
        }
    }

    /**
     * Default method to define fields
     **/
    public function defineFields()
    {
        $MIOLO    = MIOLO::getInstance();
        $module   = MIOLO::getCurrentModule();
        $action   = MIOLO::getCurrentAction();

        $toolBar = new MToolBar('toolBar',$MIOLO->getActionURL($module,$action));
        $toolBar->disableButton('tbBtnSave');
        $toolBar->disableButton('tbBtnDelete');
        $toolBar->disableButton('tbBtnPrint');
        $toolBar->disableButton('tbBtnNew');
        $toolBar->disableButton('tbBtnSearch');

        //favoritos
        $enabledImage  = $MIOLO->getUI()->GetImageTheme($MIOLO->theme->id, 'bookmark-20x20.png');
        $disabledImage = $MIOLO->getUI()->GetImageTheme($MIOLO->theme->id, 'bookmark-disabled-20x20.png');
        $url           = $MIOLO->getActionURL($module, $this->home, null, array('function' => 'search', 'event' => 'bookmark'));
        

        if ( MIOLO::_request('event') == 'bookmark' )
        {
            $MIOLO->getClass('basic', 'access');
            access::insert('Receivable invoice generation company', $this->home, 'receivableInvoiceGenerationCompany-16x16.png', true);
        }
        //fim favoritos

        $fields[] = $toolBar;
        
        // Incentive
        $incentiveTypeLabel   = new MText('incentiveTypeText', _M('Tipo de convênio a processar', $module).':');
        $incentiveTypeLabel->setWidth(SAGU::getParameter('BASIC', 'FIELD_CONTAINER_SIZE'));
        $incentiveTypeOptions = array( array('support', _M('Patrocínio', $module)),
                                       array('loan',    _M('Financiamento', $module))
                                     );

        $incentiveType = new MSelection('incentiveType', '', '', $incentiveTypeOptions);
        $incentiveType->addAttribute('onChange', 'callProcessType()');
        $incentiveType->setJsHint(_M('Selecione o tipo de incentivo', $module));
        $fields[]      = new MHContainer('hctIncentiveType', array($incentiveTypeLabel, $incentiveType));
        $incentiveType = $this->getFormValue('incentiveType', $data->incentiveType);
        $fields[] = new MSeparator('');
        $fields[] = new MDiv('divContent', null);
        $this->setFields($fields);

        $this->page->addScript('x/x_core.js');
        $this->page->addScript('cpaint/cpaint.inc.js');
        $this->page->addScript('m_validator.js');
        $MIOLO->getRequiredJS4Ajax();
        $url = str_replace('&amp;', '&', $this->manager->getCurrentURL());

        // BEGIN AJAX calls
        $code = '
            function callProcessType()
            {
                xGetElementById(\'divContent\').innerHTML = \'Loading...<img src="/images/loading.gif"/>\';
                var args = xGetElementById(\'incentiveType\').value;
                cpaint_call("'. $url .'", "POST", "ajax_invoiceProcessType", args, returnInvoiceFields, "TEXT");
            }

            function returnInvoiceFields(result)
            {
                xGetElementById(\'divContent\').innerHTML = result;
                MIOLO_parseAjaxJavascript(result);
            }
        ';
        $this->page->AddJsCode($code);
        // END AJAX calls
        
        if (is_array($validators))
        {
            $this->setValidators($validators);
        }
        $this->setLabelWidth(SAGU::getParameter('BASIC', 'FIELD_LABEL_SIZE'));
        $this->setClose($MIOLO->getActionURL($module, substr($action, 0, strrpos($action, ':'))));
        
    }

   /**
    * Event triggered when user submit the data
    */
    public function submit_button_click($sender=NULL)
    {
        $MIOLO    = MIOLO::getInstance();
        $module   = MIOLO::getCurrentModule();
        $action   = MIOLO::getCurrentAction();

        $data = $this->getFormData();
        $business = new BusinessFinanceBusReceivableInvoiceCompany();
        $url      = $MIOLO->getActionURL($module, substr($action, 0, strrpos($action, ':')));
        $status   = $business->generateSupportInvoices($data);
        if (!$status)
        {
            $MIOLO->error(_M('Não foi possível gerar os títulos.', $module), $url);
        }
        else
        {
            // Information relative about incentives
            if ($business->statisticsData->support->process == true)
            {
                
                $data = clone($business->statisticsData);
                // Base group containing basic information about process type
                $typeLabel          = new MText('typeLabel', _M('Tipo de processo', $module).': ');
                $typeLabel->setWidth(SAGU::getParameter('BASIC', 'FIELD_CONTAINER_SIZE'));
                $type               = new MText('type', _M('Patrocínio', $module));
                $hctType            = new MHContainer('hctType', array($typeLabel, $type));
                $fieldsStatistics[] = $hctType;
                
                // Main total
                $totalLabel         = new MText('totalLabel', _M('Total', $module).':');
                $totalLabel->setWidth(SAGU::getParameter('BASIC', 'FIELD_CONTAINER_SIZE'));

                $total              = new MText('total', strlen($data->support->total) ? $data->support->total : '0');
                $hctTotal           = new MHContainer('hctTotal', array($totalLabel, $total));
                $fieldsStatistics[] = $hctTotal;
               
                // Agglutinated total
                $agglutinatedTotalLabel = new MText('agglutinatedTotalLabel', _M('Total aglutinado', $module).':');
                $agglutinatedTotalLabel->setWidth(SAGU::getParameter('BASIC', 'FIELD_CONTAINER_SIZE'));
                $countAgglutinated      = count($data->receivableInvoice->agglutinate->data);
                $totalEntries           = $data->receivableInvoice->agglutinate->totalEntries;
                $agglutinatedTotal      = new MText('agglutinatedTotal', $countAgglutinated ? ($countAgglutinated.' '._M('Títulos gerados em um total de @1 lançamentos', $module, $totalEntries)) : '0');
                $hctAgglutinatedTotal   = new MHContainer('hctAgglutinatedTotal', array($agglutinatedTotalLabel, $agglutinatedTotal));
                $fieldsStatistics[]     = $hctAgglutinatedTotal;

                // noAgglutinated total
                $noAgglutinatedTotalLabel = new MText('noAgglutinatedTotalLabel', _M('Total não aglutinado', $module).':');
                $noAgglutinatedTotalLabel->setWidth(SAGU::getParameter('BASIC', 'FIELD_CONTAINER_SIZE'));
                $countNoAgglutinated      = count($data->receivableInvoice->noAgglutinate->data);
                $noAgglutinatedTotal      = new MText('noAgglutinatedTotal', $countNoAgglutinated ? $countNoAgglutinated : '0');
                $hctNoAgglutinatedTotal   = new MHContainer('hctNoAgglutinatedTotal', array($noAgglutinatedTotalLabel, $noAgglutinatedTotal));
                $fieldsStatistics[]       = $hctNoAgglutinatedTotal;
                
                // noProcessed total
                $noProcessedTotalLabel = new MText('noProcessedTotalLabel', _M('Total não processado', $module).':');
                $noProcessedTotalLabel->setWidth(SAGU::getParameter('BASIC', 'FIELD_CONTAINER_SIZE'));
                $noProcessed           = count($data->receivableInvoice->noProcessed->data);
                $noProcessedTotal      = new MText('noProcessedTotal', $noProcessed ? $noProcessed : '0');
                $hctNoProcessedTotal   = new MHContainer('hctNoProcessedTotal', array($noProcessedTotalLabel, $noProcessedTotal));
                $fieldsStatistics[]    = $hctNoProcessedTotal;
                //
                // End base group with info about process
                //
                
                if ($data->support->total>0)
                {
                    if (is_array($data->receivableInvoice->agglutinate->data))
                    {
                        // We need make that because the tableRaw accepts only sequencial arrays
                        // And put a link to consult the generated invoice
                        foreach ($data->receivableInvoice->agglutinate->data as $info)
                        {
                            $_info[]   = $info[0];
                            $_info[]   = $info[1];
                            $url = $MIOLO->getActionURL($module, 'main:diverseConsultation', null, array('event'=>'btnSearch_click', 'invoiceId'=>$info[2]));
                            $info[2]   = new MOpenWindow('invoice'.$info[2], $info[2], $url, $info[2]);
                            $_info[]   = $info[2]->generate();
                            $rawData[] = $info;
                            unset($_info);
                        }
                        unset($cols);
                        $cols[]        = new MDiv('col11', _M('Patrocinador',          $module), null, 'align="center"');
                        $cols[]        = new MDiv('col12', _M('Número de incentivos', $module), null, 'align="center"');
                        $cols[]        = new MDiv('col13', _M('Título de incentivo',    $module), null, 'align="center"');
                        $titleTableRaw = _M('Auxílios aglutinados processados', $module);
                        $fields[]      = new MSeparator('');
                        $tableRaw      = new MTableRaw($titleTableRaw, $rawData, $cols);
                        $tableRaw->setAlternate(true);
                        $tableRaw->setAttributes('width="100%"');
                        $fields[]      = $tableRaw;
                        $fld           = new MSeparator('<hr>');
                        $fld->setWidth('99%');
                        $fields[]      = $fld;
                    }
                    unset($rawData);

                    if (is_array($data->receivableInvoice->noAgglutinate->data))
                    {
                        // We need make that because the tableRaw accept only sequencial arrays
                        // and, of course, add links for access info about invoices
                        foreach ($data->receivableInvoice->noAgglutinate->data as $info)
                        {
                            $url     = $MIOLO->getActionURL($module, 'main:register:support', null, array('supportId'=>$info[0]));
                            $info[0] = new MOpenWindow('support'.$info[0], $info[0], $url, $info[0]);
                            $_info[] = $info[0]->generate();
                            $_info[] = $info[1];
                            $_info[] = $info[2];

                            $url     = $MIOLO->getActionURL($module, 'main:diverseConsultation', null, array('event'=>'btnSearch_click', 'invoiceId'=>$info[3]));
                            $info[3] = new MOpenWindow('pupilInvoice'.$info[3], $info[3], $url, $info[3]);
                            $_info[] = $info[3]->generate();

                            $url     = $MIOLO->getActionURL($module, 'main:diverseConsultation', null, array('event'=>'btnSearch_click', 'invoiceId'=>$info[4]));
                            $info[4] = new MOpenWindow('incentiveInvoice'.$info[4], $info[4], $url, $info[4]);
                            $_info[] = $info[4]->generate();

                            $rawData[] = $_info;
                            unset($_info);
                        }
                        unset($cols);
                        // Generate table about no agglutinate processes
                        $cols[]        = new MDiv('col21', _M('Código do incentivo',      $module), null, 'align="center"');
                        $cols[]        = new MDiv('col22', _M('Patrocinador',       $module), null, 'align="center"');
                        $cols[]        = new MDiv('col23', _M('Aluno',           $module), null, 'align="center"');
                        $cols[]        = new MDiv('col24', _M('Título do aluno',   $module), null, 'align="center"');
                        $cols[]        = new MDiv('col25', _M('Título de incentivo', $module), null, 'align="center"');
                        $titleTableRaw = _M('Auxílios não aglutinados processados', $module, null, 'align="center"');
                        $fields[]      = new MSeparator('');
                        $tableRaw      = new MTableRaw($titleTableRaw, $rawData, $cols);
                        $tableRaw->setAlternate(true);
                        $tableRaw->setAttribute('width', '100%');
                        $fields[]      = $tableRaw;
                        $fld = new MSeparator('<hr>');
                        $fld->setWidth('99%');
                        $fields[]      = $fld;
                    }
                    if ((is_array($data->receivableInvoice->noProcessed->data)) && (SHOW_NO_PROCESSED_INVOICES_FOR_COMPANY == 'YES'))
                    {
                        unset($cols);
                        $rawData       = $data->receivableInvoice->noProcessed->data;
                        $cols[]        = new MDiv('col31', _M('Código do contrato',     $module), null, 'align="center"');
                        $cols[]        = new MDiv('col32', _M('Patrocinador',       $module), null, 'align="center"');
                        $cols[]        = new MDiv('col33', _M('Aluno',           $module), null, 'align="center"');
                        $cols[]        = new MDiv('col34', _M('Tipo de incentivo',  $module), null, 'align="center"');
                        $titleTableRaw = _M('Auxílios encontrados que não foram processados', $module);
                        $tableRaw      = new MTableRaw($titleTableRaw, $rawData, $cols);
                        $tableRaw->setAlternate(true);
                        $tableRaw->setAttribute('width', '100%');
                        $fields[]      = $tableRaw;
                        $fld           = new MSeparator('<hr>');
                        $fld->setWidth('99%');
                        $fields[]      = $fld;
                    }
                }
                else
                {
                    $flds     = new MSeparator('');
                    $fields[] = $flds;
                    $msg = new MSpan('msgInfo', _M('Não foram encontradas informações a serem processadas', $module));
                    $msg->setColor('red');
                    $fields[] = new MDiv('messageInfo', $msg, null, 'align="center"');
                    $flds     = new MSeparator('<hr>');
                    $flds->setWidth('99%');
                    $fields[] = $flds;                
                }
            }
            // Information relative about incentives
            elseif ($business->statisticsData->loan->process == true)
            {   
                $data = clone($business->statisticsData);
                
                //
                // Base group containing basic information about process type
                //
                $typeLabel          = new MText('typeLabel', _M('Tipo de processo', $module).': ');
                $typeLabel->setWidth(SAGU::getParameter('BASIC', 'FIELD_CONTAINER_SIZE'));
                $type               = new MText('type', _M('Financiamento', $module));
                $hctType            = new MHContainer('hctType', array($typeLabel, $type));
                $fieldsStatistics[] = $hctType;
                
                // Main total
                $totalLabel         = new MText('totalLabel', _M('Total', $module).':');
                $totalLabel->setWidth(SAGU::getParameter('BASIC', 'FIELD_CONTAINER_SIZE'));
                $total              = new MText('total', strlen($data->loan->total)>0 ? $data->loan->total : '0');
                $hctTotal           = new MHContainer('hctTotal', array($totalLabel, $total));
                $fieldsStatistics[] = $hctTotal;
               
                // Agglutinated total
                $agglutinatedTotalLabel = new MText('agglutinatedTotalLabel', _M('Total aglutinado', $module));
                $agglutinatedTotalLabel->setWidth(SAGU::getParameter('BASIC', 'FIELD_CONTAINER_SIZE'));
                $countAgglutinated      = count($data->receivableInvoice->agglutinate->data);
                $totalEntries           = $data->receivableInvoice->agglutinate->totalEntries;
                $agglutinatedTotal      = new MText('agglutinatedTotal', $countAgglutinated ? ($countAgglutinated.' '._M('Títulos gerados', $module)) : '0');
                $hctAgglutinatedTotal   = new MHContainer('hctAgglutinatedTotal', array($agglutinatedTotalLabel, $agglutinatedTotal));
                $fieldsStatistics[]     = $hctAgglutinatedTotal;

                // noAgglutinated total
                $noAgglutinatedTotalLabel = new MText('noAgglutinatedTotalLabel', _M('Total não aglutinado', $module).':');
                $noAgglutinatedTotalLabel->setWidth(SAGU::getParameter('BASIC', 'FIELD_CONTAINER_SIZE'));
                $countNoAgglutinated      = count($data->receivableInvoice->noAgglutinate->data);
                $noAgglutinatedTotal      = new MText('noAgglutinatedTotal', $countNoAgglutinated ? $countNoAgglutinated : '0');
                $hctNoAgglutinatedTotal   = new MHContainer('hctNoAgglutinatedTotal', array($noAgglutinatedTotalLabel, $noAgglutinatedTotal));
                $fieldsStatistics[]       = $hctNoAgglutinatedTotal;
                
                // noProcessed total
                $noProcessedTotalLabel = new MText('noProcessedTotalLabel', _M('Total não processado', $module).':');
                $noProcessedTotalLabel->setWidth(SAGU::getParameter('BASIC', 'FIELD_CONTAINER_SIZE'));
                $noProcessed           = count($data->receivableInvoice->noProcessed->data);
                $noProcessedTotal      = new MText('noProcessedTotal', $noProcessed ? $noProcessed : '0');
                $hctNoProcessedTotal   = new MHContainer('hctNoProcessedTotal', array($noProcessedTotalLabel, $noProcessedTotal));
                $fieldsStatistics[]    = $hctNoProcessedTotal;
                //
                // End base group with info about process
                //

                if ($data->loan->total>0)
                {
                    if (is_array($data->receivableInvoice->agglutinate->data))
                    {
                        // We need make that because the tableRaw accepts
                        // only sequencial arrays
                        foreach ($data->receivableInvoice->agglutinate->data as $info)
                        {
                            $_info[] = $info[0];
                            $_info[] = $info[1];
                            $url     = $MIOLO->getActionURL($module, 'main:diverseConsultation', null, array('event'=>'btnSearch_click', 'invoiceId'=>$info[2]));
                            $info[2]   = new MOpenWindow('invoice'.$info[2], $info[2], $url, $info[2]);
                            $_info[]   = $info[2];
                            $rawData[] = $_info;
                            unset($_info);
                        }

                        $cols[] = new MDiv('col11', _M('Código do incentivo', $module),    null, 'align="center"');
                        $cols[] = new MDiv('col12', _M('Nome do aluno', $module),      null, 'align="center"');
                        $cols[] = new MDiv('col13', _M('Título de incentivo', $module), null, 'align="center"');
                        
                        $titleTableRaw = _M('Empréstimos aglutinados processados: ', $module);
                        $tableRaw      = new MTableRaw($titleTableRaw, $rawData, $cols);
                        unset ($cols);
                        $tableRaw->setAlternate(true);
                        $tableRaw->setAttributes('width="100%"'); 
                        $fields[] = $tableRaw;
                        $flds     = new MSeparator('<hr>');                        
                        $flds->setWidth('99%');
                        $fields[] = $flds;
                    }
                    unset($rawData);

                    if (is_array($data->receivableInvoice->noAgglutinate->data))
                    {
                        // We need make that because the tableRaw accepts
                        // only sequencial arrays
                        foreach ($data->receivableInvoice->noAgglutinate->data as $info)
                        {
                            $_info[]   = $info[0];
                            $_info[]   = $info[1];
                            $url       = $MIOLO->getActionURL($module, 'main:diverseConsultation', null, array('event'=>'btnSearch_click', 'invoiceId'=>$info[2]));
                            $info[2]   = new MOpenWindow('invoice'.$info[2], $info[2], $url, $info[2]);
                            $_info[]   = $info[2]->generate();
                            $rawData[] = $_info;
                            unset($_info);
                        }

                        $cols[] = new MDiv('col21', _M('Aluno', $module),           null, 'align="center"');
                        $cols[] = new MDiv('col22', _M('Patrocinador', $module),       null, 'align="center"');
                        $cols[] = new MDiv('col23', _M('Título de incentivo', $module), null, 'align="center"');
                        $titleTableRaw = _M('Empréstimos processados não aglutinados', $module);
                        $tableRaw = new MTableRaw($titleTableRaw, $rawData, $cols);
                        unset ($cols);
                        $tableRaw->setAlternate(true);
                        $tableRaw->setAttributes('width="100%"');
                        $fields[] = $tableRaw;
                        $flds     = new MSeparator('<hr>');
                        $flds->setWidth('99%');
                        $fields[] = $flds;
                    }
                    if ((is_array($data->receivableInvoice->noProcessed->data)) && (SHOW_NO_PROCESSED_INVOICES_FOR_COMPANY == 'YES'))
                    {
                        $cols[] = new MDiv('col31', _M('Código do incentivo', $module),    null, 'align="center"');
                        $cols[] = new MDiv('col32', _M('Nome do aluno', $module),      null, 'align="center"');
                        $cols[] = new MDiv('col33', _M('Título de incentivo', $module), null, 'align="center"');
                        
                        $titleTableRaw = _M('Empréstimos não processados: ', $module);
                        $tableRaw      = new MTableRaw($titleTableRaw, $rawData, $cols);
                        $tableRaw->setAlternate(true);
                        $tableRaw->setAttributes('width="100%"'); 
                        $fields[]      = $tableRaw;
                        $flds          = new MSeparator('<hr>');                        
                        $flds->setWidth('99%');
                        $fields[]      = $flds;
                    }
                }
                else
                {
                    $flds     = new MSeparator('');
                    $fields[] = $flds;
                    $msg = new MSpan('msgInfo', _M('Não foram encontradas informações a serem processadas', $module));
                    $msg->setColor('red');
                    $fields[] = new MDiv('messageInfo', $msg, null, 'align="center"');
                    $flds     = new MSeparator('<hr>');
                    $flds->setWidth('99%');
                    $fields[] = $flds;
                }
            }
            else
            {
                $flds     = new MSeparator('');
                $fields[] = $flds;
                $fields[] = new MDiv('messageInfo', _M('Não foram encontradas informações a serem processadas', $module), null, 'align="center"');
                $flds     = new MSeparator('<hr>');
                $flds->setWidth('99%');
                $fields[] = $flds;
            }
            $fieldsStatistics = array(new MVContainer('statistics', $fieldsStatistics));
            
            $bgInfo[]   = new MBaseGroup('bgInfo', _M('Informações sobre o processo', $module), $fieldsStatistics);
            $fields     = is_array($fields) ? array_merge($bgInfo, $fields) : $bgInfo;
            $url        = $MIOLO->getActionURL($module, $action);
            $flds       = new MButton('okButton', _M('Ok', $module), $url);
            $fields[]   = new MDiv('okDiv', $flds, null, 'align="center"');
            $fields[]   = new MSeparator('');
            
            $this->setFields($fields);
            $this->setShowPostButton(false);
        }
    }

   /** 
    * Event triggered when process type for ajax is called
    */ 
    public function ajax_invoiceProcessType($arg)
    {
        $MIOLO  = MIOLO::getInstance();
        $module = MIOLO::getCurrentModule();
        $action = MIOLO::getCurrentAction();

        $incentiveType = $arg[0];
        
        if (strlen($incentiveType)>0 )
        {
            // Year
            $selYearLabel = new MText('selYearLabel', _M('Ano', $module).':');
            $selYearLabel->setWidth(SAGU::getParameter('BASIC', 'FIELD_CONTAINER_SIZE'));
            $selYear      = new MSelection('selYear', $this->getFormValue('selYear', date('Y')), '', SAGU::listYears(date('Y')-5, date('Y')+6));
            $selYear->setJsHint(_M('Escolha o ano no qual você deseja que os títulos sejam gerados.', $module));
            $fields[]     = new MHContainer('hctSelYear', array($selYearLabel, $selYear));
            $validators[] = new MRequiredValidator('selYear', _M('Ano', $module));

            // Month
            $selMonthLabel = new MText('selMonthLabel', _M('Mês', $module).':');
            $selMonthLabel->setWidth(SAGU::getParameter('BASIC', 'FIELD_CONTAINER_SIZE'));
            $selMonth      = new MSelection('selMonth', $this->getFormValue('selMonth', date('m')), '', SAGU::listMonths());
            $selMonth->setJsHint(_M('Escolha o mês para os títulos que você deseja gerar.', $module));
            $fields[]      = new MHContainer('hctSelMonth', array($selMonthLabel, $selMonth));
            $validators[]  = new MRequiredValidator('selMonth', _M('Mês', $module));

            // Bank account
            $businessBankAccount = new BusinessFinanceBusBankAccount();
            $dataBankAccount     = $businessBankAccount->listBankAccount();

            $mField       = new MComboBox('bankAccountId', $this->getFormValue('bankAccountId', $data->bankAccountId) ? $this->getFormValue('bankAccountId', $data->bankAccountId) : SAGU::getParameter('BASIC', 'DEFAULT_BANK_ACCOUNT_ID'), _M('Código da conta bancária', $module), $dataBankAccount);
            $fields[]     = $field;
            $validators[] = new MRequiredValidator('bankAccountId');
            
            $vctFields[]  = new MVContainer('vctMain', $fields);
            $mFields[]    = new MBaseGroup('incentiveInfo', _M('Informações principais', $module), $vctFields);
            unset($fields);
            unset($vctFields);
            if ($incentiveType == 'loan')
            {
                // Year
                $selYearLabel = new MText('loanYearLabel', _M('Ano', $module).':');
                $selYearLabel->setWidth(SAGU::getParameter('BASIC', 'FIELD_CONTAINER_SIZE'));
                $selYear      = new MSelection('loanYear', $this->getFormValue('selYear', date('Y')), '', SAGU::listYears(date('Y'), date('Y')+25));
                $selYear->setJsHint(_M('Escolha o ano no qual você deseja que os títulos sejam gerados.', $module));
                $fields[]     = new MHContainer('hctLoanYear', array($selYearLabel, $selYear));
                $validators[] = new MRequiredValidator('loanYear', _M('Ano do financiamento', $module));

                // Month
                $selMonthLabel = new MText('loanMonthLabel', _M('Mês', $module).':');
                $selMonthLabel->setWidth(SAGU::getParameter('BASIC', 'FIELD_CONTAINER_SIZE'));
                $selMonth      = new MSelection('loanMonth', $this->getFormValue('selMonth', date('m')), '', SAGU::listMonths());
                $selMonth->setJsHint(_M('Escolha o mês para os títulos que você deseja gerar.', $module));
                $fields[]      = new MHContainer('hctLoanMonth', array($selMonthLabel, $selMonth));
                $validators[]  = new MRequiredValidator('loanMonth', _M('Mês do financiamento', $module));
                $vctFields[]   = new MVContainer('vctLoan', $fields);
                $mFields[]     = new MBaseGroup('loanBg', _M('Informações sobre empréstimos (dados para gerar títulos para longo prazo)', $module), $vctFields);
            }
            $spanGenerate = new MSpan('spanSpacing', '<hr>');
            $btnGenerate  = new MButton('submit_button', _M('Gerar', $module), 'SUBMIT');
            $sepDiv       = new MDiv('divGenerate', array($spanGenerate, $btnGenerate));
            $sepDiv->setWidth('99%');
            $mFields[]    = $sepDiv;
        }
        else
        {
            $mFields[] = new MText('MWarn', _M('Por favor, selecione um tipo de incentivo para continuar', $module));
        }

        $field = new MVContainer('vContainer', $mFields);
        $this->setValidators($validators);
        $this->manager->getTheme()->setContent($field);
    }
    
    /**
     * Method to gather all information from the form fields
     **/
    public function getFormData()
    {
        $ret->year          = $this->getFormValue('selYear');
        $ret->month         = $this->getFormValue('selMonth');
        $ret->incentiveType = $this->getFormValue('incentiveType');
        $ret->loanMonth     = $this->getFormValue('loanMonth');
        $ret->loanYear      = $this->getFormValue('loanYear');
        $ret->bankAccountId = $this->getFormValue('bankAccountId');
        return $ret;
    }
}
?>
