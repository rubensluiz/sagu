<?php
/**
 * <--- Copyright 2005-2011 de Solis - Cooperativa de Soluções Livres Ltda.
 *
 * Este arquivo é parte do programa Sagu.
 *
 * O Sagu é um software livre; você pode redistribuí-lo e/ou modificá-lo
 * dentro dos termos da Licença Pública Geral GNU como publicada pela Fundação
 * do Software Livre (FSF); na versão 2 da Licença.
 *
 * Este programa é distribuído na esperança que possa ser útil, mas SEM
 * NENHUMA GARANTIA; sem uma garantia implícita de ADEQUAÇÃO a qualquer MERCADO
 * ou APLICAÇÃO EM PARTICULAR. Veja a Licença Pública Geral GNU/GPL em
 * português para maiores detalhes.
 *
 * Você deve ter recebido uma cópia da Licença Pública Geral GNU, sob o título
 * "LICENCA.txt", junto com este programa, se não, acesse o Portal do Software
 * Público Brasileiro no endereço www.softwarepublico.gov.br ou escreva para a
 * Fundação do Software Livre (FSF) Inc., 51 Franklin St, Fifth Floor, Boston,
 * MA 02110-1301, USA --->
 *
 * @author Moises Heberle [moises@solis.coop.br]
 *
 * \b Maintainers \n
 * Arthur Lehdermann [arthur@solis.coop.br]
 * Moises Heberle [moises@solis.coop.br]
 *
 * @since
 * Class created on 16/07/2011
 */

class BusinessapsLookup
{
    /**
     * Autocomplete ofertaDeUnidadeTematica
     *
     * @param type $context
     */
    public function autoCompleteofertaDeUnidadeTematica(&$context)
    {
        $module = SAGU::getFileModule(__FILE__);

        $sql = 'SELECT a.ofertaDeUnidadeTematicaId,
                       b.descricao
                  FROM aps.ofertadeunidadeTematica a
            INNER JOIN aps.unidadetematica b
                    ON a.unidadetematicaid = b.unidadetematicaid
                 WHERE a.ofertadeunidadeTematicaId = ?';

        $context->setContext(SDatabase::getDefaultDb(), $sql);
    }

    /**
     * Lookup ofertaDeUnidadeTematica
     *
     * @global type $MIOLO
     * @param type $lookup
     */
    public function lookupofertaDeUnidadeTematica(&$lookup)
    {
        global $MIOLO;
        $module = MIOLO::_REQUEST('lmodule');
        $MIOLO->uses('classes/sagu.class', 'basic');

        $MIOLO->conf->loadConf($module);
        $MIOLO->page->onLoad("document.{$MIOLO->page->name}.userName.focus()");

        // Obtém os filtros:
        $ofertaDeUnidadeTematicaId = MIOLO::_REQUEST('ofertaDeUnidadeTematicaId');
        $unidadeTematicaId = MIOLO::_REQUEST('unidadeTematicaId');
        $personId = MIOLO::_REQUEST('personId');
        $inicio = MIOLO::_REQUEST('inicio');
        $fim = MIOLO::_REQUEST('fim');

        $fields = array();
        // Campo ofera de unidade temática
        $ofertaDeUnidadeTematicaIdField = new MTextField('ofertaDeUnidadeTematicaId', '', _M('Código da oferta do módulo', $module), SAGU::getParameter('BASIC', 'FIELD_ID_LOOKUP_SIZE'));
        $ofertaDeUnidadeTematicaIdField->setJsHint(_M('Informe o código da oferta de rodízio', $module));
        $fields[] = $ofertaDeUnidadeTematicaIdField;

        // Campo código da unidade temática
        $opts = array( 'label' => _M('Código módulo', $module),
            'item' => 'Unidadetematica',
            'module' => 'aps',
            'related' => array('unidadeTematicaIdDescription') );
        $fields[] = new SLookupContainer('unidadeTematicaId', $unidadeTematicaId, $opts);

        // Campo início
        $inicioField = new MCalendarField('inicio', $inicio, _M('Início', $module), SAGU::getParameter('BASIC', 'FIELD_DATE_LOOKUP_SIZE'));
        $inicioField->setJsHint(_M('Informe o inicio', $module));
        $fields[] = $inicioField;

        // Campo fim
        $fimField = new MCalendarField('fim', $fim, _M('Fim', $module), SAGU::getParameter('BASIC', 'FIELD_DATE_LOOKUP_SIZE'));
        $fimField->setJsHint(_M('Informe o fim', $module));
        $fields[] = $fimField;

        foreach ( $fields as $field )
        {
            $lookup->addFilterField($field);
        }

        $columns = array();
        $columns[] = new MDataGridColumn('ofertaDeUnidadeTematicaId', _M('Código da oferta de rodízio', $module), 'left', true, null, true);
        $columns[] = new MDataGridColumn('descricao', _M('Descrição', $module), 'left', true, null, true);
        $columns[] = new MDataGridColumn('inicio', _M('Início', $module), 'left', true, null, true);
        $columns[] = new MDataGridColumn('fim', _M('Fim', $module), 'left', true, null, true);

        $sql = "SELECT a.ofertaDeUnidadeTematicaId,
                       b.descricao,
                       TO_CHAR(inicio, '" . SAGU::getParameter('BASIC', 'MASK_DATE') . "') AS inicio,
                       TO_CHAR(fim, '" . SAGU::getParameter('BASIC', 'MASK_DATE') . "') AS fim
                  FROM aps.ofertaDeUnidadeTematica a
            INNER JOIN aps.unidadeTematica b
                    ON a.unidadetematicaid = b.unidadetematicaid";

        $where = '';
        $params = array();
        if ( strlen($ofertaDeUnidadeTematicaId) > 0 )
        {
            $where .= ' AND a.ofertaDeUnidadeTematicaId = ?';
            $params[] = $ofertaDeUnidadeTematicaId;
        }

        if ( strlen($unidadeTematicaId) > 0 )
        {
            $where .= ' AND b.unidadeTematicaId = ?';
            $params[] = $unidadeTematicaId;
        }

        if ( strlen($inicio) > 0 )
        {
            $where .= " AND a.inicio = TO_DATE(?, '" . SAGU::getParameter('BASIC', 'MASK_DATE') . "')";
            $params[] = $inicio;
        }

        if ( strlen($fim) > 0 )
        {
            $where .=  "AND a.fim = TO_DATE(?, '" . SAGU::getParameter('BASIC', 'MASK_DATE') . "')";
            $params[] = $fim;
        }

        if ( strlen($where) > 0 )
        {
            $sql .= ' WHERE ' . substr($where, 4);
        }

        $sql.= ' ORDER BY a.ofertaDeUnidadeTematicaId';

        if ( strlen($where) ==  0 )
        {
            $sql.= ' LIMIT 0';
        }



        $sqlObject = new sql();
        $sqlObject->createFrom(SAGU::prepare($sql, $params));

        $lookup->setFilterColumns(SAGU::getParameter('BASIC', 'LOOKUP_FILTER_COLUMNS'));
        $lookup->setLookupGrid(SDatabase::getDefaultDb(), $sqlObject, $columns, _M('Pesquisar', $module), 15, 0);
        $lookup->grid->setIsScrollable();
    }

    /**
     * Autocomplete UnidadeTematica
     *
     * @param type $context
     */
    public function autoCompleteUnidadeTematica(&$context)
    {
        $module = SAGU::getFileModule(__FILE__);
        $residenteId = MIOLO::_REQUEST('residenteId');
        $unidadeTematicaId = MIOLO::_REQUEST('unidadeTematicaId');

        $sql = "SELECT A.descricao,
                   (SELECT descricao FROM aps.periodoUnidadeTematica WHERE periodoId = A.periodo) AS periodo,
                   (SELECT descricao FROM aps.tipoUnidadeTematica WHERE tipoId = A.tipo) AS tipo,
                   A.cargaHoraria,
                   A.frequenciaMinima,
                   A.notaMaxima,
                   A.notaMinimaParaAprovacao,

                   ARRAY_TO_STRING(ARRAY(
                       SELECT descricao
                         FROM aps.nucleoDaUnidadeTematica NDUT
                   INNER JOIN aps.nucleoProfissional NP
                           ON NP.nucleoprofissionalid = NDUT.nucleoprofissionalid
                        WHERE NDUT.unidadetematicaid = A.unidadeTematicaId), ', ') AS nucleos,

                   ARRAY_TO_STRING(ARRAY(
                       SELECT descricao
                         FROM aps.enfaseDaUnidadeTematica EDUT
                   INNER JOIN aps.enfase E
                           ON E.enfaseId = EDUT.enfaseId
                        WHERE EDUT.unidadeTematicaId = A.unidadeTematicaId), ', ') AS enfases";

        //Obtem a carga horaria cursada pelo residente (caso seja passado como filtro)
        if ( strlen($residenteId) > 0 )
        {
            $sql .= ", aps.obtemcargahorariadoresidentenaoferta('{$residenteId}', B.ofertadeunidadetematicaid) AS cargaHorariaCursada,";
        }
        else
        {
            $sql .= ", NULL AS cargaHorariaCursada,";
        }

        $sql .= " A.periodo AS codigoPeriodo,
                  A.tipo AS codigoTipo";

        $sql .= "
             FROM aps.unidadeTematica A
             LEFT JOIN aps.ofertadeunidadetematica B
                ON A.unidadetematicaid = B.unidadetematicaid
            WHERE A.unidadeTematicaId = ?";

        $context->setContext(SDatabase::getDefaultDb(), $sql);
    }

    /**
     * Lookup UnidadeTematica
     *
     * @global type $MIOLO
     * @param type $lookup
     */
    public function lookupUnidadeTematica(&$lookup)
    {
        global $MIOLO;
        $module = MIOLO::_REQUEST('lmodule');
        $residenteId = MIOLO::_REQUEST('residenteId');
        $unidadeTematicaId = MIOLO::_REQUEST('unidadeTematicaId');

        $MIOLO->uses('classes/sagu.class', 'basic');
        $MIOLO->conf->loadConf($module);
        $MIOLO->page->onLoad("document.{$MIOLO->page->name}.descricao.focus()");

        $fields[] = $residenteField = new MTextField('residenteId', $residenteId);
        $residenteField->addAttribute('style', 'display:none');

        // Campo código da unidade temática
        $fields[] = $unidadeTematicaId = new MTextField('unidadeTematicaId', '', _M('Código do rodízio', $module), SAGU::getParameter('BASIC', 'FIELD_ID_LOOKUP_SIZE'));
        $unidadeTematicaId->setJsHint(_M('Informe o código do rodízio', $module));

        // Campo período
        $fields[] = $periodo = new MTextField('periodo', '', _M('Período', $module), SAGU::getParameter('BASIC', 'FIELD_DESCRIPTION_LOOKUP_SIZE'));
        $periodo->addAttribute('maxlength', '10');
        $periodo->setJsHint(_M('Informe o período', $module));

        // Campo descrição
        $fields[] = $descricao = new MTextField('descricao', '', _M('Descrição', $module), SAGU::getParameter('BASIC', 'FIELD_DESCRIPTION_LOOKUP_SIZE'));
        $descricao->addAttribute('maxlength', '255');
        $descricao->setJsHint(_M('Informe a descrição', $module));

        // Campo carga horária
        $fields[] = $cargaHoraria = new MTextField('cargaHoraria', '', _M('Carga horária', $module), SAGU::getParameter('BASIC', 'FIELD_MONETARY_SIZE'));
        $cargaHoraria->setJsHint(_M('Informe a carga horária', $module));

        // Campo frequência mínima
        $fields[] = $frequenciaMinima = new MTextField('frequenciaMinima', '', _M('Frequência mínima', $module), SAGU::getParameter('BASIC', 'FIELD_MONETARY_SIZE'));
        $frequenciaMinima->setJsHint(_M('Informe o frequência mínima', $module));

        // Campo tipo
        $fields[] = $tipo = new MTextField('tipo', '', _M('Tipo', $module), SAGU::getParameter('BASIC', 'FIELD_DESCRIPTION_LOOKUP_SIZE'));
        $tipo->addAttribute('maxlength', '1');
        $tipo->setJsHint(_M('Informe o tipo', $module));

        foreach ( $fields as $field )
        {
            $lookup->addFilterField($field);
            extract(array($field->name => $lookup->getFilterValue($field->name)));
        }

        $columns = array();
        $columns[] = new MDataGridColumn('unidadeTematicaId', _M('Código', $module), 'right', true, null, true);
        $columns[] = new MDataGridColumn('periodo', _M('Período', $module), 'left', true, null, true);
        $columns[] = new MDataGridColumn('descricao', _M('Descrição', $module), 'left', true, null, true);
        $columns[] = new MDataGridColumn('sumula', _M('Sumula', $module), 'left', true, null, true);
        $columns[] = new MDataGridColumn('cargaHoraria', _M('Carga horária', $module), 'right', true, null, true);
        $columns[] = new MDataGridColumn('frequenciaMinima', _M('Frequência mínima', $module), 'right', true, null, true);
        $columns[] = new MDataGridColumn('tipo', _M('Tipo', $module), 'left', true, null, true);
        $columns[] = new MDataGridColumn('nucleos', _M('Núcleos'), 'left', true, null, true);
        $columns[] = new MDataGridColumn('enfases', _M('Ênfases'), 'left', true, null, true);

        $sql = "SELECT A.unidadeTematicaId,
                   A.descricao,
                   (SELECT descricao FROM aps.periodoUnidadeTematica WHERE periodoId = A.periodo) AS periodo,
                   (SELECT descricao FROM aps.tipoUnidadeTematica WHERE tipoId = A.tipo) AS tipo,
                   A.cargaHoraria,
                   A.frequenciaMinima,
                   A.notaMaxima,
                   A.notaMinimaParaAprovacao,

                   ARRAY_TO_STRING(ARRAY(
                       SELECT descricao
                         FROM aps.nucleoDaUnidadeTematica NDUT
                   INNER JOIN aps.nucleoProfissional NP
                           ON NP.nucleoprofissionalid = NDUT.nucleoprofissionalid
                        WHERE NDUT.unidadetematicaid = A.unidadeTematicaId), ', ') AS nucleos,

                   ARRAY_TO_STRING(ARRAY(
                       SELECT descricao
                         FROM aps.enfaseDaUnidadeTematica EDUT
                   INNER JOIN aps.enfase E
                           ON E.enfaseId = EDUT.enfaseId
                        WHERE EDUT.unidadeTematicaId = A.unidadeTematicaId), ', ') AS enfases";

        //Obtem a carga horaria cursada pelo residente (caso seja passado como filtro)
        if ( strlen($residenteId) > 0 )
        {
            $sql .= ", aps.obtemcargahorariadoresidentenaoferta('{$residenteId}', B.ofertadeunidadetematicaid) AS cargaHorariaCursada,";
        }
        else
        {
            $sql .= ", NULL AS cargaHorariaCursada,";
        }

        $sql .= " A.periodo AS codigoPeriodo,
                  A.tipo AS codigoTipo";

        $sql .= " FROM aps.unidadeTematica A
                        INNER JOIN aps.enfasedaunidadetematica EU
                            ON A.unidadetematicaid = EU.unidadetematicaid
                        INNER JOIN aps.enfase EE
                            ON EU.enfaseid = EE.enfaseid";

        $where = '';
        $params = array();
        if ( strlen($unidadeTematicaId) > 0 )
        {
            $where .= ' AND A.unidadeTematicaId = ?';
            $params[] = $unidadeTematicaId;
        }

        if ( strlen($periodo) > 0 )
        {
            $where .= ' AND UNACCENT(A.periodo) ILIKE UNACCENT(?) ';
            $params[] = $período . '%';
        }

        if ( strlen($descricao) > 0 )
        {
            $where .= ' AND UNACCENT(A.descricao) ILIKE UNACCENT(?) ';
            $params[] = $descricao . '%';
        }

        if ( strlen($sumula) > 0 )
        {
            $where .= ' AND UNACCENT(A.sumula) ILIKE UNACCENT(?) ';
            $params[] = $sumula . '%';
        }

        if ( strlen($cargaHoraria) > 0 )
        {
            $where .= ' AND A.cargaHoraria = ?';
            $params[] = $cargaHoraria;
        }

        if ( strlen($frequenciaMinima) > 0 )
        {
            $where .= ' AND A.frequenciaMinima = ?';
            $params[] = $frequenciaMinima;
        }

        if ( strlen($tipo) > 0 )
        {
            $where .= ' AND A.tipo = ?';
            $params[] = $tipo;
        }

        $usuario = ApsEnfase::retornaAdminDaEspecialidadeResidenciaMedica();
        if ( $usuario )
        {
            $where .= " AND EE.enfaseid in (SELECT AA.enfaseid FROM aps.enfaseresponsavel AA WHERE AA.responsavel = ?)";
            $params[] = $usuario;
        }

        if ( strlen($where) > 0 )
        {
            $sql.= ' WHERE ' . substr($where, 4);
        }

        $sql .= ' ORDER BY A.unidadeTematicaId';

        if ( strlen($where)  ==  0 )
        {
            $sql .= ' LIMIT 0';
        }

        $sqlObject = new sql();
        $sqlObject->createFrom(SAGU::prepare($sql, $params));

        $lookup->setFilterColumns(SAGU::getParameter('BASIC', 'LOOKUP_FILTER_COLUMNS'));
        $lookup->setLookupGrid(SDatabase::getDefaultDb(), $sqlObject, $columns, _M('Pesquisar', $module), 15, 0);
        $lookup->grid->setIsScrollable();
    }

    /**
     * Autocomplete Tema
     *
     * @param type $context
     */
    public function autoCompleteTema(&$context)
    {
        $module = SAGU::getFileModule(__FILE__);

        $sql = 'SELECT descricao
                  FROM aps.tema
                 WHERE temaId = ?';

        $context->setContext(SDatabase::getDefaultDb(), $sql);
    }

    /**
     * Lookup Tema
     *
     * @global type $MIOLO
     * @param type $lookup
     */
    public function lookupTema(&$lookup)
    {
        global $MIOLO;
        $module = MIOLO::_REQUEST('lmodule');

        $MIOLO->uses('classes/sagu.class', 'basic');
        $MIOLO->conf->loadConf($module);
        $MIOLO->page->onLoad("document.{$MIOLO->page->name}.username.focus()");

        // Obtém os filtros:
        $temaId = MIOLO::_REQUEST('temaId');
        $descricao = MIOLO::_REQUEST('descricao');

        $fields = array();
        // Campo código do tema
        $temaIdField = new MTextField('temaId', $temaId, _M('Código', $module), SAGU::getParameter('BASIC', 'FIELD_ID_LOOKUP_SIZE'));
        $temaIdField->setJsHint(_M('Informe o código do tema', $module));
        $fields[] = $temaIdField;

        // Campo descrição
        $descricaoField = new MTextField('descricao', $descricao, _M('Descrição', $module), SAGU::getParameter('BASIC', 'FIELD_DESCRIPTION_LOOKUP_SIZE'));
        $descricaoField->addAttribute('maxlength', '255');
        $descricaoField->setJsHint(_M('Informe a descrição', $module));
        $fields[] = $descricaoField;

        foreach ( $fields as $field )
        {
            $lookup->addFilterField($field);
        }

        $columns = array();
        $columns[] = new MDataGridColumn('temaId', _M('Código', $module), 'left', true, NULL, true);
        $columns[] = new MDataGridColumn('descricao', _M('Descrição', $module), 'left', true, NULL, true);

        $sql = 'SELECT temaId,
                       descricao
                  FROM aps.tema';

        if ( strlen($temaId) > 0 )
        {
            $where .= ' AND temaId = ?';
            $params[] = $temaId;
        }

        if ( strlen($descricao) > 0 )
        {
            $where .= ' AND UNACCENT(descricao) ILIKE UNACCENT(?) ';
            $params[] = $descricao . '%';
        }

        if ( strlen($where) > 0 )
        {
            $sql .= ' WHERE ' . substr($where, 4);
        }

        $sql .= ' ORDER BY temaId';

        if ( strlen($where)  ==  0 )
        {
            $sql .= ' LIMIT 0';
        }

        $sqlObject = new sql();
        $sqlObject->createFrom(SAGU::prepare($sql, $params));

        $lookup->setFilterColumns(SAGU::getParameter('BASIC', 'LOOKUP_FILTER_COLUMNS'));
        $lookup->setLookupGrid(SDatabase::getDefaultDb(), $sqlObject, $columns, _M('Pesquisar', $module), 15, 0);
        $lookup->grid->setIsScrollable();
    }

    /**
     * Auto complete Residente
     *
     * @param type $context
     */
    public function autoCompleteResidente(&$context)
    {
        $module = SAGU::getFileModule(__FILE__);

        $sql = "SELECT PP.name AS residenteName,
                       R.enfaseId,
                       R.nucleoProfissionalId,
                       TO_CHAR(R.inicio, '" . SAGU::getParameter('BASIC', 'MASK_DATE') . "') AS inicio,
                       TO_CHAR(R.fimPrevisto, '" . SAGU::getParameter('BASIC', 'MASK_DATE') . "') AS fimPrevisto
                  FROM aps.residente R
       INNER JOIN ONLY basPhysicalPerson PP
                    ON R.personId = PP.personId
                 WHERE R.residenteId = ?";

        $context->setContext(SDatabase::getDefaultDb(), $sql);
    }

    /**
     * Lookup Residente
     *
     * @global type $MIOLO
     * @param type $lookup
     */
    public function lookupResidente(&$lookup)
    {
        global $MIOLO;
        $module = MIOLO::_REQUEST('lmodule');

        $MIOLO->uses('classes/sagu.class', 'basic');
        $MIOLO->conf->loadConf($module);
        $MIOLO->page->onLoad("document.{$MIOLO->page->name}.username.focus()");

        // Obtém os filtros:
        $residenteId = MIOLO::_REQUEST('residenteId');
        $residenteName = MIOLO::_REQUEST('residenteName');
        $enfaseId = MIOLO::_REQUEST('enfaseId');
        $nucleoProfissionalId = MIOLO::_REQUEST('nucleoProfissionalId');
        $inicio = MIOLO::_REQUEST('inicio');
        $fimPrevisto = MIOLO::_REQUEST('fimPrevisto');

        $fields = array();
        // Campo código do residente
        $residenteIdField = new MTextField('residenteId', $residenteId, _M('Código do residente', $module), SAGU::getParameter('BASIC', 'FIELD_ID_LOOKUP_SIZE'));
        $residenteIdField->setJsHint(_M('Informe o residenteId', $module));
        $fields[] = $residenteIdField;

        // Campo nome do residente
        $residenteNameField = new MTextField('residenteName', $residenteName, _M('Nome do residente', $module), SAGU::getParameter('BASIC', 'FIELD_DESCRIPTION_LOOKUP_SIZE'));
        $residenteNameField->setJsHint(_M('Informe o nome do residenteId', $module));
        $fields[] = $residenteNameField;

        // Campo ênfase
        $enfaseIdField = new MSelection('enfaseId', $enfaseId, _M('Ênfase'), ApsEnfase::listRecords());
        $enfaseIdField->setJsHint(_M('Informe a ênfase'));
        $fields[] = $enfaseIdField;

        // Campo núcleo profissional
        $nucleoProfissionalIdField = new MSelection('nucleoProfissionalId', $nucleoProfissionalId, _M('Núcleo profissional'), ApsNucleoProfissional::listRecords());
        $nucleoProfissionalIdField->setJsHint(_M('Informe o núcleo profissional'));
        $fields[] = $nucleoProfissionalIdField;

        // Campo início
        $inicioField = new MCalendarField('inicio', $inicio, _M('Início', $module), SAGU::getParameter('BASIC', 'FIELD_DATE_LOOKUP_SIZE'));
        $inicioField->setJsHint(_M('Informe o início', $module));
        $fields[] = $inicioField;

        // Campo fim previsto
        $fimPrevistoField = new MCalendarField('fimPrevisto', $fimPrevisto, _M('Fim previsto', $module), SAGU::getParameter('BASIC', 'FIELD_DATE_LOOKUP_SIZE'));
        $fimPrevistoField->setJsHint(_M('Informe o fimPrevisto', $module));
        $fields[] = $fimPrevistoField;

        foreach ( $fields as $field )
        {
            $lookup->addFilterField($field);
        }

        $columns = array();
        $columns[] = new MDataGridColumn('residenteId', _M('Código do residente', $module), 'right', true, NULL, true);
        $columns[] = new MDataGridColumn('residenteName', _M('Nome do residente', $module), 'left', true, NULL, true);
        $columns[] = new MDataGridColumn('enfaseId', _M('Ênfase'), 'left', true, NULL, true, ApsEnfase::listRecords());
        $columns[] = new MDataGridColumn('nucleoProfissionalId', _M('Núcleo profissional'), 'left', true, NULL, true, ApsNucleoProfissional::listRecords());
        $columns[] = new MDataGridColumn('inicio', _M('Início', $module), 'left', true, NULL, true);
        $columns[] = new MDataGridColumn('fimPrevisto', _M('Fim previsto', $module), 'left', true, NULL, true);

        $sql = "SELECT R.residenteId,
                       PP.name AS residenteName,
                       R.enfaseId,
                       R.nucleoProfissionalId,
                       TO_CHAR(R.inicio, '" . SAGU::getParameter('BASIC', 'MASK_DATE') . "') AS inicio,
                       TO_CHAR(R.fimPrevisto, '" . SAGU::getParameter('BASIC', 'MASK_DATE') . "') AS fimPrevisto
                  FROM aps.residente R
                  INNER JOIN ONLY basPhysicalPerson PP
                    ON R.personId = PP.personId
                  INNER JOIN aps.enfase E
                    ON R.enfaseid = E.enfaseid";

        $where = '';
        $params = array();
        if ( strlen($residenteId) > 0 )
        {
            $where .= ' AND R.residenteId = ?';
            $params[] = $residenteId;
        }

        if ( strlen($residenteName) > 0 )
        {
            $where .= ' AND PP.name ILIKE ?';
            $params[] = $residenteName . '%';
        }

        if ( strlen($enfaseId) > 0 )
        {
            $where .= ' AND R.enfaseId = ?';
            $params[] = $enfaseId;
        }

        if ( strlen($nucleoProfissionalId) > 0 )
        {
            $where .= ' AND R.nucleoProfissionalId = ?';
            $params[] = $nucleoProfissionalId;
        }

        if ( strlen($inicio) > 0 )
        {
            $where .= ' AND R.inicio = TO_DATE(?, \''.SAGU::getParameter('BASIC', 'MASK_DATE').'\')';
            $params[] = $inicio;
        }

        if ( strlen($fimPrevisto) > 0 )
        {
            $where .= ' AND R.fimPrevisto = TO_DATE(?, \''.SAGU::getParameter('BASIC', 'MASK_DATE').'\')';
            $params[] = $fimPrevisto;
        }


        $usuario = ApsTurma::retornaAdminDaTurmaResidencia();
        if ( $usuario )
        {
            $where .= " AND R.turmaid in (SELECT AA.turmaid FROM aps.turmaresponsavel AA WHERE AA.responsavel = ?)";
            $params[] = $usuario;
        }

        if ( strlen($where) > 0 )
        {
            $sql .= ' WHERE ' . substr($where, 4);
        }

        $sql .= ' ORDER BY residenteId';

        if ( strlen($where)  ==  0 )
        {
            $sql .= ' LIMIT 0';
        }

        $sqlObject = new sql();
        $sqlObject->createFrom(SAGU::prepare($sql, $params));

        $lookup->setFilterColumns(SAGU::getParameter('BASIC', 'LOOKUP_FILTER_COLUMNS'));
        $lookup->setLookupGrid(SDatabase::getDefaultDb(), $sqlObject, $columns, _M('Pesquisar', $module), 15, 0);
        $lookup->grid->setIsScrollable();
    }

    public function autoCompleteCargahorariacomplementarresidency(&$context)
    {
        $module = SAGU::getFileModule(__FILE__);
        $sql = 'SELECT aps.cargahorariacomplementarid,
                       aps.tipodecargahorariacomplementarid,
                       aps.unidadetematicaid,
                       aps.residenteid,
                       aps.cargahoraria,
                       aps.justificativa
                  FROM aps.cargahorariacomplementar
                 WHERE aps.cargahorariacomplementarid = ?';
        $context->setContext(SDatabase::getDefaultDb(), $sql);
    }

    public function lookupCargahorariacomplementarresidency(&$lookup)
    {
        global $MIOLO;
        $module = MIOLO::_REQUEST('lmodule');
        $MIOLO->uses('classes/sagu.class', 'basic');
        $MIOLO->conf->loadConf($module);
        $MIOLO->page->onLoad("document.{$MIOLO->page->name}.userName.focus()");
        $fields[] = $cargaHorariaComplementarId = new MTextField('cargaHorariaComplementarId', '', _M('cargaHorariaComplementarId', $module), SAGU::getParameter('FIELD_ID_LOOKUP_SIZE'));
        $cargaHorariaComplementarId->setJsHint(_M('Informe o cargaHorariaComplementarId', $module));
        $opts = array('label'=>_M('tipoDeCargahorariacomplementarid', $module), 'item'=>'Tipodecargahorariacomplementar', 'module'=>'aps', 'related'=>array('tipoDeCargahorariacomplementaridDescription'), );
        $fields[] = new SLookupContainer('tipoDeCargahorariacomplementarid', $data->tipoDeCargahorariacomplementarid, $opts);
        $opts = array('label'=>_M('unidadeTematicaId', $module), 'item'=>'Unidadetematica', 'module'=>'aps', 'related'=>array('unidadeTematicaIdDescription'), );
        $fields[] = new SLookupContainer('unidadeTematicaId', $data->unidadeTematicaId, $opts);
        $opts = array('label'=>_M('residenteId', $module), 'item'=>'Residente', 'module'=>'aps', 'related'=>array('residenteIdDescription'), );
        $fields[] = new SLookupContainer('residenteId', $data->residenteId, $opts);
        $fields[] = $cargaHoraria = new MTextField('cargaHoraria', '', _M('cargaHoraria', $module), SAGU::getParameter('FIELD_MONETARY_SIZE'));
        $cargaHoraria->setJsHint(_M('Informe o cargaHoraria', $module));
        $fields[] = $justificativa = new MTextField('justificativa', '', _M('justificativa', $module), SAGU::getParameter('FIELD_DESCRIPTION_LOOKUP_SIZE'));
        $justificativa->addAttribute('maxlength', '255');
        $justificativa->setJsHint(_M('Informe o justificativa', $module));

        foreach ( $fields  as  $field )
        {
            $lookup->addFilterField($field);
        }

        $columns[] = new MDataGridColumn('userName', _M('userName', $module), 'left', true, NULL, true);
        $columns[] = new MDataGridColumn('dateTime', _M('dateTime', $module), 'left', true, NULL, true);
        $columns[] = new MDataGridColumn('ipAddress', _M('ipAddress', $module), 'left', true, NULL, true);
        $columns[] = new MDataGridColumn('cargaHorariaComplementarId', _M('cargaHorariaComplementarId', $module), 'left', true, NULL, true);
        $columns[] = new MDataGridColumn('tipoDeCargahorariacomplementarid', _M('tipoDeCargahorariacomplementarid', $module), 'left', true, NULL, true);
        $columns[] = new MDataGridColumn('unidadeTematicaId', _M('unidadeTematicaId', $module), 'left', true, NULL, true);
        $columns[] = new MDataGridColumn('residenteId', _M('residenteId', $module), 'left', true, NULL, true);
        $columns[] = new MDataGridColumn('cargaHoraria', _M('cargaHoraria', $module), 'left', true, NULL, true);
        $columns[] = new MDataGridColumn('justificativa', _M('justificativa', $module), 'left', true, NULL, true);
        $sql = 'SELECT aps.cargahorariacomplementarid,
                       aps.tipodecargahorariacomplementarid,
                       aps.unidadetematicaid,
                       aps.residenteid,
                       aps.cargahoraria,
                       aps.justificativa
                  FROM aps.cargahorariacomplementar';

        if ( strlen($cargaHorariaComplementarId)  >  0 )
        {
            $where.=' AND aps.cargahorariacomplementarid = ?';
            $args[] = $cargaHorariaComplementarId;
        }

        if ( strlen($tipoDeCargahorariacomplementarid)  >  0 )
        {
            $where.=' AND aps.tipodecargahorariacomplementarid = ?';
            $args[] = $tipoDeCargahorariacomplementarid;
        }

        if ( strlen($unidadeTematicaId)  >  0 )
        {
            $where.=' AND aps.unidadetematicaid = ?';
            $args[] = $unidadeTematicaId;
        }

        if ( strlen($residenteId)  >  0 )
        {
            $where.=' AND aps.residenteid = ?';
            $args[] = $residenteId;
        }

        if ( strlen($cargaHoraria)  >  0 )
        {
            $where.=' AND aps.cargahoraria = ?';
            $args[] = $cargaHoraria;
        }

        if ( strlen($justificativa)  >  0 )
        {
            $where.=' AND UNACCENT(aps.justificativa) ILIKE UNACCENT(?) ';
            $args[] = $justificativa.'%';
        }

        if ( strlen($where)  >  0 )
        {
            $sql.=$where;
        }

        $sql.=' ORDER BY aps.cargahorariacomplementarid';

        if ( strlen($where)  ==  0 )
        {
            $sql.=' LIMIT 0';
        }

        $sqlObject = new sql();
        $sqlObject->createFrom(SAGU::prepare($sql, $args));
        $lookup->setFilterColumns(SAGU::getParameter('BASIC', 'LOOKUP_FILTER_COLUMNS'));
        $lookup->setLookupGrid(SDatabase::getDefaultDb(), $sqlObject, $columns, _M('Pesquisar', $module), 15, 0);
        $lookup->grid->setIsScrollable();
    }

    public function autoCompleteOfertaDoResidenteresidency(&$context)
    {
        $module = SAGU::getFileModule(__FILE__);
        $sql = 'SELECT aps.ofertadoresidenteid,
                       aps.residenteid,
                       aps.ofertadeunidadetematicaid
                  FROM aps.ofertadoresidente
                 WHERE aps.ofertadoresidenteid = ?';
        $context->setContext(SDatabase::getDefaultDb(), $sql);
    }

    public function lookupOfertaDoResidenteresidency(&$lookup)
    {
        global $MIOLO;
        $module = MIOLO::_REQUEST('lmodule');
        $MIOLO->uses('classes/sagu.class', 'basic');
        $MIOLO->conf->loadConf($module);
        $MIOLO->page->onLoad("document.{$MIOLO->page->name}.userName.focus()");
        $fields[] = $ofertaDoResidenteId = new MTextField('ofertaDoResidenteId', '', _M('ofertaDoResidenteId', $module), SAGU::getParameter('FIELD_ID_LOOKUP_SIZE'));
        $ofertaDoResidenteId->setJsHint(_M('Informe o ofertaDoResidenteId', $module));
        $opts = array('label'=>_M('residenteId', $module), 'item'=>'Residente', 'module'=>'aps', 'related'=>array('residenteIdDescription'), );
        $fields[] = new SLookupContainer('residenteId', $data->residenteId, $opts);
        $opts = array('label'=>_M('ofertaDeUnidadeTematicaId', $module), 'item'=>'Ofertadeunidadetematica', 'module'=>'aps', 'related'=>array('ofertaDeUnidadeTematicaIdDescription'), );
        $fields[] = new SLookupContainer('ofertaDeUnidadeTematicaId', $data->ofertaDeUnidadeTematicaId, $opts);

        foreach ( $fields  as  $field )
        {
            $lookup->addFilterField($field);
        }

        $columns[] = new MDataGridColumn('userName', _M('userName', $module), 'left', true, NULL, true);
        $columns[] = new MDataGridColumn('dateTime', _M('dateTime', $module), 'left', true, NULL, true);
        $columns[] = new MDataGridColumn('ipAddress', _M('ipAddress', $module), 'left', true, NULL, true);
        $columns[] = new MDataGridColumn('ofertaDoResidenteId', _M('ofertaDoResidenteId', $module), 'left', true, NULL, true);
        $columns[] = new MDataGridColumn('residenteId', _M('residenteId', $module), 'left', true, NULL, true);
        $columns[] = new MDataGridColumn('ofertaDeUnidadeTematicaId', _M('ofertaDeUnidadeTematicaId', $module), 'left', true, NULL, true);
        $sql = 'SELECT aps.ofertadoresidenteid,
                       aps.residenteid,
                       aps.ofertadeunidadetematicaid
                  FROM aps.ofertadoresidente';

        if ( strlen($ofertaDoResidenteId)  >  0 )
        {
            $where.=' AND aps.ofertadoresidenteid = ?';
            $args[] = $ofertaDoResidenteId;
        }

        if ( strlen($residenteId)  >  0 )
        {
            $where.=' AND aps.residenteid = ?';
            $args[] = $residenteId;
        }

        if ( strlen($ofertaDeUnidadeTematicaId)  >  0 )
        {
            $where.=' AND aps.ofertadeunidadetematicaid = ?';
            $args[] = $ofertaDeUnidadeTematicaId;
        }

        if ( strlen($where)  >  0 )
        {
            $sql.=$where;
        }

        $sql.=' ORDER BY aps.ofertadoresidenteid';

        if ( strlen($where)  ==  0 )
        {
            $sql.=' LIMIT 0';
        }

        $sqlObject = new sql();
        $sqlObject->createFrom(SAGU::prepare($sql, $args));
        $lookup->setFilterColumns(SAGU::getParameter('BASIC', 'LOOKUP_FILTER_COLUMNS'));
        $lookup->setLookupGrid(SDatabase::getDefaultDb(), $sqlObject, $columns, _M('Pesquisar', $module), 15, 0);
        $lookup->grid->setIsScrollable();
    }


    public function autoCompleteTrabalhoDeConclusaoresidency(&$context)
    {
        $module = SAGU::getFileModule(__FILE__);
        $sql = 'SELECT aps.trabalhodeconclusaoid,
                       aps.orientadorid,
                       aps.residenteid,
                       aps.titulo,
                       aps.tema
                  FROM aps.trabalhodeconclusao
                 WHERE aps.trabalhodeconclusaoid = ?';
        $context->setContext(SDatabase::getDefaultDb(), $sql);
    }

    public function lookupTrabalhoDeConclusaoresidency(&$lookup)
    {
        global $MIOLO;
        $module = MIOLO::_REQUEST('lmodule');
        $MIOLO->uses('classes/sagu.class', 'basic');
        $MIOLO->conf->loadConf($module);
        $MIOLO->page->onLoad("document.{$MIOLO->page->name}.userName.focus()");
        $fields[] = $trabalhoDeConclusaoId = new MTextField('trabalhoDeConclusaoId', '', _M('trabalhoDeConclusaoId', $module), SAGU::getParameter('FIELD_ID_LOOKUP_SIZE'));
        $trabalhoDeConclusaoId->setJsHint(_M('Informe o trabalhoDeConclusaoId', $module));
        $opts = array('label'=>_M('orientadorId', $module), 'item'=>'Physicalperson', 'module'=>'basic', 'related'=>array('orientadorIdDescription'), );
        $fields[] = new SLookupContainer('orientadorId', $data->orientadorId, $opts);
        $opts = array('label'=>_M('residenteId', $module), 'item'=>'Residente', 'module'=>'aps', 'related'=>array('residenteIdDescription'), );
        $fields[] = new SLookupContainer('residenteId', $data->residenteId, $opts);
        $fields[] = $titulo = new MTextField('titulo', '', _M('titulo', $module), SAGU::getParameter('FIELD_DESCRIPTION_LOOKUP_SIZE'));
        $titulo->addAttribute('maxlength', '255');
        $titulo->setJsHint(_M('Informe o titulo', $module));
        $fields[] = $tema = new MMultilineField('tema', '', _M('tema', $module), SAGU::getParameter('FIELD_DESCRIPTION_LOOKUP_SIZE'), SAGU::getParameter('FIELD_MULTILINE_NUM_ROWS'), SAGU::getParameter('FIELD_MULTILINE_NUM_COLS'));
        $tema->setJsHint(_M('Informe o tema', $module));

        foreach ( $fields  as  $field )
        {
            $lookup->addFilterField($field);
        }

        $columns[] = new MDataGridColumn('userName', _M('userName', $module), 'left', true, NULL, true);
        $columns[] = new MDataGridColumn('dateTime', _M('dateTime', $module), 'left', true, NULL, true);
        $columns[] = new MDataGridColumn('ipAddress', _M('ipAddress', $module), 'left', true, NULL, true);
        $columns[] = new MDataGridColumn('trabalhoDeConclusaoId', _M('trabalhoDeConclusaoId', $module), 'left', true, NULL, true);
        $columns[] = new MDataGridColumn('orientadorId', _M('orientadorId', $module), 'left', true, NULL, true);
        $columns[] = new MDataGridColumn('residenteId', _M('residenteId', $module), 'left', true, NULL, true);
        $columns[] = new MDataGridColumn('titulo', _M('titulo', $module), 'left', true, NULL, true);
        $columns[] = new MDataGridColumn('tema', _M('tema', $module), 'left', true, NULL, true);
        $sql = 'SELECT aps.trabalhodeconclusaoid,
                       aps.orientadorid,
                       aps.residenteid,
                       aps.titulo,
                       aps.tema
                  FROM aps.trabalhodeconclusao';

        if ( strlen($trabalhoDeConclusaoId)  >  0 )
        {
            $where.=' AND aps.trabalhodeconclusaoid = ?';
            $args[] = $trabalhoDeConclusaoId;
        }

        if ( strlen($orientadorId)  >  0 )
        {
            $where.=' AND aps.orientadorid = ?';
            $args[] = $orientadorId;
        }

        if ( strlen($residenteId)  >  0 )
        {
            $where.=' AND aps.residenteid = ?';
            $args[] = $residenteId;
        }

        if ( strlen($titulo)  >  0 )
        {
            $where.=' AND UNACCENT(aps.titulo) ILIKE UNACCENT(?) ';
            $args[] = $titulo.'%';
        }

        if ( strlen($tema)  >  0 )
        {
            $where.=' AND UNACCENT(aps.tema) ILIKE UNACCENT(?) ';
            $args[] = $tema.'%';
        }

        if ( strlen($where)  >  0 )
        {
            $sql.=$where;
        }

        $sql.=' ORDER BY aps.trabalhodeconclusaoid';

        if ( strlen($where)  ==  0 )
        {
            $sql.=' LIMIT 0';
        }

        $sqlObject = new sql();
        $sqlObject->createFrom(SAGU::prepare($sql, $args));
        $lookup->setFilterColumns(SAGU::getParameter('BASIC', 'LOOKUP_FILTER_COLUMNS'));
        $lookup->setLookupGrid(SDatabase::getDefaultDb(), $sqlObject, $columns, _M('Pesquisar', $module), 15, 0);
        $lookup->grid->setIsScrollable();
    }

    /**
     * Auto complete for preceptor
     *
     * @param $context (object): MIOLO Context object
     * @return (object): MIOLO Gives the action evaluating the code by setContext call
     */
    public function autoCompletePreceptor(&$context)
    {
        $sql = 'SELECT A.name AS personName,
                       H.name || \' \' || A.location AS location,
                       A.complement,
                       A.neighborhood,
                       A.cityId,
                       B.name AS cityName,
                       B.stateId,
                       B.countryId,
                       C.name AS countryName,
                       D.externalCourseIdHs,
                       E.name,
                       D.institutionIdHs,
                       F.name,
                       D.cityIdHs,
                       G.name,
                       D.yearHs,
                       D.isInsured,
                       D.passive,
                       I.content AS CPF,
                       A.personId
             FROM ONLY basPhysicalPerson A
             LEFT JOIN basCity B
                    ON ( B.cityId = A.cityId )
             LEFT JOIN basCountry C
                    ON ( C.countryId = B.countryId )
             LEFT JOIN basPhysicalPersonStudent D
                    ON ( D.personId = A.personId )
             LEFT JOIN acdExternalCourse E
                    ON (E.externalCourseId = D.externalCourseIdHs)
             LEFT JOIN basLegalPerson F
                    ON (F.personId = D.institutionIdHs)
             LEFT JOIN basCity G
                    ON (G.cityId = D.cityIdHs)
             LEFT JOIN basLocationType H
                    ON (A.locationTypeId = H.locationTypeId)
             LEFT JOIN basDocument I
                    ON (I.personId = A.personId
                        AND I.documentTypeId = ' . SAGU::getParameter('BASIC', 'DEFAULT_DOCUMENT_TYPE_ID_CPF') . ')
                 WHERE EXISTS(SELECT 1
                                FROM aps.ofertaDeUnidadeTematica
                               WHERE A.personId = ?)';

        $context->setContext(SDatabase::getDefaultDb(), $sql);
    }

    /**
     * Lookup for physical person
     *
     * @param $lookup: Lookup Object used by MIOLO
     * @return MIOLO Lookup function as actions evaluated by MIOLO
     */
    public function lookupPreceptor(&$lookup)
    {
        global $MIOLO;
        $module = MIOLO::_request('lmodule');

        $MIOLO->conf->loadConf($module);

        $personId = $lookup->getFilterValue('personId');
        $personName = $lookup->getFilterValue('personName');
        $personLastName = $lookup->getFilterValue('personLastName');
        $cpf = $lookup->getFilterValue('cpf');
        $enfaseId = $lookup->getFilterValue('enfaseId');

        $lookup->addFilterField(new MTextField('personId', $personId, _M('Código', $module), SAGU::getParameter('BASIC', 'FIELD_ID_LOOKUP_SIZE')));
        $lookup->addFilterField(new MTextField('personName', $personName, _M('Nome', $module), SAGU::getParameter('BASIC', 'FIELD_DESCRIPTION_LOOKUP_SIZE')));
        $lookup->addFilterField(new MTextField('personLastName', $personLastName, _M('Sobrenome', $module), SAGU::getParameter('BASIC', 'FIELD_DESCRIPTION_LOOKUP_SIZE')));

        $enfase = new MSelection('enfaseId', $enfaseId, _M('Especialidade'), ApsEnfase::listRecords());
        $lookup->addFilterField($enfase);

        global $page;
        $page->onLoad('document.' . $page->name . '.personName.focus()');

        $columns[] = new MDataGridColumn('personId', _M('Código', $module), 'right', true, null, true);
        $columns[] = new MDataGridColumn('personName', _M('Nome', $module), 'left', true, null, true);
        $columns[] = new MDataGridColumn('location', _M('Logradouro', $module), 'left', true, null, true);
        $columns[] = new MDataGridColumn('complement', _M('Complemento', $module), 'left', true, null, false);
        $columns[] = new MDataGridColumn('neighborhood', _M('Bairro', $module), 'left', true, null, false);
        $columns[] = new MDataGridColumn('cityId', _M('Código da cidade', $module), 'left', true, null, true);
        $columns[] = new MDataGridColumn('cityName', _M('Nome da cidade', $module), 'left', true, null, true);
        $columns[] = new MDataGridColumn('stateId', _M('Estado', $module), 'left', true, null, true);
        $columns[] = new MDataGridColumn('countryId', _M('Código do país', $module), 'left', true, null, false);
        $columns[] = new MDataGridColumn('countryName', _M('País', $module), 'left', true, null, true);
        $columns[] = new MDataGridColumn('cityIdHs', _M('Código da cidade do ensino médio', $module), 'left', true, null, false);
        $columns[] = new MDataGridColumn('cityNameHs', _M('Nome da cidade do ensino médio', $module), 'left', true, null, false);
        $columns[] = new MDataGridColumn('cpf', _M('CPF', $module), 'left', true, null, true);

        $sql = 'SELECT AA.preceptorId,
                       A.name AS personName,
                       H.name || \' \' || A.location AS location,
                       A.complement,
                       A.neighborhood,
                       A.cityId,
                       B.name AS cityName,
                       B.stateId,
                       B.countryId,
                       C.name AS countryName,
                       E.name,
                       F.name,
                       D.cityIdHs,
                       G.name,
                       I.content AS CPF
             FROM ONLY basPhysicalPerson A
             INNER JOIN aps.preceptoria AA
                    ON A.personid = AA.personid
             LEFT JOIN basCity B
                    ON ( B.cityId = A.cityId )
             LEFT JOIN basCountry C
                    ON ( C.countryId = B.countryId )
             LEFT JOIN basPhysicalPersonStudent D
                    ON ( D.personId = A.personId )
             LEFT JOIN acdExternalCourse E
                    ON (E.externalCourseId = D.externalCourseIdHs)
             LEFT JOIN basLegalPerson F
                    ON (F.personId = D.institutionIdHs)
             LEFT JOIN basCity G
                    ON (G.cityId = D.cityIdHs)
             LEFT JOIN basLocationType H
                    ON (A.locationTypeId = H.locationTypeId)
             LEFT JOIN basDocument I
                    ON (I.personId = A.personId
                        AND I.documentTypeId = ' . SAGU::getParameter('BASIC', 'DEFAULT_DOCUMENT_TYPE_ID_CPF') . ')
             INNER JOIN aps.enfase EN ON AA.enfaseid = EN.enfaseid

                        ';

        if ( strlen($personId) > 0 )
        {
            $where .= ' AND A.personId = ?';
            $args[] = $personId;
        }

        if ( strlen($personName) > 0 )
        {
            $where .= ' AND UNACCENT(A.name) ILIKE UNACCENT(?)';
            $args[] = $personName . '%';
        }

        if ( strlen($personLastName) > 0 )
        {
            $where .= ' AND UNACCENT(A.name) ILIKE UNACCENT(?)';
            $args[] = '%' . $personLastName . '%';
        }

        if ( strlen($cpf) > 0 )
        {
            $where .= ' AND I.content = ?';
            $args[] = $cpf;
        }

        if ( strlen($enfaseId) > 0 )
        {
            $where .= ' AND AA.enfaseid = ?';
            $args[] = $enfaseId;
        }

        $usuario = ApsEnfase::retornaAdminDaEspecialidadeResidenciaMedica();
        if ( $usuario )
        {
            $where .= " AND EN.enfaseid in (SELECT AA.enfaseid FROM aps.enfaseresponsavel AA WHERE AA.responsavel = ?)";
            $args[] = $usuario;
        }

        if ( strlen($where) > 0 )
        {
            $sql .= ' WHERE ' . substr($where, 5) . ' ORDER BY A.name';
        }
        else
        {
            $sql .= ' LIMIT 0';
        }

        $sqlObject = new sql();
        $sqlObject->createFrom(SAGU::prepare($sql,$args));
        $lookup->setFilterColumns(SAGU::getParameter('BASIC', 'LOOKUP_FILTER_COLUMNS'));
        $lookup->setLookupGrid(SDatabase::getDefaultDb(), $sqlObject, $columns, _M('Localizar preceptor',$module), 15, 0);
        $lookup->grid->setIsScrollable();
        //$lookup->grid->header[] = '<b><center><a href="' . $MIOLO->getActionURL('basic', 'preceptorLookup', '', $_GET) . '">' . _M('Inserir novo', 'basic') . '</a></center></b><br>';
    }

    public function autoCompleteTurma(&$context)
    {
        $sql = " SELECT A.descricao as nomeTurma,
                        B.descricao as nucleoProfissional,
                        C.descricao as enfase,
                        A.quantidaDePeriodo,
                        datetouser(A.dataInicio) as datainicio,
                        datetouser(A.dataFim) as datafim,
                        vagas
                   FROM aps.turma A
              LEFT JOIN aps.nucleoProfissional B
                     ON (A.nucleoProfissionalId = B.nucleoProfissionalId)
              LEFT JOIN aps.enfase C
                     ON (A.enfaseId = C.enfaseId)
                  WHERE A.turmaid = ? ";

        $context->setContext(SDatabase::getDefaultDb(), $sql);
    }

    public function lookupTurma(&$lookup)
    {
        global $MIOLO;
        $module = MIOLO::_request('lmodule');

        $MIOLO->conf->loadConf($module);

        $nomeTurma = $lookup->getFilterValue('nomeTurma');
        $nucleoProfissional = $lookup->getFilterValue('nucleoProfissional');
        $enfase = $lookup->getFilterValue('enfase');

        $lookup->addFilterField(new MTextField('nomeTurma', $nomeTurma, _M('Nome da turma', $module), SAGU::getParameter('BASIC', 'FIELD_DESCRIPTION_LOOKUP_SIZE')));
        $lookup->addFilterField(new MSelection('nucleoProfissional', $nucleoProfissional, _M('Categoria profissional'), ApsNucleoProfissional::listRecords()));
        $lookup->addFilterField(new MSelection('enfase', $enfase, _M('Especialidade'), ApsEnfase::listRecords()));

        global $page;
        $page->onLoad('document.' . $page->name . '.codigoTurma.focus()');

        $columns[] = new MDataGridColumn('turmaid', _M('Código da turma', $module), 'right', true, null, true);
        $columns[] = new MDataGridColumn('nomeTurma', _M('Nome da turma', $module), 'left', true, null, true);
        $columns[] = new MDataGridColumn('nucleoProfissional', _M('Núcleo profissional'), 'left', true, null, true);
        $columns[] = new MDataGridColumn('enfase', _M('Ênfase'), 'left', true, null, false);
        $columns[] = new MDataGridColumn('quantidaDePeriodo', _M('Perído de duração', $module), 'left', true, null, false);
        $columns[] = new MDataGridColumn('datainicio', _M('Data inicial', $module), 'left', true, null, true);
        $columns[] = new MDataGridColumn('datafim', _M('Data final', $module), 'left', true, null, true);
        $columns[] = new MDataGridColumn('vagas', _M('Vagas', $module), 'left', true, null, true);

        $sql = " SELECT A.turmaid,
                        A.descricao as nomeTurma,
                        B.descricao as nucleoProfissional,
                        C.descricao as enfase,
                        A.quantidaDePeriodo,
                        datetouser(A.dataInicio) as datainicio,
                        datetouser(A.dataFim) as datafim,
                        vagas
                   FROM aps.turma A
              LEFT JOIN aps.nucleoProfissional B
                     ON (A.nucleoProfissionalId = B.nucleoProfissionalId)
              LEFT JOIN aps.enfase C
                     ON (A.enfaseId = C.enfaseId) ";

        if ( strlen($nomeTurma) > 0 )
        {
            $where .= ' AND A.descricao ILIKE ? ';
            $args[] = '%' . $nomeTurma . '%';
        }

        if ( strlen($nucleoProfissional) > 0 )
        {
            $where .= ' AND B.nucleoProfissionalId = ? ';
            $args[] = $nucleoProfissional;
        }

        if ( strlen($enfase) > 0 )
        {
            $where .= ' AND C.enfaseId = ? ';
            $args[] = $enfase;
        }

        $usuario = ApsTurma::retornaAdminDaTurmaResidencia();
        if ( $usuario )
        {
            $where .= " AND A.turmaid in (SELECT AA.turmaid FROM aps.turmaresponsavel AA WHERE AA.responsavel = ?)";
            $args[] = $usuario;
        }
        if ( strlen($where) > 0 )
        {
            $sql .= ' WHERE ' . substr($where, 5);
        }

        $sqlObject = new sql();
        $sqlObject->createFrom(SAGU::prepare($sql, $args));
        $lookup->setFilterColumns(SAGU::getParameter('BASIC', 'LOOKUP_FILTER_COLUMNS'));
        $lookup->setLookupGrid(SDatabase::getDefaultDb(), $sqlObject, $columns, _M('Pesquisar', $module), 15, 0);
        $lookup->grid->setIsScrollable();
    }

    public function lookupInstituicaoExecutora(&$lookup)
    {
        global $MIOLO;
        $module = MIOLO::_REQUEST('lmodule');
        $MIOLO->conf->loadConf($module);

        $personId = $lookup->getFilterValue('personId');
        $personName = $lookup->getFilterValue('personName') == '' ? '%' : $lookup->getFilterValue('personName');
        $location = $lookup->getFilterValue('location');
        $complement = $lookup->getFilterValue('complement');
        $neighborhood = $lookup->getFilterValue('neighborhood');
        $cityId = $lookup->getFilterValue('cityId');
        $cityName = $lookup->getFilterValue('cityName');
        $stateId = $lookup->getFilterValue('stateId');
        $countryId = $lookup->getFilterValue('countryId');
        $countryName = $lookup->getFilterValue('countryName');
        $legalPersonTypeId = $lookup->getFilterValue('legalPersonTypeId');

        $lookup->addFilterField(new MTextField('personId', $personId, _M('Código', $module), SAGU::getParameter('BASIC', 'FIELD_ID_LOOKUP_SIZE')));
        $lookup->addFilterField(new MTextField('personName', $personName, _M('Nome', $module), SAGU::getParameter('BASIC', 'FIELD_DESCRIPTION_LOOKUP_SIZE')));
        $lookup->addFilterField(new MTextField('location', $location, _M('Logradouro', $module), SAGU::getParameter('BASIC', 'FIELD_DESCRIPTION_LOOKUP_SIZE')));
        $lookup->addFilterField(new MTextField('cityName', $cityName, _M('Cidade', $module), SAGU::getParameter('BASIC', 'FIELD_DESCRIPTION_LOOKUP_SIZE')));
        $lookup->addFilterField(fields::country($countryId));
        $lookup->addFilterField(fields::legalLegalPersonType());

        global $page;
        $page->onLoad('document.' . $page->name . '.personName.focus()');

        $columns[] = new DataGridColumn('personId', _M('Código', $module), 'right', true, null, true);
        $columns[] = new DataGridColumn('personName', _M('Nome', $module), 'left', true, null, true);
        $columns[] = new DataGridColumn('location', _M('Logradouro', $module), 'left', true, null, true);
        $columns[] = new DataGridColumn('complement', _M('Complemento', $module), 'left', true, null, false);
        $columns[] = new DataGridColumn('neighborhood', _M('Bairro', $module), 'left', true, null, false);
        $columns[] = new DataGridColumn('cityId', _M('Código da cidade', $module), 'left', true, null, true);
        $columns[] = new DataGridColumn('cityName', _M('Nome da cidade', $module), 'left', true, null, true);
        $columns[] = new DataGridColumn('stateId', _M('Estado', $module), 'left', true, null, true);
        $columns[] = new DataGridColumn('countryId', _M('Código do país', $module), 'left', true, null, false);
        $columns[] = new DataGridColumn('countryName', _M('País', $module), 'left', true, null, true);
        $columns[] = new DataGridColumn('legalPersonTypeId', _M('Tipo de pessoa jurídica', $module), 'left', true, null, true);

        $sql = 'SELECT A.personId,
                       A.name AS personName,
                       D.name || \' \' || A.location AS location,
                       A.complement,
                       A.neighborhood,
                       A.cityId,
                       B.name AS cityName,
                       B.stateId,
                       B.countryId,
                       C.name AS countryName
             FROM ONLY basLegalPerson A
             LEFT JOIN basCity B
                    ON ( B.cityId = A.cityId )
             LEFT JOIN basCountry C
                    ON ( C.countryId = B.countryId )
             LEFT JOIN basLocationType D
                    ON (A.locationTypeId = D.locationTypeId)';

        if ( strlen($personId) > 0 )
        {
            $where .= ' AND A.personId = ?';
            $args[] = $personId;
        }

        if ( strlen($personName) > 0 )
        {
            $where .= ' AND ( UNACCENT(A.name) ILIKE UNACCENT(?) OR UNACCENT(A.shortName) ILIKE UNACCENT(?) OR UNACCENT(A.fakeName) ILIKE UNACCENT(?) )';
            $args[] = $personName . '%';
            $args[] = $personName . '%';
            $args[] = $personName . '%';
        }

        if ( strlen($location) > 0 )
        {
            $where .= ' AND UNACCENT(A.location) ILIKE UNACCENT(?)';
            $args[] = $location . '%';
        }

        if ( strlen($complement) > 0 )
        {
            $where .= ' AND A.complement ILIKE ?';
            $args[] = $complement . '%';
        }

        if ( strlen($neighborhood) > 0 )
        {
            $where .= ' AND UNACCENT(A.neighborhood) ILIKE UNACCENT(?)';
            $args[] = $neighborhood . '%';
        }

        if ( strlen($cityId) > 0 )
        {
            $where .= ' AND A.cityId = ?';
            $args[] = $cityId;
        }

        if ( strlen($cityName) > 0 )
        {
            $where .= ' AND UNACCENT(B.name) ILIKE UNACCENT(?)';
            $args[] = $cityName . '%';
        }

        if ( strlen($stateId) > 0 )
        {
            $where .= ' AND B.stateId ILIKE ?';
            $args[] = $stateId;
        }

        if ( strlen($countryId) > 0 )
        {
            $where .= ' AND C.countryId = ?';
            $args[] = $countryId;
        }

        if ( strlen($countryName) > 0 )
        {
            $where .= ' AND UNACCENT(C.name) ILIKE UNACCENT(?)';
            $args[] = $countryName . '%';
        }
        if ( strlen($legalPersonTypeId) > 0 )
        {
            $where .= ' AND A.legalPersonTypeId = ?';
            $args[] = $legalPersonTypeId;
        }

        if ( strlen($where) > 0 )
        {
            $sql .= ' WHERE ' . substr($where, 5) . '
                   ORDER BY A.name';
        }
        else
        {
            $sql .= ' LIMIT 0';
        }

        $sqlObject = new sql();
        $sqlObject->createFrom(SAGU::prepare($sql,$args));
        $lookup->setFilterColumns(SAGU::getParameter('BASIC', 'LOOKUP_FILTER_COLUMNS'));
        $lookup->setLookupGrid(SDatabase::getDefaultDb(), $sqlObject, $columns, _M('Localizar pessoa jurídica',$module), 15, 0);
        $lookup->grid->setIsScrollable();
    }
}
?>