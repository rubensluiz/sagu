<?php

/**
 * Database exception class
 * This exception is generated on throwError method at PostgresConnection
 *
 * @author Daniel Hartmann [daniel@solis.coop.br]
 *
 * @version $id$
 *
 * \b Maintainers: \n
 * Armando Taffarel Neto [taffarel@solis.coop.br]
 * Daniel Hartmann [daniel@solis.coop.br]
 *
 * @since
 * Creation date 2010/10/11
 *
 * \b Organization: \n
 * SOLIS - Cooperativa de Soluções Livres \n
 *
 * \b CopyRight: \n
 * Copyright (c) 2010 SOLIS - Cooperativa de Soluções Livres \n
 *
 * \b License: \n
 * Licensed under GPLv2 (for further details read the COPYING file or http://www.gnu.org/licenses/gpl.html)
 *
 * \b History: \n
 * See history in CVS repository: http://www.miolo.org.br
 *
 */
class MDatabaseException extends Exception
{
    /**
     * Erro retornado pelo servidor SQL
     *
     * @var string
     */
    private $sqlError;
    
    const UNKNOWN_ERROR_CODE = 0;
    const KNOWN_ERROR_CODE = 1; // Error code for treated messages

    /**
     * Generate the error message according to the cause
     *
     * @param (string) $svnInfo
     * @return (string) Message
     */
    public function generateMessage($svnInfo = '')
    {
        $MIOLO = MIOLO::getInstance();
        switch ( $this->code )
        {
            case self::KNOWN_ERROR_CODE:

                $message = ucfirst($this->getMessage());

                $trace = $this->getTrace();
                $query = $trace[3]['args'][0];

                $message .= '<br /><br />' . _M('Query') . ": $query" . '<br /><br />';
//                    $message .= str_replace("\n", '<br />', $svnInfo);
                
                if ( strlen($this->getSqlError()) > 0 )
                {
                    $message .= $this->getSqlError() . '<br /><br />';
                }
                
                // exibe o trace de codigo
                $message .= MForm::expansibleText(_M('Exibir trace'), _M('Ocultar trace'), $this->getTraceAsString());

                break;


            case self::UNKNOWN_ERROR_CODE:
            default:

                $message = _M('Database error occurred') . '<br /><br />';
                $message .= str_replace("\n", '<br />', ucfirst($this->getMessage()));

                if ( MUtil::getBooleanValue($MIOLO->getConf('options.backtrace')) )
                {
                    $trace = $this->getTrace();
                    $query = $trace[3]['args'][0];

                    $message .= '<br /><br />' . _M('Query') . ": $query" . '<br /><br />';
                    $message .= str_replace("\n", '<br />', $this->getTraceAsString()) . '<br /><br />';
                    $message .= str_replace("\n", '<br />', $svnInfo);
                }
        }

        return $message;
    }

    /**
     * Used in unittest errors, makes the MDatabaseException echoable and printable
     *
     * @return String   Error message
     */
    public function __toString()
    {
        $MIOLO = MIOLO::getInstance();

        $trace = $this->getTrace();
        $query = $trace[3]['args'][0];

        $message = ucfirst($this->getMessage());
        $message .= "\n\n" . _M('Query') . ": $query";

        if ( MUtil::getBooleanValue($MIOLO->getConf('options.backtrace')) )
        {
            $message .= "\n\n" . $this->getTraceAsString();
        }

        return $message;
    }

    public function getSqlError() {
        return $this->sqlError;
    }

    public function setSqlError($sqlError) {
        $this->sqlError = $sqlError;
    }
}
?>
