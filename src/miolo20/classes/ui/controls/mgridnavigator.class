<?php
define('PN_PAGE', 'pn_page');
/**
 * Uma implementação de controles de navagação de páginas para grids
 */
class MGridNavigator extends MControl
{
    var $pageLength;
    var $pageNumber;
    var $action;
    var $range;
    var $rowCount;
    var $gridCount;
    var $pageCount;
    var $idxFirst;
    var $idxLast;
    var $showPageNo = false;
    var $linktype; // hyperlink or linkbutton
    var $grid;

    function __construct($length = 20, // Number of records per page
                           $total = 0,   // Number total of records 
                           $action = '?', // Action URL
                           $grid = NULL// The grid which contains this component
        )
    {
        global $state;

        parent::__construct();
        $this->pageLength = $length;
        $this->gridCount = $length;
        $this->SetRowCount($total);
        $this->grid = $grid;
/*
        if (urldecode($this->page->Request('gridName')) == $this->grid->name)
        {
          $this->SetPageNumber($this->page->Request(PN_PAGE));
          $state->set('pn_page', $this->page->Request(PN_PAGE), $this->grid->name);
        }
        else
        {
          $this->SetPageNumber($state->get('pn_page', $this->grid->name));
        }
*/

        $this->SetPageNumber( $state->get('pn_page', $this->grid->name) );


//        $this->grid->pageNumber = MUtil::NVL($state->get('pn_page', $this->grid->name),1);
//        $this->grid->prevPage = MUtil::NVL($state->get('grid_page', $this->grid->name),1);

//        $this->grid->HandlerSelecteds();

//        $state->set('grid_page', $this->getPageNumber(), $this->grid->name);

        $this->action = $action;
        $this->linktype = 'hyperlink';

    }

    function SetAction($url)
    {
        $this->action = $url;
    }

    function SetLinkType($linktype)
    {
        $this->linktype = $linktype;
    }

    function SetRowCount($rowCount)
    {
        $this->rowCount = $rowCount;
        $this->pageCount = ($this->pageLength > 0) ? (int)(($this->rowCount + $this->pageLength - 1) / $this->pageLength) : 1;
    }

    function SetGridCount($gridCount)
    {
        $this->gridCount = $gridCount;
    }

    function setPageNumber($num)
    {
        global $state;

        if ( (int) $state->get('pn_page', $this->grid->name) > (int) $this->pageCount )
        {
            $num = $this->pageCount;
        }

        $this->pageNumber = (int)($num ? $num : 1);
        $this->range = new MRange($this->pageNumber, $this->pageLength, $this->rowCount);
        $this->SetIndexes();
    }

    function setCurrentPage( $pageNumber )
    {
        $this->setPageNumber( $pageNumber );
    }

    function SetIndexes()
    {
      $this->range-> __construct($this->pageNumber, $this->pageLength, $this->rowCount);
      $this->idxFirst = $this->range->offset;
      $this->idxLast = $this->range->offset + $this->range->rows - 1;
      $this->SetGridCount($this->range->rows);
    }

    function SetGridParameters($pageLength, $rowCount, $action, $grid)
    {
      global $state;
      $this->pageLength = $pageLength;
      $this->SetRowCount($rowCount);
      $this->action = $action;
      $this->grid = $grid;
      $this->SetIndexes();
      $this->SetPageNumber( $state->get('pn_page', $this->grid->name) );
    }

    function GetRowCount()
    {
        return $this->rowCount;
    }

    function GetGridCount()
    {
        return $this->gridCount;
    }

    function GetPageNumber()
    {
        return $this->pageNumber;
    }

    function getPageCount()
    {
        return $this->pageCount;
    }

    function GetPagePosition($showPage = true)
    {
        $position = '[' . ($showPage ? _M('Page') : '') . ' ' . $this->GetPageNumber() . ' ' . _M('of') . ' '
                        . $this->GetPageCount() . "]";
        return $position;
    }

    function GetPageLinks($showPage = true, $limit = 10)
    {           
        $pageCount = $this->GetPageCount();
        $pageNumber = $this->GetPageNumber();
        $pageLinks = array();

        $p = 0;

        if (!$this->GetRowCount())
        {
            $pageLinks[$p] = new MLabel('&nbsp;&nbsp;&nbsp;');
            $pageLinks[$p++]->SetClass('m-pagenavigator-text');
        }
        else
        {
            if ($showPage)
            {
                $pageLinks[$p] = new MText('', '&nbsp;' . _M('Page') . ':&nbsp;');
                $pageLinks[$p++]->SetClass('m-pagenavigator-text');
            }

            if ($pageNumber <= $limit)
            {
                $o = 1;
            }
            else
            {
                $o = ((int)(($pageNumber - 1) / $limit)) * $limit;
                $pageLinks[$p] = new LinkButton('', '...', $this->getNavigatorUrlWithClass($o++));
                $pageLinks[$p++]->SetClass('m-pagenavigator-link');
            }

            for ($i = 0; ($i < $limit) && ($o <= $pageCount); $i++, $o++)
            {
                $pg = $o;
                if ($o != $pageNumber)
                {
                    $pageLinks[$p] = new LinkButton('', $pg, $this->getNavigatorUrlWithClass($o));
                    $pageLinks[$p]->SetClass('m-pagenavigator-link');
                    $pageLinks[$p++]->SetAttribute('onMouseOver', "top.status='" . _M('Page') . " $pg'");
                }
                else
                {
                    $pageLinks[$p] = new LinkButton('pagenavigator', "$pg", $this->getNavigatorUrl($o));
                    $pageLinks[$p++]->SetClass('m-pagenavigator-selected');
                }
            }

            if ($o < $pageCount)
            {
                $pageLinks[$p++] = new Label('');
                $pageLinks[$p] = new LinkButton('', '...', $this->getNavigatorUrlWithClass($o));
                $pageLinks[$p++]->SetClass('m-pagenavigator-link');
            }
        }

        return $pageLinks;
    }
    
    private function getNavigatorUrl($number)
    {
        $orderby = $this->page->request('orderby');
        
        return $this->action . '&' . PN_PAGE . '=' . $number . '&gridName=' . urlencode($this->grid->name) . '&orderby=' . $orderby;
    }
    
    private function getNavigatorUrlWithClass($number)
    {
        return $this->getNavigatorUrl($number) . '#m_pagenavigator';
    }

    function GetPageRange($subject = '')
    {
        if (!$this->GetRowCount())
        {
            $range = _M('No data.');
        }
        else
        {
            $first = $this->idxFirst + 1;
            $last = $this->idxLast + 1;
            $range = '[' . $first . '..' . $last . '] ' . _M('of') . ' ' . $this->GetRowCount() . $subject;
        }

        return new Span('', $range, 'm-pagenavigator-range');
    }

    function GetPageRows($subject = '')
    {
        $rows = $this->GetGridCount() . '&nbsp;' . $subject;
        return $rows;
    }

    function GetPageFirst()
    {
        $pageNumber = $this->GetPageNumber();
        $attrs = array('border' => '0');
        $btn_first0 = new ImageForm('_gnFirst', 'Primeira', "images/but_pg_primeira.gif", $attrs);
        $btn_first1 = new ImageButton('_gnFirst', 'Primeira', $this->getNavigatorUrlWithClass(1),
                                      "images/but_pg_primeira_x.gif");
        $btn = ($pageNumber > 1 ? $btn_first1 : $btn_first0);
        return new Span('', $btn, 'm-pagenavigator-image');
    }

    function GetPagePrev()
    {
        $pageNumber = $this->GetPageNumber();
        $pagePrev = $pageNumber - 1;
        $attrs = array('border' => '0');
        $btn_prev0 = new ImageForm('_gnPrev', _M('Previous'), "images/but_pg_anterior.gif", $attrs);
        $btn_prev1 = new ImageButton('_gnPrev', _M('Previous'), $this->getNavigatorUrlWithClass($pagePrev),
                                     "images/but_pg_anterior_x.gif");
        $btn = ($pageNumber > 1 ? $btn_prev1 : $btn_prev0);
        return new Span('', $btn, 'm-pagenavigator-image');
    }

    function GetPageNext()
    {
        $pageNumber = $this->GetPageNumber();
        $pageNext = $pageNumber + 1;
        $pageCount = $this->GetPageCount();
        $attrs = array('border' => '0');
        $btn_next0 = new ImageForm('_gnNext', _M('Next'), "images/but_pg_proxima.gif", $attrs);
        $btn_next1 = new ImageButton('_gnNext', _M('Next'), $this->getNavigatorUrlWithClass($pageNext),
                                     "images/but_pg_proxima_x.gif");
        $btn = ($pageNumber < $pageCount ? $btn_next1 : $btn_next0);
        return new Span('', $btn, 'm-pagenavigator-image');
    }

    function GetPageLast()
    {
        $pageNumber = $this->GetPageNumber();
        $pageCount = $this->GetPageCount();
        $attrs = array('border' => '0');
        $btn_last0 = new ImageForm('_gnLast', _M('Last'), "images/but_pg_ultima.gif", $attrs);
        $btn_last1 = new ImageButton('_gnLast', _M('Last'), $this->getNavigatorUrlWithClass($pageCount),
                                     "images/but_pg_ultima_x.gif");
        $btn = ($pageNumber < $pageCount ? $btn_last1 : $btn_last0);
        return new Span('', $btn, 'm-pagenavigator-image');
    }

}
?>
