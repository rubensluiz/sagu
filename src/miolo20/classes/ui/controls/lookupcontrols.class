<?php

class MLookupField1 extends MTextField
{
    var $action;
    var $related;
    var $module;
    var $item;
    var $info;
    var $autocomplete=false;
    var $event;
    var $filter;
    var $baseModule;
    var $lookup_name;
    var $showButton=true;
    private $windowType   = 'popup';
    private $windowWidth  = '';
    private $windowHeight = '';
    private $windowTop    = '';
    private $windowLeft   = '';


    function __construct($name='',$value='',$label='',$hint='', 
                 $related='',$module='',$item='', $event='filler', $filter='')
    {  
        parent::__construct($name,$value,$label,0,$hint);
        $page = $this->page;
        $page->AddScript('m_lookup.js');
        
        if(is_array($related))
        {
            ksort($related);
        }
        else
        {
            $related = array(str_replace(' ','',$related));
        }
        $this->related = implode(',',$related);

        $this->module  = $module;
        $this->item    = $item;
        $this->event   = $event ? $event : 'filler';
        $this->filter  = $filter;
        $module = $this->manager->GetConf("mad.module");  
        
        $page = $this->page;
        $form = ($this->form == NULL) ? $page->name : $this->form->name;
        
        $this->lookup_name = "lookup_{$form}_{$this->name}";
        $this->lookup_name = str_replace('.', '_', $this->lookup_name);
        
        $this->baseModule = ($module) ? $module : "admin";
    }
    
	function GetModuleItem()
    {
        return $this->module . '.' . $this->item;
    }
    
    function SetModuleItem($module, $item)
    {
        $this->module = $module;
        $this->item = $item;
    }

    function setWindowSize( $width, $height )
    {
        $this->windowWidth  = $width;
        $this->windowHeight = $height;
    }

    function setWindowType( $windowType='iframe', $width='', $height='', $top='', $left='')
    {
        $this->windowType   = $windowType;
        $this->windowTop    = $top;
        $this->windowLeft   = $left;
        $this->setWindowSize( $width, $height);
    }
    
    /*
        Method to set if the look button should be displayed
    */
    function setShowButton( $show=true )
    {
        $this->showButton = $show;
    }

   function GenerateInner()
   {
        $this->label = $this->label ? '&nbsp;' : '';
        
        $base = $this->baseModule;

        $filter = is_array($this->filter) ? $this->filter : array($this->filter);
        $lookup_name = $this->lookup_name;
        
        $attr = $this->GetAttributes();

        if ($this->showButton )
        {
            $content[] = new MSpan('','&nbsp;');
            $button = new MButtonFind("javascript:MIOLO_Lookup($this->lookup_name,'$base', event);");
            $content[] = $button->Generate();
        }

        $html =  $this->painter->GenerateToString($content);
        $html .= "<script language=\"JavaScript\">\n";
        $html .= "    var $this->lookup_name     = new LookupContext();\n";
        $html .= "    $lookup_name.name      = '{$lookup_name}';\n";
        $html .= "    $lookup_name.module    = '{$this->module}';\n";
        $html .= "    $lookup_name.item      = '{$this->item}';\n";
        $html .= "    $lookup_name.related   = '{$this->related}';\n";
        $html .= "    $lookup_name.filter    = '" . implode(',',$filter) . "';\n";
        $html .= "    $lookup_name.idxFilter = '" . implode(',',array_keys($filter)) . "';\n";
        $html .= "    $lookup_name.form      = document.{$this->form->name};\n";
        $html .= "    $lookup_name.field     = '{$this->name}';\n";
        $html .= "    $lookup_name.event     = '{$this->event}';\n";
        $html .= "    $lookup_name.wType     = '{$this->windowType}';\n";
        $html .= "    $lookup_name.wWidth    = '{$this->windowWidth}';\n";
        $html .= "    $lookup_name.wHeight   = '{$this->windowHeight}';\n";
        $html .= "    $lookup_name.wTop      = '{$this->windowTop}';\n";
        $html .= "    $lookup_name.wLeft     = '{$this->windowLeft}';\n";
        $html .= "    $lookup_name.autoPost  = '{$this->autoPostBack}';\n";
        $html .= "    document.lookup        = $lookup_name;\n";
        $html .= "</script>\n";
        $this->inner = $this->GenerateLabel() . $html;        
   }
}


//vgartner
class MLookupFieldAjax extends MTextField
{
    var $action;
    var $related;
    var $module;
    var $item;
    var $info;
    var $autocomplete=false;
    var $event;
    var $filter;
    var $baseModule;
    var $lookup_name;
    var $showButton=true;
    private $windowType   = 'popup';
    private $windowWidth  = '';
    private $windowHeight = '';
    private $windowTop    = '';
    private $windowLeft   = '';


    function __construct($name='',$value='',$label='',$hint='',
                 $related='',$module='',$item='', $event='filler', $filter='')
    {
        parent::__construct($name,$value,$label,0,$hint);
        $page = $this->page;
        $page->AddScript('m_lookup_ajax.js');

        if(is_array($related))
        {
            ksort($related);
        }
        else
        {
            $related = array(str_replace(' ','',$related));
        }
        $this->related = implode(',',$related);

        $this->module  = $module;
        $this->item    = $item;
        $this->event   = $event ? $event : 'filler';
        $this->filter  = $filter;
        $module = $this->manager->GetConf("mad.module");

        $page = $this->page;
        $form = ($this->form == NULL) ? $page->name : $this->form->name;
        
        $this->lookup_name = "lookup_{$form}_{$this->name}";
        $this->lookup_name = str_replace('.', '_', $this->lookup_name);
        
        
        $this->baseModule = ($module) ? $module : "admin";
    }

    function GetModuleItem()
    {
        return $this->module . '.' . $this->item;
    }

    function SetModuleItem($module, $item)
    {
        $this->module = $module;
        $this->item = $item;
    }

    function setWindowSize( $width, $height )
    {
        $this->windowWidth  = $width;
        $this->windowHeight = $height;
    }

    function setWindowType( $windowType='iframe', $width='', $height='', $top='', $left='')
    {
        $this->windowType   = $windowType;
        $this->windowTop    = $top;
        $this->windowLeft   = $left;
        $this->setWindowSize( $width, $height);
    }

    /*
        Method to set if the look button should be displayed
    */
    function setShowButton( $show=true )
    {
        $this->showButton = $show;
    }

   function GenerateInner()
   {
        $this->label = $this->label ? '&nbsp;' : '';

        $base = $this->baseModule;

        $filter = is_array($this->filter) ? $this->filter : array($this->filter);
        $lookup_name = $this->lookup_name;

        $attr = $this->GetAttributes();

        if ($this->showButton )
        {
            $content[] = new MSpan('','&nbsp;');
            $button = new MButtonFind("javascript:MIOLO_Lookup($this->lookup_name,'$base', event);");
            $content[] = $button->Generate();
        }

        $html =  $this->painter->GenerateToString($content);
        $html .= "<script language=\"JavaScript\">\n";
        $html .= "    var $this->lookup_name     = new LookupContext();\n";
        $html .= "    $lookup_name.name      = '{$lookup_name}';\n";
        $html .= "    $lookup_name.module    = '{$this->module}';\n";
        $html .= "    $lookup_name.item      = '{$this->item}';\n";
        $html .= "    $lookup_name.related   = '{$this->related}';\n";
        $html .= "    $lookup_name.filter    = '" . implode(',',$filter) . "';\n";
        $html .= "    $lookup_name.idxFilter = '" . implode(',',array_keys($filter)) . "';\n";
        $html .= "    $lookup_name.form      = document.forms[0];\n";
        $html .= "    $lookup_name.field     = '{$this->name}';\n";
        $html .= "    $lookup_name.event     = '{$this->event}';\n";
        $html .= "    $lookup_name.wType     = '{$this->windowType}';\n";
        $html .= "    $lookup_name.wWidth    = '{$this->windowWidth}';\n";
        $html .= "    $lookup_name.wHeight   = '{$this->windowHeight}';\n";
        $html .= "    $lookup_name.wTop      = '{$this->windowTop}';\n";
        $html .= "    $lookup_name.wLeft     = '{$this->windowLeft}';\n";
        $html .= "    $lookup_name.autoPost  = '{$this->autoPostBack}';\n";
        $html .= "    document.lookup        = $lookup_name;\n";
        $html .= "</script>\n";
        $this->inner = $this->GenerateLabel() . $html;
   }
}

class MLookupField extends MLookupFieldAjax
{}

class MLookupTextField1 extends MLookupField
{
    var $autocomplete;
    
    function __construct($name='',$value='',$label='', 
                 $size=10,$hint='',$validator=null,$related='',
	             $module='',$item='', $event='filler', $filter='', $autocomplete=true)
    {   
        parent::__construct($name,$value,$label,$hint,$related, $module, $item, $event, $filter); //$validator);
        $this->size = $size;
        $this->filter = $filter ? $filter : $this->name;
        $this->autocomplete = $autocomplete ? true : false;
        $this->validator = is_string($validator) ? 
                               Validator::MASKValidator($validator) : $validator;
    }

    function getAutocompleteData()
    {
        $autocomplete = new MAutoComplete($this->module,$this->item,$this->value,$this->related);
        $info = $autocomplete->getResult();
        return $info;
    }
    
   function GenerateInner()
   {
      $field = new MTextField($this->name,$this->value,$this->label,$this->size,$this->hint, $this->validator);
      $field->attrs = $this->attrs;
      if ( $this->autocomplete )
      {
        $field->setAttribute('onChange',"MIOLO_AutoComplete({$this->lookup_name},'$this->baseModule')");
      }
      $field->validator = $this->validator;
      $field->form      = $this->form;
      
      if($this->value && $this->autocomplete)
      {
        $MIOLO = $this->manager;
        
        $info = $this->getAutoCompleteData();

        $info_ = '';
        foreach($info as $i )
        {
            $info_ .= "'$i',";
        }
        $info_ = substr($info_, 0, -1);

        if(MUtil::getBooleanValue($MIOLO->getConf('options.debug')) && $MIOLO->getConf('logs.handler') == 'screen')
        {
            $msg = _M('[autocomplete]: Field @1 not found!', $this->baseModule) . '<br/>';
        }
        $this->page->addJSCode("MIOLO_AutoCompleteDeliver(document, {$this->lookup_name}.form, '$msg', '$this->related', new Array($info_) );");
      }
      
      $field->SetClass('m-text-field'); 
      $field->showLabel = $this->showLabel;
      $field->formMode = $this->formMode;
      $field->AddBoxStyle('float','left');
	  if ( $this->readonly )
      {
          $field->SetClass('m-readonly');
          $field->AddAttribute('readonly');
      }
      $html = $field->Generate();
      parent::GenerateInner();
      $htmlInner = $this->GetInner();
      $this->inner = $html . ( $this->readonly  ? '' : $htmlInner) ;        
   }

}

class MLookupFieldValue extends MLookupField
{
	function __construct($name='',$value='',$label='', 
                 $size=10,$hint='',$validator=null,$related='',
	             $module='',$item='', $event='', $filter='', $autocomplete=false)
    {   
        parent::__construct($name,$value,$label,$hint,$validator);
        $this->size = $size;
        $this->filter = $this->name;
        $this->validator = is_string($validator) ? 
                               Validator::MASKValidator($validator) : $validator;
    }
    
   function GenerateInner()
   {
      parent::GenerateInner();
      $htmlInner = $this->GetInner();
      $field = new MTextField($this->name,$this->value,$this->label,$this->size,$this->hint, $this->validator);
      $field->attrs = $this->attrs;
      $field->SetClass('m-text-field'); 
      $field->showLabel = $this->showLabel;
      $field->formMode = $this->formMode;
//      $field->AddBoxStyle('float','left');
      $field->SetClass('m-readonly');
      $field->AddAttribute('readonly');
      $html = $field->Generate();
      $this->inner = ( $this->readonly  ? '' : $htmlInner) . $html;        
   }

}

class MLookupTextFieldAjax extends MLookupFieldAjax
{
    var $autocomplete;

    function __construct($name='',$value='',$label='',
                 $size=10,$hint='',$validator=null,$related='',
                 $module='',$item='', $event='filler', $filter='', $autocomplete=true)
    {
        parent::__construct($name,$value,$label,$hint,$related, $module, $item, $event, $filter); //$validator);
        $this->size = $size;
        $this->filter = $filter ? $filter : $this->name;
        $this->autocomplete = $autocomplete ? true : false;
        $this->validator = is_string($validator) ?
                               Validator::MASKValidator($validator) : $validator;
    }

    function getAutocompleteData()
    {
        $autocomplete = new MAutoComplete($this->module,$this->item,$this->value,$this->related);
        $info = $autocomplete->getResult();
        return $info;
    }

    public function GenerateInner()
    {
        $field = new MTextField($this->name, $this->value, $this->label, $this->size, '', $this->validator);
        $field->attrs = $this->attrs;
        if ( $this->autocomplete )
        {
            $field->setAttribute('onChange', "MIOLO_AutoComplete_Ajax({$this->lookup_name},'$this->baseModule')");
        }
        $field->validator = $this->validator;
        $field->form = $this->form;

        if ( $this->value && $this->autocomplete )
        {
            $MIOLO = $this->manager;

            $info = $this->getAutoCompleteData();

            $info_ = '';

            if ( $info && is_array($info) )
            {
                foreach ( $info as $value )
                {
                    $value = addslashes($value);
                    
                    $info_ .= "'$value',";
                }
            }
            $info_ = substr($info_, 0, -1);

            if ( MUtil::getBooleanValue($MIOLO->getConf('options.debug')) && $MIOLO->getConf('logs.handler') == 'screen' )
            {
                $msg = _M('[autocomplete]: Field @1 not found!', $this->baseModule) . '<br/>';
            }

            // Check if it's an AJAX request
            if ( $this->page->request('cpaint_function') != "" )
            {
                $this->page->addAJAXJsCode("setTimeout(\"MIOLO_AutoCompleteDeliver_Ajax(document, {$this->lookup_name}.form, '$msg', '$this->related', new Array($info_) );\", 0);");
            }
            else
            {
                $this->page->addJSCode("MIOLO_AutoCompleteDeliver_Ajax(document, {$this->lookup_name}.form, '$msg', '$this->related', new Array($info_) );");
            }
        }

        $field->SetClass('m-text-field');
        $field->showLabel = $this->showLabel;
        $field->formMode = $this->formMode;
        $field->AddBoxStyle('float', 'left');
        if ( $this->readonly )
        {
            $field->SetClass('m-readonly');
            $field->AddAttribute('readonly');
        }
        $html = $field->Generate();
        parent::GenerateInner();
        $htmlInner = $this->GetInner();
        $this->inner = $html . $htmlInner;
    }
}

class MLookupTextField extends MLookupTextFieldAjax
{}

class MActiveLookup extends MLookupTextField
{
    var $lheight;
    var $lwidth;
 
	function __construct($name='',$value='',$label='', 
                 $size=10,$hint='',$validator=null,$related='',
	             $module='',$item='', $event='', $filter='', $autocomplete=false)
    {   
        parent::__construct($name,$value,$label,$size,$hint,$validator,$related,$module,$item, $event,$filter,$autocomplete);
        $this->page->AddScript('x/x_core.js');
        $this->page->AddScript('m_lookup_ajax.js');
        $this->page->AddScript('m_popup.js');
    }
    
   function GenerateInner()
   {
        $page = $this->page;
        $this->showLabel = ($this->formMode == 2);
        $span = new Span('',$this->label,MControl::CLASS_CAPTION);
        $label = $this->painter->span($span) . $this->painter->BR;
        $form = ($this->form == NULL) ? $page->name : $this->form->name;
        $lookup_name = "lookup_{$form}_{$this->name}";
        $base = $this->baseModule;
        
        $filter = is_array($this->filter) ? $this->filter : array($this->filter);
        $attr = $this->GetAttributes();
        $content[] = new MSpan('','&nbsp;');
        $item =  $this->item;
        $w = ($this->lwidth != '') ? $this->lwidth : 400;
        $h = ($this->lheight != '') ? $this->lheight : 250;
        $params = array(
           "name" => $lookup_name,
           "lmodule" => $this->module,
           "event" => $this->event,
           "related" => $this->related,
           "lheight" => $this->lheight,
           "lwidth" => $this->lwidth
        );
        foreach($filter as $k=>$f)
        {
           $params["filter$k"] = $f;
        } 
           
        $url = $this->manager->GetActionURL($this->baseModule, 'activelookup', $item, $params);
        $button = new MButtonFind("javascript:MIOLO_ActiveLookup('$lookup_name',200,200,$w,$h, '{$url}','','{$this->name}',1);");
        $content[] = $button->Generate();
        if ( $this->readonly )
        {
            $ro = new MSpan($this->name,$this->value,'m-readonly');
            $this->inner = (($this->showLabel && ($this->label != '')) ? $label : '') . $this->painter->span($ro);
            return;
        }
        $field = new MTextField($this->name,$this->value,$this->label,$this->size,$this->hint, $this->validator);
        $field->attrs = $this->attrs;
        $field->SetClass('m-text-field'); 
        $html = $field->GetRender('inputtext') . $this->painter->GenerateToString($content);
        $this->inner = $html;        
   }
}

?>
