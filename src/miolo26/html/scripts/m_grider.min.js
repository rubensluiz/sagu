!function($){$.fn.extend({grider:function(e){return this.each(function(){new $.Grider(this,e)})}}),$.Grider=function(table,config){function setGrider(e){if($(table).find("tr:first").addClass("noedit"),config.countRow&&config.countRowAdd){var t=$(table).find("th:first").attr("class");t=""!=t?' class="'+t+'"':"",$(table).find("tr.noedit:first").prepend("<th "+t+">"+config.countRowText+"</th>"),$(table).find("tr:not(.noedit)").each(function(e,t){var o=e+1;$(t).prepend("<td>"+o+"</td>")})}for(var o=$(table).find("tr:not(.noedit):first td").length,a=0;o>a;a++)setColumn(e.rows[0].cells[a],a);setColType();for(var a=0;o>a;a++)setFormula(e.rows[0].cells[a]),setSummary(e.rows[0].cells[a]);if(formulaSet&&config.initCalc){var n=$(table).find("tr:not(.noedit)");n.each(function(e){var t=e+1;for(var o in cols)cols[o].formula&&calculateFormula(cols[o].name,t)})}for(var l in cols)cols[l].summary&&calculateSummary(l);config.addRow&&($(table).append(config.addRowText),$(table).find(".addButton").click(function(){addRow()})),config.delRow&&($(table).find("tr:not(.noedit)").each(function(e,t){$(t).append(config.delRowText)}),$(table).find("a.delete").live("click",function(){return delRow(this),!0})),setEvents(),config.addRowWithTab&&addRowWithTab()}function addRowWithTab(){$(table).find("tr:not(.noedit):last a.delete").live("keydown",function(e){9==e.keyCode&&addRow()})}function setColType(){var e=$(table).find("tr:not(.noedit):first")[0];for(var t in cols){var o=$(e).find("td:eq("+cols[t].pos+")")[0],a=$(o).find("select")[0]||$(o).find("input:not(:submit)")[0]||$(o).find("select")[0];try{type=a.nodeName.toLowerCase()}catch(n){type=!1}if(type)switch(type){case"input":cols[t].type="input:"+a.type;break;case"select":cols[t].type="select";break;case"textarea":cols[t].type="textarea";break;default:cols[t].type="input:text"}else cols[t].type=""}}function setColumn(e,t){var o=$(e).attr("col");o&&(cols[o]={pos:t,name:o})}function setSummary(e){var t=$(e).attr("summary"),o=!1,a=$(e).attr("col");if(("sum"==t||"avg"==t||"max"==t||"min"==t||"count"==t)&&(cols[a].summary=t,o=!0),!summaryRow&&o){var n='<tr class="summary noedit">';$(table).find("tr:not(.noedit):first td").each(function(e,t){var o=$(t).attr("style")?' style="'+$(t).attr("style")+'"':"";n+="<td"+o+"></td>"}),n+="</tr>",$(table).append(n),summaryRow=!0}}function calculateSummary(e){var t=cols[e].summary,o=parseInt(cols[e].pos)+1,a=$(table).find("tr:not(.noedit) td:nth-child("+o+")"),n=0,l=0,r=null,c=null;if("count"!=t){var i=0;switch(a.each(function(o,a){switch(i=""==cols[e].type?1*$(a).html():1*$(a).find(cols[e].type).val(),t){case"sum":l+=i;break;case"avg":l+=i;break;case"max":r?i>r&&(r=i):r=i;break;case"min":c?c>i&&(c=i):c=i}}),t){case"sum":n=l;break;case"avg":n=l/a.length;break;case"max":n=r;break;case"min":n=c}}else n=a.length;n=n.toFixed(config.decimals),$(table).find("tr.summary td:nth-child("+o+")").html(n)}function fireCellEvent(e){var t=e.target||e.srcElement;if(1==t.nodeType){var o=$(t).parents("tr")[0].rowIndex,a=$(t).parents("td")[0].cellIndex,n=findColBy(a,"pos");for(var l in cols)if(cols[l].formula)try{var r="\\b"+n.name+"\\b";r=new RegExp(r),r.test(cols[l].formula)&&calculateFormula(l,o)}catch(e){}}}function setFormula(e){formulaSet=!0;var t=$(e).attr("formula"),o=$(e).attr("col");if(t){cols[o].formula=t;for(var a in cols){n="\\b"+a+"\\b";var n=new RegExp(n);n.test(t)&&""!=cols[a].type&&(cols[a].event=!0)}}}function setEvents(){for(k in cols)if(cols[k].event){var e=parseInt(cols[k].pos)+1,t="tr td:nth-child("+e+") "+cols[k].type;"input:text"==cols[k].type||"textarea"==cols[k].type||"select"==cols[k].type?($(table).find(t).unbind("change"),$(table).find(t).change(function(e){fireCellEvent(e)})):"input:checkbox"==cols[k].type&&($(table).find(t).unbind("click"),$(table).find(t).click(function(e){fireCellEvent(e)}))}}function calculateFormula(col,pos){var pat=cols[col].formula.match(/\b[a-z_-]+[0-9]*\b/gi),formu=cols[col].formula,row=$(table).find("tr:eq("+pos+")");for(var k in pat)/^\d+$/.test(k)||delete pat[k];var columns=[];for(var k in pat){try{var exp="td:nth-child("+(cols[pat[k]].pos+1)+") "+cols[pat[k]].type}catch(e){}var val=0;"input:checkbox"==cols[pat[k]].type?val=$(row).find(exp).attr("checked")?1:0:"input:text"==cols[pat[k]].type&&(val=parseFloat($(row).find(exp).val())||0);var reg=new RegExp("\\b"+pat[k]+"\\b");formu=formu.replace(reg,val),columns.push(pat[k])}var res=eval(formu);res=res.toFixed(config.decimals);var cell=$(row).find("td:nth-child("+(cols[col].pos+1)+")");""==cols[col].type?$(cell).html(res):$(cell).find(type).html(res);for(var i=0,l=columns.length;l>i;i++)cols[columns[i]].summary&&calculateSummary(columns[i]);calculateSummary(col)}function findColBy(e,t){for(var o in cols)if(e==cols[o][t])return cols[o]}function addFormPos(){if(config.formPos&&""!=config.formPos)countRows++,config.formPos++;else{var e=$(table).find("tr:not(.noedit):last").find("input, select, textarea")[0]||!1;e.name&&(config.formPos=e.name.replace(/^.*\[([0-9]+)\].*$/gi,"$1")||""),config.addedRow=!0,config.formPos++,countRows++}}function addRow(){var e=$(table).find("tr:not(.noedit):first").clone();if(addFormPos(),$(e).find("input, button, select, textarea, div, table, tr, td, img, a").length>0&&($(e).find("input, button, textarea, select, div, table, tr, td, img, a").each(function(e,t){var o="";if(""!==config.formPos?(o=null==t.name||""==t.name||"undefined"==t.name?t.id:t.name,o=o.replace(/\[[0-9]+\]/i,"["+countRows+"]")):o=null==t.name||""==t.name||"undefined"==t.name?t.id:t.name,$(t).attr("checkbox"==t.type||"radio"==t.type?{name:o,id:o,checked:!1}:{name:o,id:o,value:""}),"dijitReset dijitInputInner"==$(t).attr("class")){o=$(t.parentNode).find("input").eq(1).attr("name"),o=""!==config.formPos?o.replace(/\[[0-9]+\]/i,"["+countRows+"]"):o;var a=new MDateTextBox({id:o},t.parentNode.parentNode);a.valueNode.name=o}$(t)}),$(e).find(".griderStatus").eq(0).val("add"),$(e).find("input:radio, input:checkbox").attr("checked",!1)),cols[k]&&""==cols[k].type&&cols[k].formula&&$(e).find("td:eq("+cols[k].pos+")").html(""),config.countRow){var t=parseInt($(table).find("tr:not(.noedit):last td:eq("+config.countRowCol+")").html())+1;$(e).find("td:eq("+config.countRowCol+")").html(t)}$(table).find("tr:not(.noedit):last").after(e),setEvents();for(var o in cols)cols[o].summary&&calculateSummary(cols[o].name)}function delRow(e){if($(table).find(".mTableRawRow:not(.trRemoved)").length>1){if(config.rails){var t=$(e).parents("tr").eq(0).prev("input:hidden[name$='[id]']");if(t.length>0){addFormPos();var o=$(t).attr("name"),a=$(t).val();n1=o.replace(/^(.*)(\[[0-9]+\])(\[id\])$/,"$1["+countRows+"]$3"),n2=o.replace(/^(.*)(\[[0-9]+\])(\[id\])$/,"$1["+countRows+"][_delete]"),$(t).remove(),$(table).prepend('<span><input type="hidden" name="'+n1+'" value="'+a+'" /><input type="hidden" value="1" name="'+n2+'"</span>')}}if(config.hideDelRow){var n=$(e).parents("tr").eq(0),l=n.find("td .griderStatus").eq(0);"add"==l.val()&&n.remove()}else $(e).parents("tr").eq(0).remove();config.countRow&&rowNumber()}for(var r in cols)cols[r].summary&&calculateSummary(r)}function rowNumber(){var e=parseInt(config.countRowCol)+1;$(table).find("tr:not(.noedit) td:nth-child("+e+")").each(function(e,t){var o=e+1;$(t).html(o)})}countRows=0;var defaults=Grider.defaults,config;if(config)for(var k in defaults)config[k]="boolean"==typeof defaults[k]&&"boolean"==typeof config[k]?config[k]:config[k]||defaults[k];else config=defaults;var cols={},summaryRow=!1,formulaSet=!1;return config=config||{},setGrider(table),{cols:cols,config:config,summaryRow:summaryRow,table:table,formulaSet:formulaSet,calculateFormula:calculateFormula,setGrider:setGrider,setColumn:setColumn,fireCellEvent:fireCellEvent,setColType:setColType,findColBy:findColBy,addRow:addRow,addRowWithTab:addRowWithTab,delRow:delRow,rowNumber:rowNumber}},$.Grider.events=function(){return"nuevo"}}(jQuery),Grider={defaults:{initCalc:!0,addRow:!0,addRowWithTab:!0,delRow:!0,decimals:2,addRowText:'<a class="addButton" href="#" onclick="return false;">Adicionar colunasss</a>',delRowText:'<td><a href="#" onclick="return false;" class="delete">Remover</a></td>',countRow:!1,countRowText:"NÂº",countRowCol:0,countRowAdd:!1,addedRow:!1,rails:!1,hideDelRow:!0}};