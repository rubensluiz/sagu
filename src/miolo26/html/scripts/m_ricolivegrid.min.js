var MRico={Version:"0.1-beta1"};MRico.LiveGridMetaData=Class.create(),MRico.LiveGridMetaData.prototype={initialize:function(t,i,s,e){this.pageSize=t,this.totalRows=i,this.setOptions(e),this.scrollArrowHeight=16,this.columnCount=s},setOptions:function(t){this.options={largeBufferSize:7,nearLimitFactor:.2}.extend(t||{})},getPageSize:function(){return this.pageSize},getTotalRows:function(){return this.totalRows},setTotalRows:function(t){this.totalRows=t},getLargeBufferSize:function(){return parseInt(this.options.largeBufferSize*this.pageSize)},getLimitTolerance:function(){return parseInt(this.getLargeBufferSize()*this.options.nearLimitFactor)}},MRico.LiveGridScroller=Class.create(),MRico.LiveGridScroller.prototype={initialize:function(t,i){this.isIE=navigator.userAgent.toLowerCase().indexOf("msie")>=0,this.liveGrid=t,this.metaData=t.metaData,this.createScrollBar(),this.scrollTimeout=null,this.lastScrollPos=0,this.viewPort=i,this.rows=new Array},isUnPlugged:function(){return null==this.scrollerDiv.onscroll},plugin:function(){this.scrollerDiv.onscroll=this.handleScroll.bindAsEventListener(this)},unplug:function(){this.scrollerDiv.onscroll=null},sizeIEHeaderHack:function(){if(this.isIE){var t=$(this.liveGrid.tableId+"_header");t&&(t.rows[0].cells[0].style.width=t.rows[0].cells[0].offsetWidth+1+"px")}},createScrollBar:function(){var t=this.liveGrid.viewPort.visibleHeight();this.scrollerDiv=document.createElement("div");var i=this.scrollerDiv.style;i.borderRight="1px solid #ababab",i.position="relative",i.left=this.isIE?"-6px":"-3px",i.width="19px",i.height=t+"px",i.overflow="auto",this.heightDiv=document.createElement("div"),this.heightDiv.style.width="1px";parseInt(t*this.metaData.getTotalRows()/this.metaData.getPageSize());this.heightDiv.style.height=parseInt(t*this.metaData.getTotalRows()/this.metaData.getPageSize())+"px",this.scrollerDiv.appendChild(this.heightDiv),this.scrollerDiv.onscroll=this.handleScroll.bindAsEventListener(this);var s=this.liveGrid.table;s.parentNode.parentNode.insertBefore(this.scrollerDiv,s.parentNode.nextSibling)},updateSize:function(){var t=(this.liveGrid.table,this.viewPort.visibleHeight());this.heightDiv.style.height=parseInt(t*this.metaData.getTotalRows()/this.metaData.getPageSize())+"px"},rowToPixel:function(t){return t/this.metaData.getTotalRows()*this.heightDiv.offsetHeight},moveScroll:function(t){this.scrollerDiv.scrollTop=this.rowToPixel(t),this.metaData.options.onscroll&&this.metaData.options.onscroll(this.liveGrid,t)},handleScroll:function(){this.scrollTimeout&&clearTimeout(this.scrollTimeout);var t=parseInt(this.scrollerDiv.scrollTop/this.viewPort.rowHeight);this.liveGrid.requestContentRefresh(t),this.viewPort.scrollTo(this.scrollerDiv.scrollTop),this.metaData.options.onscroll&&this.metaData.options.onscroll(this.liveGrid,t),this.scrollTimeout=setTimeout(this.scrollIdle.bind(this),1200)},scrollIdle:function(){this.metaData.options.onscrollidle&&this.metaData.options.onscrollidle()}},MRico.LiveGridBuffer=Class.create(),MRico.LiveGridBuffer.prototype={initialize:function(t,i){this.startPos=0,this.size=0,this.metaData=t,this.rows=new Array,this.updateInProgress=!1,this.viewPort=i,this.maxBufferSize=2*t.getLargeBufferSize(),this.maxFetchSize=t.getLargeBufferSize(),this.lastOffset=0},getBlankRow:function(){if(!this.blankRow){this.blankRow=new Array;for(var t=0;t<this.metaData.columnCount;t++)this.blankRow[t]="&nbsp;"}return this.blankRow},loadRows:function(t){for(var i=t.ajaxResponse[0].table,s=new Array,e=i[0].tr,o=0;o<e.length;o++)for(var r=s[o]=new Array,n=e[o].td,h=0;h<n.length;h++){var a=n[h],l=!1,c=a.data;r[h]=l?this.convertSpaces(c):c,r[h]||(r[h]="&nbsp;")}return s},update:function(t,i){var s=this.loadRows(t);if(0==this.rows.length)return this.rows=s,this.size=this.rows.length,void(this.startPos=i);if(i>this.startPos){if(this.startPos+this.rows.length<i)this.rows=s,this.startPos=i;else if(this.rows=this.rows.concat(s.slice(0,s.length)),this.rows.length>this.maxBufferSize){var e=this.rows.length;this.rows=this.rows.slice(this.rows.length-this.maxBufferSize,this.rows.length),this.startPos=this.startPos+(e-this.rows.length)}}else i+s.length<this.startPos?this.rows=s:(this.rows=s.slice(0,this.startPos).concat(this.rows),this.rows.length>this.maxBufferSize&&(this.rows=this.rows.slice(0,this.maxBufferSize))),this.startPos=i;this.size=this.rows.length},clear:function(){this.rows=new Array,this.startPos=0,this.size=0},isOverlapping:function(t,i){return t<this.endPos()&&this.startPos<t+i||0==this.endPos()},isInRange:function(t){return t>=this.startPos&&t+this.metaData.getPageSize()<=this.endPos()},isNearingTopLimit:function(t){return t-this.startPos<this.metaData.getLimitTolerance()},endPos:function(){return this.startPos+this.rows.length},isNearingBottomLimit:function(t){return this.endPos()-(t+this.metaData.getPageSize())<this.metaData.getLimitTolerance()},isAtTop:function(){return 0==this.startPos},isAtBottom:function(){return this.endPos()==this.metaData.getTotalRows()},isNearingLimit:function(t){return!this.isAtTop()&&this.isNearingTopLimit(t)||!this.isAtBottom()&&this.isNearingBottomLimit(t)},getFetchSize:function(t){var i=this.getFetchOffset(t),s=0;if(i>=this.startPos){var e=this.maxFetchSize+i;e>this.metaData.totalRows&&(e=this.metaData.totalRows),s=e-i}else{var s=this.startPos-i;s>this.maxFetchSize&&(s=this.maxFetchSize)}return s},getFetchOffset:function(t){var i=t;if(t>this.startPos)i=t>this.endPos()?t:this.endPos();else if(t+this.maxFetchSize>=this.startPos){var i=this.startPos-this.maxFetchSize;0>i&&(i=0)}return this.lastOffset=i,i},getRows:function(t,i){var s=t-this.startPos,e=s+i;e>this.size&&(e=this.size);for(var o=new Array,r=0,n=s;e>n;n++)o[r++]=this.rows[n];return o},convertSpaces:function(t){return t.split(" ").join("&nbsp;")}},MRico.GridViewPort=Class.create(),MRico.GridViewPort.prototype={initialize:function(t,i,s,e,o){this.lastDisplayedStartPos=0,this.div=t.parentNode,this.table=t,this.rowHeight=i,this.div.style.height=this.rowHeight*s+"px",this.div.style.overflow="hidden",this.buffer=e,this.liveGrid=o,this.visibleRows=s+1,this.lastPixelOffset=0,this.startPos=0},populateRow:function(t,i){for(var s=0;s<i.length;s++)t.cells[s].innerHTML=i[s]},bufferChanged:function(){this.refreshContents(parseInt(this.lastPixelOffset/this.rowHeight))},clearRows:function(){if(!this.isBlank){for(var t=0;t<this.visibleRows;t++)this.populateRow(this.table.rows[t],this.buffer.getBlankRow());this.isBlank=!0}},clearContents:function(){this.clearRows(),this.scrollTo(0),this.startPos=0,this.lastStartPos=-1},refreshContents:function(t){if(t!=this.lastRowPos||this.isPartialBlank||this.isBlank){if(t+this.visibleRows<this.buffer.startPos||this.buffer.startPos+this.buffer.size<t||0==this.buffer.size)return void this.clearRows();this.isBlank=!1;for(var i=this.buffer.startPos>t,s=i?this.buffer.startPos:t,e=this.buffer.startPos+this.buffer.size<t+this.visibleRows?this.buffer.startPos+this.buffer.size:t+this.visibleRows,o=e-s,r=this.buffer.getRows(s,o),n=this.visibleRows-o,h=i?0:o,a=i?n:0,l=0;l<r.length;l++)this.populateRow(this.table.rows[l+a],r[l]);for(var l=0;n>l;l++)this.populateRow(this.table.rows[l+h],this.buffer.getBlankRow());this.isPartialBlank=n>0,this.lastRowPos=t}},scrollTo:function(t){this.lastPixelOffset!=t&&(this.refreshContents(parseInt(t/this.rowHeight)),this.div.scrollTop=t%this.rowHeight,this.lastPixelOffset=t)},visibleHeight:function(){return parseInt(this.div.style.height)}},MRico.LiveGridRequest=Class.create(),MRico.LiveGridRequest.prototype={initialize:function(t){this.requestOffset=t}},MRico.LiveGrid=Class.create(),MRico.LiveGrid.prototype={initialize:function(t,i,s,e,o){null==o&&(o={}),this.tableId=t,this.table=$(t);var r=this.table.rows[0].cells.length;this.metaData=new MRico.LiveGridMetaData(i,s,r,o),this.buffer=new MRico.LiveGridBuffer(this.metaData);var n=this.table.rows.length;if(this.viewPort=new MRico.GridViewPort(this.table,this.table.offsetHeight/n,i,this.buffer,this),this.scroller=new MRico.LiveGridScroller(this,this.viewPort),this.additionalParms=o.requestParameters||[],o.sortHandler=this.sortHandler.bind(this),$(t+"_header")&&(this.sort=new MRico.LiveGridSort(t+"_header",o)),this.processingRequest=null,this.unprocessedRequest=null,this.initAjax(e),o.prefetchBuffer||o.prefetchOffset>0){var h=0;o.offset&&(h=o.offset,this.scroller.moveScroll(h),this.viewPort.scrollTo(this.scroller.rowToPixel(h))),o.sortCol&&(this.sortCol=o.sortCol,this.sortDir=o.sortDir),this.requestContentRefresh(h)}},resetContents:function(){this.scroller.moveScroll(0),this.buffer.clear(),this.viewPort.clearContents()},sortHandler:function(t){this.sortCol=t.name,this.sortDir=t.currentSort,this.resetContents(),this.requestContentRefresh(0)},setRequestParams:function(){this.additionalParms=[];for(var t=0;t<arguments.length;t++)this.additionalParms[t]=arguments[t]},setTotalRows:function(t){this.resetContents(),this.metaData.setTotalRows(t),this.scroller.updateSize()},initAjax:function(t){this.cp=new cpaint,this.cp.set_response_type("TEXT"),this.cp.set_transfer_mode("POST"),this.url=t},invokeAjax:function(){},handleTimedOut:function(){this.processingRequest=null,this.processQueuedRequest()},fetchBuffer:function(t){if(!this.buffer.isInRange(t)||this.buffer.isNearingLimit(t)){if(this.processingRequest)return void(this.unprocessedRequest=new MRico.LiveGridRequest(t));var i=this.buffer.getFetchOffset(t);this.processingRequest=new MRico.LiveGridRequest(t),this.processingRequest.bufferOffset=i;var s=this.buffer.getFetchSize(t),e=[];e.push(this.tableId+"_request"),e.push("id="+this.tableId),e.push("page_size="+s),e.push("offset="+i),this.sortCol&&(e.push("sort_col="+this.sortCol),e.push("sort_dir="+this.sortDir));for(var o=0;o<this.additionalParms.length;o++)e.push(this.additionalParms[o]);this.cp.ajaxObject=this,this.cp.set_response_type("OBJECT"),this.cp.call(this.url,"m_ricolivegrid",this.cpaintUpdate,e),this.timeoutHandler=setTimeout(this.handleTimedOut.bind(this),2e4)}},requestContentRefresh:function(t){this.fetchBuffer(t)},cpaintUpdate:function(t,i,s){s.ajaxUpdate(t)},ajaxUpdate:function(t){try{clearTimeout(this.timeoutHandler),this.buffer.update(t,this.processingRequest.bufferOffset),this.viewPort.bufferChanged()}catch(i){alert(i.message)}finally{this.processingRequest=null}this.processQueuedRequest()},processQueuedRequest:function(){null!=this.unprocessedRequest&&(this.requestContentRefresh(this.unprocessedRequest.requestOffset),this.unprocessedRequest=null)}},MRico.LiveGridSort=Class.create(),MRico.LiveGridSort.prototype={initialize:function(t,i){this.headerTableId=t,this.headerTable=$(t),this.setOptions(i),this.applySortBehavior(),this.options.sortCol&&this.setSortUI(this.options.sortCol,this.options.sortDir)},setSortUI:function(t,i){for(var s=this.options.columns,e=0;e<s.length;e++)if(s[e].name==t){this.setColumnSort(e,i);break}},setOptions:function(t){this.options={sortAscendImg:"images/sort_asc.gif",sortDescendImg:"images/sort_desc.gif",imageWidth:9,imageHeight:5,ajaxSortURLParms:[]}.extend(t),(new Image).src=this.options.sortAscendImg,(new Image).src=this.options.sortDescendImg,this.sort=t.sortHandler,this.options.columns=this.options.columns?this.convertToTableColumns(this.options.columns):this.introspectForColumnInfo()},applySortBehavior:function(){for(var t=this.headerTable.rows[0],i=t.cells,s=0;s<i.length;s++)this.addSortBehaviorToColumn(s,i[s])},addSortBehaviorToColumn:function(t,i){this.options.columns[t].isSortable()&&(i.id=this.headerTableId+"_"+t,i.style.cursor="pointer",i.onclick=this.headerCellClicked.bindAsEventListener(this),i.innerHTML=i.innerHTML+'<span id="'+this.headerTableId+"_img_"+t+'">&nbsp;&nbsp;&nbsp;</span>')},headerCellClicked:function(t){var i=t.target?t.target:t.srcElement,s=i.id,e=parseInt(s.substring(s.lastIndexOf("_")+1)),o=this.getSortedColumnIndex();-1!=o?o!=e?(this.removeColumnSort(o),this.setColumnSort(e,MRico.TableColumn.SORT_ASC)):this.toggleColumnSort(o):this.setColumnSort(e,MRico.TableColumn.SORT_ASC),this.options.sortHandler&&this.options.sortHandler(this.options.columns[e])},removeColumnSort:function(t){this.options.columns[t].setUnsorted(),this.setSortImage(t)},setColumnSort:function(t,i){this.options.columns[t].setSorted(i),this.setSortImage(t)},toggleColumnSort:function(t){this.options.columns[t].toggleSort(),this.setSortImage(t)},setSortImage:function(t){var i=this.options.columns[t].getSortDirection(),s=$(this.headerTableId+"_img_"+t);i==MRico.TableColumn.UNSORTED?s.innerHTML="&nbsp;&nbsp;":i==MRico.TableColumn.SORT_ASC?s.innerHTML='&nbsp;&nbsp;<img width="'+this.options.imageWidth+'" height="'+this.options.imageHeight+'" src="'+this.options.sortAscendImg+'"/>':i==MRico.TableColumn.SORT_DESC&&(s.innerHTML='&nbsp;&nbsp;<img width="'+this.options.imageWidth+'" height="'+this.options.imageHeight+'" src="'+this.options.sortDescendImg+'"/>')},getSortedColumnIndex:function(){for(var t=this.options.columns,i=0;i<t.length;i++)if(t[i].isSorted())return i;return-1},introspectForColumnInfo:function(){for(var t=new Array,i=this.headerTable.rows[0],s=i.cells,e=0;e<s.length;e++)t.push(new MRico.TableColumn(this.deriveColumnNameFromCell(s[e],e),!0));return t},convertToTableColumns:function(t){for(var i=new Array,s=0;s<t.length;s++)i.push(new MRico.TableColumn(t[s][0],t[s][1]))},deriveColumnNameFromCell:function(t,i){var s=void 0!=t.innerText?t.innerText:t.textContent;return s?s.toLowerCase().split(" ").join("_"):"col_"+i}},MRico.TableColumn=Class.create(),MRico.TableColumn.UNSORTED=0,MRico.TableColumn.SORT_ASC="ASC",MRico.TableColumn.SORT_DESC="DESC",MRico.TableColumn.prototype={initialize:function(t,i){this.name=t,this.sortable=i,this.currentSort=MRico.TableColumn.UNSORTED},isSortable:function(){return this.sortable},isSorted:function(){return this.currentSort!=MRico.TableColumn.UNSORTED},getSortDirection:function(){return this.currentSort},toggleSort:function(){this.currentSort==MRico.TableColumn.UNSORTED||this.currentSort==MRico.TableColumn.SORT_DESC?this.currentSort=MRico.TableColumn.SORT_ASC:this.currentSort==MRico.TableColumn.SORT_ASC&&(this.currentSort=MRico.TableColumn.SORT_DESC)},setUnsorted:function(){this.setSorted(MRico.TableColumn.UNSORTED)},setSorted:function(t){this.currentSort=t}};