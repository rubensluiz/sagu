<?php

/*********************************************\
 | ide.class                                     |
 | ----------------------------------------------|
 | Daniel Afonso Heisler (daniel@solis.coop.br)  |
 \*********************************************/

class ide {

    var $window_dia2sql;
    var $dialog;
    var $format;
    var $diagram;
    var $directory;

    function ide() {

        // main window_dia2sql
        $this->window_dia2sql   = &new GtkWindow;
        $this->window_dia2sql->connect_object("delete-event", array(&$this,"closeWindow"));
        $this->window_dia2sql->connect_object("key_press_event", array(&$this, "keyPress"));
        $this->window_dia2sql->set_title("dia2sql.php");
        $this->window_dia2sql->set_border_width(0);
        $this->window_dia2sql->set_default_size(227,200);
        $this->window_dia2sql->set_position("center");
        $this->window_dia2sql->set_modal(true);
        $this->window_dia2sql->realize();

        $vbox = &new GtkVBox();
        $this->window_dia2sql->add($vbox);

        // row 1
        $hbox = &new GtkHBox(false);
        $hbox2 = &new GtkHBox();
        $hbox2_1 = &new GtkHBox(false);
        $hbox2_2 = &new GtkHBox(false);
        $btndlg = &new GtkButton("...");
        $btndlg->connect_object("clicked", array(&$this,"newDialog"),"diagram");
        $this->diagram = &new GtkEntry();
        $hbox2->pack_start($hbox2_1, false, false);
        $hbox2->pack_end($hbox2_2, false, false);
        $hbox2_1->add($this->diagram);
        $hbox2_2->add($btndlg);
        $hbox->pack_start($this->createBox($hbox2, 10, "Diagram File:"), false, false, 10);
        $vbox->pack_start($hbox, false, false);

        // row 2
        $a = array( "pgsql" => "PostgreSQL",
                         "mysql" => "MySQL");

        $hbox3 = &new GtkHBox(false);
        $vbox->pack_start($hbox3, false, false);
        $this->format = &new GtkCombo();
        $this->format->set_popdown_strings($a);
        $entry = $this->format->entry;
        $entry->set_editable(false);
        $hbox3->pack_start($this->createBox($this->format, 10, "Database Type:"), false, false, 10);

        // row 3
        $hbox4 = &new GtkHBox(false);
        $hbox5 = &new GtkHBox();
        $hbox5_1 = &new GtkHBox(false);
        $hbox5_2 = &new GtkHBox(false);
        $btndlg = &new GtkButton("...");
        $btndlg->connect_object("clicked", array(&$this, "newDialog"), "directory");
        $this->directory = &new GtkEntry();
        $hbox5->pack_start($hbox5_1, false, false);
        $hbox5->pack_end($hbox5_2, false, false);
        $hbox5_1->add($this->directory);
        $hbox5_2->add($btndlg);
        $hbox4->pack_start($this->createBox($hbox5, 10, "Output Place:"), false, false, 10);
        $vbox->pack_start($hbox4, false, false);

        //row 4
        $hbox6 = &new GtkHBox();
        $hbox7 = &new GtkHBox(false);
        $this->rad1 = &new GtkRadioButton(null, "Every Table");
        $this->rad2 = &new GtkRadioButton($this->rad1,"Just One");
        $hbox6->pack_start($this->rad1, false, false);
        $hbox6->pack_end($this->rad2, false, false);
        $hbox7->pack_start($this->createBox($hbox6, 10, "Output(in Files):"), false, false, 10);
        $vbox->pack_start($hbox7, false, false);

        //row 5
        $hbox8 = &new GtkHBox();
        $hbox9 = &new GtkHBox(false);
        $this->rad3 = &new GtkRadioButton(null, "False");
        $this->rad4 = &new GtkRadioButton($this->rad3,"True");
        $hbox8->pack_start($this->rad3, false, false);
        $hbox8->pack_end($this->rad4, false, false);
        $hbox9->pack_start($this->createBox($hbox8, 10, "Allow sensitive case:"), false, false, 10);
        $vbox->pack_start($hbox9, false, false);

        // row 6
        $hbox10 = &new GtkHBox(true);
        $btnok = &new GtkButton("Generate");
        $hbox10->pack_start($this->createBox($btnok, 10, null ), false, false, 10);
        $vbox->pack_start($hbox10, false, false);
        $btnok->connect_object("clicked", array(&$this, "generate"));

        $this->window_dia2sql->set_focus($this->diagram);

    }

    function generate() {

        $file      = $this->diagram->get_text();
        $directory = $this->directory->get_text();
        $entry     = $this->format->entry;
        $rad       = $this->rad1;
        $many      = $rad->get_active();
        $rad3      = $this->rad3;
        $lower     = $rad3->get_active();
        $format    = $entry->get_text();
        $format    = ( $format == "PostgreSQL" ) ? "pgsql" : "mysql";
        include_once("dia2sql.php");
        $this->closeWindow();

    }

    function newDialog($entry) {

        $this->dialog = &new GtkFileSelection();

        if ( $entry == "diagram" ) {
            $this->dialog->complete("*.dia");
            $this->dialog->set_filename("./*.dia");
        } else {
            $this->dialog->complete("*");
            $this->dialog->set_filename("");
        }

        $this->dialog->set_modal(true);
        //$this->dialog->hide_fileop_buttons();
        $this->dialog->show();

        $ok = $this->dialog->ok_button;
        $ok->connect_object("clicked", array(&$this,"dialogOk"), $entry);
        $cancel = $this->dialog->cancel_button;
        $cancel->connect_object("clicked", array(&$this,"dialogCancel"),"65307", $entry);
        $this->dialog->connect_object("key_press_event", array(&$this,"dialogCancel"), $entry);

    }

    function dialogCancel($key, $entry) {

        $nhide = 65307;
        if ( $key == $nhide || $key->keyval == $nhide ) {
            $this->dialog->hide();
            $this->window_dia2sql->set_focus($this->$entry);
        }

    }

    function dialogOk($entry) {

        $this->$entry->set_text($this->dialog->get_filename());
        $this->dialog->hide();
        $this->window_dia2sql->set_focus($this->$entry);

    }

    function keyPress($key) {

        if ( $key->keyval == 65307 )
        $this->closeWindow();

    }

    function closeWindow() {

        //Gtk::main_quit();
        $this->window_dia2sql->hide();

    }

    function createBox(&$field, $max_lenght, $title) {

        $box = &new GtkHButtonBox();
        $box->set_border_width(5);
        $box->set_layout(GTK_BUTTONBOX_SPREAD);
        $box->set_spacing(2);
        $box->pack_start($field, false, false);

        $frame = &new GtkFrame();
        if ( $title )
        $frame->set_label($title);
        $frame->add($box);

        return $frame;

    }

}

?>
